<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="images/logo.png">
<title>病例</title>
<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />
<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
<link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">
<link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
<link href="css/style.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="js/jquery.datatables/bootstrap-adapter/css/datatables.css" />
<script type="text/javascript" src="js/sortListTool.js"></script>
<style>
.accordion .panel,.accordion .panel:first-child {
	border-top: 1px solid #ECECEC;
	border-bottom: 1px solid #ECECEC;
}

.checkbox-inline {
	padding-left: 0;
	padding-right: 30px;
}

.checkbox-inline+.checkbox-inline {
	margin-left: 0;
}

.whitebg td {
	background: #fff;
}

.whitebg td textarea {
	width: 100%;
	height: 100%;
	border: 0;
	resize: vertical
}

.whitebg .fa-minus {
	color: #df4b33;
	cursor: pointer
}

.mytable .fa-plus {
	color: #4cae4c;
	cursor: pointer
}

#olderPhysiological .myheader {
	background: #4D90FD;
	color: #fff;
	overflow: hidden;
	margin-bottom: 15px
}

#olderPhysiological .myheader button {
	background: transparent;
	color: #fff;
	float: right;
	border-color: #fff
}

#olderPhysiological .myheader i {
	margin-left: 5px;
	margin-right: 20px
}

#olderPhysiological .myrow div {
	text-indent: 15px
}

#olderPhysiological .panel-heading {
	border: 1px solid #ccc
}

#olderPhysiological .panel-heading a {
	padding: 10px 16px
}

#olderPhysiological .panel-default {
	margin-top: 15px;
	margin-bottom: 40px
}

#olderPhysiological #piliang .form-group {
	margin-bottom: 10px
}

#olderPhysiological .panel-body {
	padding-left: 0;
	padding-right: 0
}

#olderPhysiological .modal-body>div {
	font-size: 13px
}

#olderPhysiological .block {
	box-shadow: none
}

.hideAndShow {
	display: none;
}

.hideul {
	position: absolute;
	top: 33px;
	z-index: 200;
	left: 0;
	right: 0;
	display: none
}

.hideul ul {
	border: 1px solid #ccc;
	width: 100%;
	background: rgb(207, 234, 243);
	padding-left: 0
}

.hideul ul li {
	list-style-type: none;
	text-indent: 20px
}

.hideul ul li:hover {
	background: #ddd
}

.no-bg-border {
	background-color: #fff;
	border: none
}
</style>
</head>

<body>
	<div id="cl-wrapper" style="padding-top:0;background:#fff;">
		<input type="hidden" value="" id="sortType">
		<input type="hidden" value="" id="sortColumn">
		<div class="cl-mcont" style="background:#fff;">
			<div class="row">
				<div class="col-sm-12">
					<div id="medicalRecord">
						<!-- 病历 -->
						<div class="content">
							<div class="table-responsive">
								<div class="dataTables_wrapper form-inline">
									<!-- 查询框开始 -->
									<div class="row">
										<div class="col-sm-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>评定人</label>
										</div>
										<div class="col-sm-10" style="margin-bottom:10px;">
											<input class="form-control" type="text" id="bl_input_pdr" style="width:100%;">
										</div>
										<div class="col-sm-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>评定日期</label>
										</div>
										<div class="col-sm-5" style="margin-bottom:10px;">
											<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
												<span class="input-group-addon btn btn-primary">
													<span class="glyphicon glyphicon-th"></span>
												</span>
												<input class="form-control" size="16" value="" readonly="" type="text" id="bl_input_pdsjstart" placeholder="开始时间">
												<span class="input-group-btn">
													<button class="btn btn-danger deleteThisTime" type="button">
														<span class="fa fa-times"></span>
													</button>
												</span>
											</div>
										</div>
										<div class="col-sm-5 " style="margin-bottom:10px;">
											<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
												<span class="input-group-addon btn btn-primary">
													<span class="glyphicon glyphicon-th"></span>
												</span>
												<input class="form-control" size="16" value="" readonly="" type="text" id="bl_input_pdsjend" placeholder="结束时间">
												<span class="input-group-btn">
													<button class="btn btn-danger deleteThisTime" type="button">
														<span class="fa fa-times"></span>
													</button>
												</span>
											</div>
										</div>
										<div class="col-sm-2  " style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>首次接受康复时间</label>
										</div>
										<div class="col-sm-5 " style="margin-bottom:10px;">
											<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
												<span class="input-group-addon btn btn-primary">
													<span class="glyphicon glyphicon-th"></span>
												</span>
												<input class="form-control" size="16" value="" readonly="" type="text" id="bl_input_sckfstart" placeholder="开始时间">
												<span class="input-group-btn">
													<button class="btn btn-danger deleteThisTime" type="button">
														<span class="fa fa-times"></span>
													</button>
												</span>
											</div>
										</div>
										<div class="col-sm-5  " style="margin-bottom:10px;">
											<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
												<span class="input-group-addon btn btn-primary">
													<span class="glyphicon glyphicon-th"></span>
												</span>
												<input class="form-control" size="16" value="" readonly="" type="text" id="bl_input_sckfend" placeholder="结束时间">
												<span class="input-group-btn">
													<button class="btn btn-danger deleteThisTime" type="button">
														<span class="fa fa-times"></span>
													</button>
												</span>
											</div>
										</div>
										<!-- 查询框结束 -->
										<!-- 操作按钮开始 -->
										<div class="col-sm-12" style="margin-top:20px">
											<c:if test="${older_queryCase_btn_control != 'yes' or older_queryCase_btn_show == 'yes'}">
												<button class="btn btn-primary" style="margin-bottom: 0px !important; height: 34px;margin-left:0;" onclick="query()">查询</button>
											</c:if>
											<c:if test="${older_delCase_btn_control != 'yes' or older_delCase_btn_show == 'yes'}">
												<button type="button" class="btn btn-danger btn-flat" style="float: right; margin-right: 0px;" onclick="doDel()">
													<span>
														<i class="fa fa-trash-o" style="margin-right:5px;"></i>删除
													</span>
												</button>
											</c:if>
											<c:if test="${older_addCase_btn_control != 'yes' or older_addCase_btn_show == 'yes'}">
												<button type="button" class="btn btn-primary btn-flat md-trigger" style="float: right;" data-modal="addMedicalRecord" onclick="xinzengBL()">
													<span>
														<i class="fa fa-plus" style="margin-right:5px;"></i>新增病历
													</span>
												</button>
											</c:if>
											<button type="button" class="btn btn-primary btn-flat md-trigger" style="float: right;display:none;" data-modal="addMedicalRecord" id="bingli_bianji"></button>
										</div>
										<!-- 操作按钮结束 -->
										<!-- 数据表格开始 -->
										<div class="col-sm-12">
											<table class="table table-bordered dataTable hover" id="datatable" aria-describedby="datatable_info">
												<thead>
													<tr role="row">
														<th style="width:2%;">
															<input id="allselectchecker" type="checkbox" class="col_selector" onclick="selectAll();">
														</th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'assessmentTime')">
															<strong>评定日期</strong>
														</th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'chinese_assessmentPerson')">
															<strong>评定人</strong>
														</th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'recoveryTime')">
															<strong>首次接受康复时间</strong>
														</th>
														<th>
															<strong>摘要</strong>
														</th>
														<th>
															<strong>操作</strong>
														</th>
													</tr>
												</thead>
												<tbody id="datacontainer" role="alert" aria-live="polite" aria-relevant="all">
												</tbody>
												<!-- <tbody id="" >		
													<tr>
				                                    <td><input type="checkbox" class="col_selector"></td>
				                                    
				                                    <td>2015-05-25</td>
				                                    <td>医师王</td>
				                                    <td>2015-12-06</td>
				                                    <td>这里摘要。。。。</td>
				                                    <td>
				                                      <div class="btn-group">
				                                        <button class="btn btn-default btn-xs" type="button">操作</button>
				                                        <button data-toggle="dropdown" class="btn btn-xs btn-primary dropdown-toggle" type="button">
				                                          <span class="caret"></span><span class="sr-only">Toggle Dropdown</span>
				                                        </button>
				                                        <ul role="menu" class="dropdown-menu pull-right">
				                                          <li><a href="###" class="md-trigger" data-modal="addMedicalRecord">编辑既往史</a></li>
				                                          <li><a href="###" class="md-trigger" data-modal="">删除病历</a></li>
				                                        </ul>
				                                      </div>
				                                    </td>
				                                  </tr>																														
												</tbody> -->
											</table>
										</div>
									</div>
									<!-- 数据表格结束 -->
									<!-- 数据条数提示开始 -->
									<div class="row" style="margin-top:0">
										<div class="col-sm-12">
											<div class="pull-left">
												<div id="datatable_info" class="dataTables_info">当前显示0 条总记录中的第0-0条</div>
											</div>
											<div class="clearfix"></div>
										</div>
									</div>
									<!-- 数据条数提示结束 -->
									<!-- 分页条开始 -->
									<div class="row">
										<div class="col-sm-4">
											<div class="dataTables_length" id="datatable2_length">
												<span style="margin-top:18px;">
													每页
													<select id="pageSizeSelector" aria-controls="datatable2" size="1" name="datatable2_length" onchange="query()">
														<option selected="selected" value="10">10</option>
														<option value="25">25</option>
														<option value="50">50</option>
														<option value="100">100</option>
													</select>
													条
												</span>
											</div>
										</div>
										<div class="col-sm-8">
											<div class="pull-right">
												<div class="dataTables_paginate paging_bs_normal">
													<ul id="paginationArea" class="pagination">
														<li class="prev disabled">
															<a href="#">
																<span class="fa fa-angle-left"></span>
																&nbsp;上一页
															</a>
														</li>
														<li class="active">
															<a href="#">1</a>
														</li>
														<li class="next">
															<a href="#">
																下一页&nbsp;
																<span class="fa fa-angle-right"></span>
															</a>
														</li>
													</ul>
												</div>
											</div>
										</div>
										<!-- 分页条结束 -->
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 主页面结束 -->
	<div id="getHeight"></div>

	<!-- 模态框开始-->
	<!-- 病历页签中。新增病例，编辑病历-->
	<div class="md-modal colored-header md-effect-9" style="width:80%;max-width:80%" id="addMedicalRecord">
		<div class="md-content">
			<div class="modal-header">
				<h4 style="display:inline;">病历新增或编辑</h4>
				<button type="button" class="close md-close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<input type="hidden" id="bl_blid" value="">
			</div>
			<div class="modal-body form">
				<table class=" table-bordered  mytable">
					<thead>
						<tr>
							<th colspan="2" style="border-right:0;">
								评定日期：
								<input class="datetime form-control" style="width:80%" size="10" type="text" value="" id="tc_pdrq" data-min-view="2" readonly="readonly" data-date-format="yyyy-mm-dd" placeholder="格式：YYYY-MM-DD" />
							</th>
							<th style="border-left:0;border-right:0">
								评定人：
								<div style="position:relative;width:80%">
									<div class="input-group" style="margin-bottom:0">
										<input class="form-control" type="text" id="blpgr_search" onclick="getPGR()" oninput="getPGR()" onmouseout="javascript:$('#hideul-1').hide();" onmouseover="javascript:$('#hideul-1').show();">
										<span class="input-group-btn">
											<button class="btn btn-primary " type="button">
												<span class="fa fa-search"></span>
											</button>
										</span>
									</div>
									<div class="hideul" id="hideul-1" onmouseover="javascript:$('#hideul-1').show();" onmouseout="javascript:$('#hideul-1').hide();">
										<ul id="hideul_nei">
											<!-- <li>张1（1121）</li>
												<li>张3（1121）</li>
												<li>张4（1311）</li>
												<li>张5（1311）</li> -->
										</ul>
									</div>
								</div>
							</th>
							<th colspan="2" style="border-left:0;">
								首次接受康复时间：
								<input class="datetime form-control" style="width:80%" size="10" type="text" value="" id="tc_scjskfsj" data-min-view="2" readonly="readonly" data-date-format="yyyy-mm-dd" placeholder="格式：YYYY-MM-DD" />
							</th>
						</tr>
						<tr>
							<th>
								<strong>疾病</strong>
							</th>
							<th>
								<strong>病程</strong>
							</th>
							<th>
								<strong>目前主要治疗</strong>
							</th>
							<th>
								<strong>疾病控制情况</strong>
							</th>
							<th style="text-align:center">
								<span onclick="addNewDisease()">
									<i class="fa fa-plus"></i>
								</span>
							</th>
						</tr>
					</thead>
					<tbody id="tbodyhtml">
						<tr class="whitebg">
							<td style="width:12%">
								<textarea></textarea>
							</td>
							<td style="width:12%">
								<textarea></textarea>
							</td>
							<td style="width:35%;max-width:35%">
								<textarea></textarea>
							</td>
							<td style="width:35%;max-width:35%">
								<textarea></textarea>
							</td>
							<td style="text-align:center">
								<span onclick="$(this).parent().parent().remove();">
									<i class="fa fa-minus"></i>
								</span>
							</td>
						</tr>
						<tr class="whitebg" id="qitashuoming">
							<td style="width:12%">
								<strong>其他说明</strong>
							</td>
							<td colspan="4">
								<textarea id="tc_qitasm"></textarea>
							</td>
						</tr>
						<tr class="whitebg">
							<td style="width:12%">
								<strong>摘要</strong>
							</td>
							<td colspan="4">
								<textarea id="tc_jzhaiyao"></textarea>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="modal-footer" style="padding-top:0;border:0">
				<button type="button" class="btn btn-primary btn-flat" onclick="save_bl()">保存</button>
				<button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal" id="close_bltc">取消</button>
			</div>
		</div>
	</div>

	<div class="md-overlay"></div>

	<script type="text/javascript" src="js/mordo.tools/mordo.timeProcessing.js"></script>
	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
	<script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>
	<script type="text/javascript" src="js/masonry.js"></script>
	<script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>
	<script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
	<script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>
	<script type="text/javascript" src="js/highcharts.js"></script>

	<script type="text/javascript">
	//根据排序规则重新查询
	function queryBySort(par,column){
		var classFlag = listSortClickEvent(par);
		var type = judgmentChinese(column);
		if(type != null && type != ""){
			classFlag = type + classFlag;
			column = column.substr(8,column.length);
		}
		$("#sortType").val(classFlag);
		$("#sortColumn").val(column);
		go2page(currentshownpage);
	}

    function addNewDisease(){ //病历，新增一个疾病填写条 tag="whitebg"
    	var tbodyhtml = '<tr class=\"whitebg\" ><td style=\"width:12%\"><textarea ></textarea></td><td style=\"width:12%\"><textarea ></textarea></td><td style=\"width:35%;max-width:35%\"><textarea ></textarea></td><td style=\"width:35%;max-width:35%\"><textarea ></textarea></td><td style=\"text-align:center\"><span onclick=\"$(this).parent().parent().remove();\"><i class=\"fa fa-minus\" ></i></span></td></tr>';
    	$(tbodyhtml).insertBefore("#qitashuoming"); //在其他说明前插入空的一行
    }
	
    $(document).ready(function(){
        query();
    	$(".deleteThisTime").click(function(){               //清除日期框中的值
    	       $(this).parent().prev()[0].value = "";
    	    });
        App.init();
		$('div[class="icheckbox_square-blue checkbox checked disabled"]').removeClass("disabled");//美化checkbox框
   });
	  
   //转化日期
   function riqiChange(data){
  	  var date_=data;
   	  var date2=data.substr(0,4)+"-"+data.substr(4,2)+"-"+data.substr(6,2);
   	  if(date2 == "--"){
   	     date2 = "无";
   	  }
   	  return date2;
   }
  
	///病例开始////////////////////////////////////////////////
	var currentshownpage = 1;
	function selectAll() {
		if ($("#allselectchecker").is(':checked')) {
			$(".col_selector").prop("checked", true);
		} else {
			$(".col_selector").prop("checked", false);
		}
	}
	
	function query() {
		go2page(1);
	}
	
	function go2page(pagenumber){
		var pagesize = $("#pageSizeSelector option:selected").val();
		var bl_input_pdr = $("#bl_input_pdr").val();
		
		var bl_input_pdsjstart = $("#bl_input_pdsjstart").val();
		var bl_input_pdsjend = $("#bl_input_pdsjend").val();
		var bl_input_sckfstart = $("#bl_input_sckfstart").val();
		var bl_input_sckfend = $("#bl_input_sckfend").val();
		if(bl_input_pdsjstart !="" && bl_input_pdsjend !="" && bl_input_pdsjstart > bl_input_pdsjend){
			alert("评定日期开始时间不能大于结束时间");
			return;
		}
		if(bl_input_sckfstart !="" && bl_input_sckfend !="" && bl_input_sckfstart > bl_input_sckfend){
			alert("首次接受康复开始时间不能大于结束时间");
			return;
		}
		
		var reqmsg="{'action':'QUERY_CASE_RECORD_LIST_REQUEST',";
		
		var sortType = $("#sortType").val();
		var sortColumn = $("#sortColumn").val();
		if(sortType != null && sortType != ""){
			reqmsg += "'order':[{'column':'" + sortColumn + "','type':'" + sortType + "'}],";
		}
		
		reqmsg += "'page':{'pageno':'" + pagenumber + "','pagesize':'" + pagesize + "'},'content':{";
		var olderId="<%=request.getAttribute("olderId")%>";
		if (olderId != null && olderId != "") {
			reqmsg += "\"olderId\":" + olderId + ",";
		}
		if (bl_input_pdr != null && bl_input_pdr != "") {
			reqmsg += "\"assessmentPerson\":\"" + bl_input_pdr + "\",";
		}
		if (bl_input_pdsjstart != null && bl_input_pdsjstart != "") {
			reqmsg += "\"assessmentTime_ge\":\"" + bl_input_pdsjstart.substring(0, 4) + bl_input_pdsjstart.substring(5, 7) + bl_input_pdsjstart.substring(8, 10) + "000000" + "\",";
		}
		if (bl_input_pdsjend != null && bl_input_pdsjend != "") {
			reqmsg += "\"assessmentTime_le\":\"" + bl_input_pdsjend.substring(0, 4) + bl_input_pdsjend.substring(5, 7) + bl_input_pdsjend.substring(8, 10) + "000000" + "\",";
		}
		if (bl_input_sckfstart != null && bl_input_sckfstart != "") {
			reqmsg += "\"recoveryTime_ge\":\"" + bl_input_sckfstart.substring(0, 4) + bl_input_sckfstart.substring(5, 7) + bl_input_sckfstart.substring(8, 10) + "000000" + "\",";
		}
		if (bl_input_sckfend != null && bl_input_sckfend != "") {
			reqmsg += "\"recoveryTime_le\":\"" + bl_input_sckfend.substring(0, 4) + bl_input_sckfend.substring(5, 7) + bl_input_sckfend.substring(8, 10) + "000000" + "\",";
		}
		
		reqmsg += "}}";
	
	    jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "caseRecord.do?handler",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	            	  changeData(data);
	              }else if(data.des=="failure"){
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}
	function changeData(data){
		var htmlcode = "";
		if (data.content != null) {
			jQuery.each(data.content.caseRecordList, function(i, item) {
				htmlcode += "<tr class=\"gradeA odd\"><td><input type=\"checkbox\" value=\"" + item.id + "\" class=\"col_selector\"></td>";		
			    htmlcode += "<td>" + formateTime2(item.assessmentTime) + "</td>";	
			    htmlcode += "<td>" + item.assessmentPerson + "</td>";
			    htmlcode += "<td>" + formateTime2(item.recoveryTime) + "</td>";	
			    if(item.des != null && item.des != ""){
			    	if(item.des.length > 30){
			    		htmlcode += "<td>" + item.des.substr(0,30) + "..." + "</td>";
			    	}else{
			    		htmlcode += "<td>" + item.des + "</td>";
			    	}
			    }else{
			    	htmlcode += "<td></td>";
			    }
				
				htmlcode += "<td><div class=\"btn-group\">";
				htmlcode += "<button class=\"btn btn-default btn-xs\" type=\"button\">操作</button>";
				htmlcode += "<button data-toggle=\"dropdown\" class=\"btn btn-xs btn-primary dropdown-toggle\" type=\"button\">";
				htmlcode += "<span class=\"caret\" style=\"padding:0;\"></span>";
				htmlcode += "<span class=\"sr-only\">Toggle Dropdown</span>";
				htmlcode += "</button>";
				htmlcode += "<ul role=\"menu\" class=\"dropdown-menu pull-right\">";
				<c:if test="${older_queryCaseXQ_opt_control != 'yes' or older_queryCaseXQ_opt_show == 'yes'}">
				htmlcode += "<li onclick=\"bianjiBL('" + item.id + "')\"><a href=\"###\">查看详情</a></li>";
				</c:if>	
				<c:if test="${older_addasMB_opt_control != 'yes' or older_addasMB_opt_show == 'yes'}">
				htmlcode += "<li onclick=\"addMB('" + item.id + "')\"><a href=\"###\">作为模板新增</a></li>";
				</c:if>	
				<c:if test="${older_delCase_opt_control != 'yes' or older_delCase_opt_show == 'yes'}">
				htmlcode += "<li onclick=\"del2('" + item.id + "')\"><a href=\"###\">删除</a></li>";
				</c:if>	
				htmlcode += "</ul>";
				htmlcode += "</div></td>";		
				htmlcode += "</tr>";
			});
		}
		$("#datacontainer").html(htmlcode);
		if (data.page != null) {
			genaratePaginateHtml(data.page.pageno, data.page.pageCount);
			genarateRecordNumberHtml(data.page.pageno, data.page.pagesize, data.page.recordCount);
		} else {
			genaratePaginateHtml(1, 1);
			genarateRecordNumberHtml(1, 10, 0);
		}
		reset();
	}

	/**
	 * 生成记录数信息
	 * @method genarateRecordNumberHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} pagesize 每页记录条目数
	 * @param {Number} totalRecord 总记录数
	 */
	function genarateRecordNumberHtml(currentpage, pagesize, totalRecord) {
		var recordInfos = "";
		if (totalRecord > 0) {
		    recordInfos = "当前显示" + totalRecord + "条总记录";
			recordInfos += "中第" + ((currentpage - 1) * pagesize + 1) + "-";
			if (currentpage * pagesize > totalRecord) {
				recordInfos += totalRecord;
			} else {
				recordInfos += currentpage * pagesize;
			}
			recordInfos += "条 ";
		} else {
			recordInfos = "当前显示0 条总记录中的第0-0条";
		}
		
		$("#datatable_info").html(recordInfos);
	}
	
	/**
	 * 生成分页信息
	 * @method genaratePaginateHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} totalpage 总页数
	 */
	function genaratePaginateHtml(currentpage, totalpage, pagesize) {
		currentshownpage = currentpage;
	
		var htmlcode = "";
		
		//上一页
		if (currentpage > 1) {
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		} else {
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		}
		
		//具体页码
		if (totalpage <= 5) {
			for (var i = 1; i <= totalpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		} else {
			var startpage = currentpage;
			var endpage = currentpage;
			while (true) {
				if (endpage - startpage >= 4) {
					break;
				} else {
					if (startpage > 1) {
						startpage = startpage - 1;
					}
					if (endpage < totalpage) {
						endpage = endpage - (-1);
					}
				}
			}
			
			for (var i = startpage; i <= endpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		}
		
		//下一页
		if (totalpage > currentpage) {
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		} else {
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		}
		$("#paginationArea").html(htmlcode);
	}
	
	function doDel() {
		var selectedItemNumber = $("tbody .col_selector:checked").length;
		if (selectedItemNumber >= 1) {
			var ids2del = "";
			$("tbody .col_selector:checked").each(function() {
				ids2del += $(this).val() + ",";
			});
			if (ids2del != "") {
				ids2del = ids2del.substring(0, ids2del.length - 1);
			}
		  if (confirm("是否确认删除?"))  {  
			jQuery.ajax({
				type:"post",
				url:"caseRecord.do?del",
				async:true,
				dataType:"json",
				data:{ids:ids2del},
				success:function(data) {
					alert(data.des);
					if (data.result == "success") {
						go2page(currentshownpage);
					}else if(data.des=="failure"){
	                 alert("删除失败");
	                }
				},
				error:function() {
					alert("error");
				}
			});
			}
		} else {
			alert("请选择要删除的数据");
		}
	}
	
	function del2(id) {
		  if (confirm("是否确认删除?"))  {  
			jQuery.ajax({
				type:"post",
				url:"caseRecord.do?del",
				async:true,
				dataType:"json",
				data:{ids:id},
				success:function(data) {
					alert(data.des);
					if (data.result == "success") {
						go2page(currentshownpage);
					}else if(data.des=="failure"){
	                 alert("删除失败");
	                }
				},
				error:function() {
					alert("error");
				}
			});
		}
	}
	
	//实时获取评估人
	function getPGR(){
		var reqmsg="{'action':'QUERY_EMPLOYEE_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
		var name = $("#blpgr_search").val();
		if (name != null && name != "") {
			reqmsg += "\"name_like\":\"" + name + "\"";
		}else{
			$("#hideul_nei").html("");
			$("#hideul-1").hide();
			return;
		}
		reqmsg += "}}";
	
	    jQuery.ajax({
	          type : "post",
	          async:false,
	          url : "employee.do?handler",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	              	  var htmlcode = "";
	              	  if(data.content != null){
	              	  	 if(data.content.employeeList != null){
	            	  		jQuery.each(data.content.employeeList, function(i, item) {
	            	  				if(item != null){
			    						htmlcode += "<li onclick=\"FZ_bl_pgr('" + item.name + "')\">" + item.name + "</li>";		
	            	  				}	
			    	  		});
			    	 	 }
			    	  }
			    	  $("#hideul_nei").html(htmlcode);
			    	  $("#hideul-1").show();
	              }else if(data.des=="failure"){
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}
	//评估人赋值
	function FZ_bl_pgr(name){
		$("#blpgr_search").val(name);
		$("#hideul_nei").html("");
		$("#hideul-1").hide();
	}

	//获取当前登陆员工姓名
	function getLoginName(){
    	  var userId_login = "<%=request.getAttribute("userId")%>";
		  var reqmsg="{'action':'QUERY_EMPLOYEE_LIST_REQUEST','page':{'pageno':'1','pagesize':'1'},'content':{\"userId\":"+userId_login+"}}";
		  var name="";
		  jQuery.ajax({
          type : "post",
          async:false,
          url : "employee.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if (data.content != null) {
            	  	if(data.content.employeeList != null && data.content.employeeList.length == 1){
            	  	   name = data.content.employeeList[0].name;
            	  	}
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     	  });
     	  return name;
	}
	//获取当前时间return yyyy-mm-dd
	function getNowFormatDate() {
	    var date = new Date();
	    var month = date.getMonth() + 1;
	    var strDate = date.getDate();
	    if (month >= 1 && month <= 9) {
	        month = "0" + month;
	    }
	    if (strDate >= 0 && strDate <= 9) {
	        strDate = "0" + strDate;
	    }
	    var currentdate = date.getFullYear() + "-" + month + "-" + strDate;
	    return currentdate;
	}
	//新增病例
	function xinzengBL(){
		$("#bl_blid").val("");
		$("#tc_pdrq").val(getNowFormatDate());
		$("#blpgr_search").val(getLoginName());
		//$("#tc_scjskfsj").val(getNowFormatDate());
		var html = "";
		html += "<tr class=\"whitebg\" >";
		html += "<td style=\"width:12%\"><textarea ></textarea></td>";
		html += "<td style=\"width:12%\"><textarea ></textarea></td>";
        html += "<td style=\"width:35%;max-width:35%\"><textarea ></textarea></td>";                      
        html += "<td style=\"width:35%;max-width:35%\"><textarea ></textarea></td>";               
        html += "<td style=\"text-align:center\"><span onclick=\"$(this).parent().parent().remove();\"><i class=\"fa fa-minus\" ></i></span></td>";                                                           
        html += "</tr>";
        html += "<tr class=\"whitebg\" id=\"qitashuoming\">";
        html += "<td style=\"width:12%\"><strong>其他说明</strong></td>";
        html += "<td  colspan=\"4\"><textarea id=\"tc_qitasm\"></textarea></td>";
        html += "</tr>";
        html += "<tr class=\"whitebg\" >";
        html += "<td style=\"width:12%\"><strong>摘要</strong></td>";
        html += "<td  colspan=\"4\"><textarea id=\"tc_jzhaiyao\"></textarea></td>";
        html += "</tr>";
        $("#tbodyhtml").html(html);                          
		$("#tc_qitasm").val("");
		$("#tc_jzhaiyao").val("");
	}
	//编辑病例
	function bianjiBL(id){
	var reqmsg="{'action':'QUERY_CASE_RECORD_INFO_REQUEST','content':{\"medicalHistoryListShow\":\"true\",";

	if (id != null && id != "") {
		reqmsg += "\"id\":" + id + ",";
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:true,
          url : "caseRecord.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if(data.content != null){
            	  	$("#bl_blid").val(data.content.id);
					$("#tc_pdrq").val(riqiChange(data.content.assessmentTime));
					$("#blpgr_search").val(data.content.assessmentPerson);
					$("#tc_scjskfsj").val(riqiChange(data.content.recoveryTime));
					
					var html = "";
					if(data.content.medicalHistoryList != null && data.content.medicalHistoryList.length > 0){
						for(var i=0;i < data.content.medicalHistoryList.length;i++){
							html += "<tr class=\"whitebg\" >";
							html += "<td style=\"width:12%\"><textarea >" + data.content.medicalHistoryList[i].disease + "</textarea></td>";
							html += "<td style=\"width:12%\"><textarea >" + data.content.medicalHistoryList[i].diseaseCourse + "</textarea></td>";
        					html += "<td style=\"width:35%;max-width:35%\"><textarea >" + data.content.medicalHistoryList[i].mainTreatment + "</textarea></td>";                      
        					html += "<td style=\"width:35%;max-width:35%\"><textarea >" + data.content.medicalHistoryList[i].diseaseControl + "</textarea></td>";               
        					html += "<td style=\"text-align:center\"><span onclick=\"$(this).parent().parent().remove();\"><i class=\"fa fa-minus\" ></i></span></td>";                                                           
        					html += "</tr>";
						}
					}

        			html += "<tr class=\"whitebg\" id=\"qitashuoming\">";
        			html += "<td style=\"width:12%\"><strong>其他说明</strong></td>";
        			html += "<td  colspan=\"4\"><textarea id=\"tc_qitasm\">" + data.content.other + "</textarea></td>";
        			html += "</tr>";
        			html += "<tr class=\"whitebg\" >";
        			html += "<td style=\"width:12%\"><strong>摘要</strong></td>";
        			html += "<td  colspan=\"4\"><textarea id=\"tc_jzhaiyao\">" + data.content.des + "</textarea></td>";
        			html += "</tr>";
        			$("#tbodyhtml").html(html);   
					
            	    $("#bingli_bianji").click();
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
	}
	//作为模板新增
	function addMB(id){
	var reqmsg="{'action':'QUERY_CASE_RECORD_INFO_REQUEST','content':{\"medicalHistoryListShow\":\"true\",";

	if (id != null && id != "") {
		reqmsg += "\"id\":" + id + ",";
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:true,
          url : "caseRecord.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if(data.content != null){
            	  	$("#bl_blid").val("");
					$("#tc_pdrq").val(getNowFormatDate());
					$("#blpgr_search").val(getLoginName());
					$("#tc_scjskfsj").val(getNowFormatDate());
					
					var html = "";
					if(data.content.medicalHistoryList != null && data.content.medicalHistoryList.length > 0){
						for(var i=0;i < data.content.medicalHistoryList.length;i++){
							html += "<tr class=\"whitebg\" >";
							html += "<td style=\"width:12%\"><textarea >" + data.content.medicalHistoryList[i].disease + "</textarea></td>";
							html += "<td style=\"width:12%\"><textarea >" + data.content.medicalHistoryList[i].diseaseCourse + "</textarea></td>";
        					html += "<td style=\"width:35%;max-width:35%\"><textarea >" + data.content.medicalHistoryList[i].mainTreatment + "</textarea></td>";                      
        					html += "<td style=\"width:35%;max-width:35%\"><textarea >" + data.content.medicalHistoryList[i].diseaseControl + "</textarea></td>";               
        					html += "<td style=\"text-align:center\"><span onclick=\"$(this).parent().parent().remove();\"><i class=\"fa fa-minus\" ></i></span></td>";                                                           
        					html += "</tr>";
						}
					}

        			html += "<tr class=\"whitebg\" id=\"qitashuoming\">";
        			html += "<td style=\"width:12%\"><strong>其他说明</strong></td>";
        			html += "<td  colspan=\"4\"><textarea id=\"tc_qitasm\">" + data.content.other + "</textarea></td>";
        			html += "</tr>";
        			html += "<tr class=\"whitebg\" >";
        			html += "<td style=\"width:12%\"><strong>摘要</strong></td>";
        			html += "<td  colspan=\"4\"><textarea id=\"tc_jzhaiyao\">" + data.content.des + "</textarea></td>";
        			html += "</tr>";
        			$("#tbodyhtml").html(html);   
					
            	    $("#bingli_bianji").click();
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
	}
	//转化日期
   function riqiChange(data){
   		var date_=data;
    	var date2=data.substr(0,4)+"-"+data.substr(4,2)+"-"+data.substr(6,2);
    	if(date2 == "--"){
    		date2 = "无";
    	}
    	return date2;
   }
	//保存新增病例
	function save_bl(){
		var tc_pdrq = $("#tc_pdrq").val();
		var blpgr_search = $("#blpgr_search").val();
		var tc_scjskfsj = $("#tc_scjskfsj").val();
		var tc_qitasm = $("#tc_qitasm").val();
		var tc_jzhaiyao = $("#tc_jzhaiyao").val();
		
		if(tc_pdrq == "" || tc_pdrq == null){
			alert("评定日期必填");
			return;
		}
		if (tc_scjskfsj == "" || tc_scjskfsj == null) {
			alert("首次接受康复时间必填");
			return;
		}
		if(blpgr_search == "" ||  blpgr_search == null){
        	alert("评定人必填");
			return;
        }
		if (tc_qitasm != null && tc_qitasm != "") {
			tc_qitasm = JSON.stringify(tc_qitasm);
			if(tc_qitasm.length > 200){
				alert("其他说明超过最大字数限制200字");
				return;
			}
		}
		if (tc_jzhaiyao != null && tc_jzhaiyao != "") {
			tc_jzhaiyao = JSON.stringify(tc_jzhaiyao);
			if(tc_jzhaiyao.length > 500){
				alert("摘要超过最大字数限制500字");
				return;
			}
		}
		var reqmsg="{'action':'ADD_CASE_RECORD_INFO_REQUEST','content':{";
		var olderId="<%=request.getAttribute("olderId")%>";
        reqmsg += "\"olderId\":" + olderId + ",";
        
        reqmsg += "\"recoveryTime\":\"" + tc_scjskfsj.substring(0, 4) + tc_scjskfsj.substring(5, 7) + tc_scjskfsj.substring(8, 10) + "000000" + "\",";
      
        if(tc_qitasm != "" && tc_qitasm != null){
        	reqmsg += "\"other\":" + tc_qitasm + ",";
        }else{
        	reqmsg += "\"other\":\"\",";
        }
        if(tc_jzhaiyao != "" && tc_jzhaiyao != null){
        	reqmsg += "\"des\":" + tc_jzhaiyao + ",";
        }else{
        	reqmsg += "\"des\":\"\",";
        }
       
        reqmsg += "\"assessmentPerson\":\"" + blpgr_search + "\",";
        
        reqmsg += "\"assessmentTime\":\"" + tc_pdrq.substring(0, 4) + tc_pdrq.substring(5, 7) + tc_pdrq.substring(8, 10) + "000000" + "\",";

        var bljbList = $("#tbodyhtml tr");
		reqmsg += "\"medicalHistoryList\":[";
		var disease = "";
		var diseaseCourse = "";
		var mainTreatment = "";
		var diseaseControl = "";
		for(var i = 0;i<bljbList.length-2;i++){
			if($.trim($("#tbodyhtml").find("tr:eq("+i+")").find("td:eq(0)").find("textarea").val()) == ""){
				alert("请输入疾病名称");
				return;
			}else{
				disease = $("#tbodyhtml").find("tr:eq("+i+")").find("td:eq(0)").find("textarea").val();
				diseaseCourse = $("#tbodyhtml").find("tr:eq("+i+")").find("td:eq(1)").find("textarea").val();
				mainTreatment = $("#tbodyhtml").find("tr:eq("+i+")").find("td:eq(2)").find("textarea").val();
				diseaseControl = $("#tbodyhtml").find("tr:eq("+i+")").find("td:eq(3)").find("textarea").val();
				if (disease != null && disease != "") {
					if(disease.length > 100){
						alert("第" + (i+1) + "行疾病最大字数超出限制100字");
						return;
					}
				}
				if (diseaseCourse != null && diseaseCourse != "") {
					if(diseaseCourse.length > 100){
						alert("第" + (i+1) + "行病程最大字数超出限制100字");
						return;
					}
				}
				if (mainTreatment != null && mainTreatment != "") {
					if(mainTreatment.length > 200){
						alert("第" + (i+1) + "行目前主要治疗最大字数超出限制200字");
						return;
					}
				}
				if (diseaseControl != null && diseaseControl != "") {
					if(diseaseControl.length > 500){
						alert("第" + (i+1) + "行疾病控制情况最大字数超出限制500字");
						return;
					}
				}
				reqmsg +="{\"disease\":\"" + disease + "\",";
				reqmsg +="\"diseaseCourse\":\"" + diseaseCourse + "\",";
				reqmsg +="\"mainTreatment\":\"" + mainTreatment + "\",";
				reqmsg +="\"diseaseControl\":\"" + diseaseControl + "\"},";
			}
	    }
		reqmsg +="],";
		
		var blid = $("#bl_blid").val();
		if(blid != null && blid != ""){//有值编辑
			reqmsg += "\"id\":" + blid + ",";
		}
		reqmsg += "}}";
     
        jQuery.ajax({
          	type : "post",
          	async:true,
          	url : "caseRecord.do?handler",
          	dataType : "json",
          	data: {
           	    "reqmsg":reqmsg
          	},
          	success : function(data){
              if(data.des=="success"){
                if($("#bl_blid").val() != "" && $("#bl_blid").val() != null){
                	go2page(currentshownpage);
                	alert("编辑成功");
                	$("#close_bltc").click();
                }else{
                	query();
                	alert("新增成功");
                	$("#close_bltc").click();
                }
              }else{
              	alert(data.des);
              }
          },
          error:function(){
	           alert("error");
          }
     	});
	}
	
	//iframe内嵌页面设置高度
   	function reset() {
 		window.parent.reset();
	}		
	</script>

	<script src="js/behaviour/voice-commands.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
</body>
</html>
