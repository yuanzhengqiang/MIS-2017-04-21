<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="images/logo.png">
<title>账户余额</title>
<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />
<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
<link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">
<link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
<link href="css/style.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="js/jquery.datatables/bootstrap-adapter/css/datatables.css" />
<script type="text/javascript" src="js/sortListTool.js"></script>
<style>
.dropdown-toggle {
	height: 24px
}

.font16 {
	font-size: 16px;
	margin: 0px 5px
}
</style>
</head>
<body>
	<div id="cl-wrapper" style="padding-top:0;background:#fff;">
		<input type="hidden" value="" id="olderId">
		<input type="hidden" value="" id="sortType">
		<input type="hidden" value="" id="sortColumn">
		<div class="cl-mcont" style="background:#fff; padding-top:0px">
			<div class="row">
				<div class="col-sm-12" style=" vertical-align: middle; height: 34px; line-height: 34px; margin-bottom:10px">
					<label style="font-size:20px;margin-right:10px">账户余额</label>
					<span id="balance" style="font-size:18px;"></span>
				</div>
				<div class="col-sm-2" style=" vertical-align: middle; height: 34px; line-height: 34px;">
					<label>流水号</label>
				</div>
				<div class="col-sm-4 " style="margin-bottom:10px;">
					<input class="form-control" type="text" style="width: 100%" id="serialNumber">
				</div>
				<div class="col-sm-2" style=" vertical-align: middle; height: 34px; line-height: 34px;">
					<label>充值/消费类别</label>
				</div>
				<div class="col-sm-4 " style="margin-bottom:10px;">
					<select id="type" class="form-control" style="width:100%">
						<option value="" selected="selected"></option>
						<option value="1">充值</option>
						<option value="2">消费</option>
					</select>
				</div>
				<div class="col-sm-2  col-md-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
					<label>金额区间</label>
				</div>
				<div class="col-sm-2 " style="margin-bottom:10px;">
					<input class="form-control" type="text" style="width: 100%" id="minMoney" placeholder="最小金额" onpaste="return false;" onkeypress="keyPress()">
				</div>
				<div class="col-sm-2 " style="margin-bottom:10px;">
					<input class="form-control" type="text" style="width: 100%" id="maxMoney" placeholder="最大金额" onpaste="return false;" onkeypress="keyPress()">
				</div>
				<div class="col-sm-2  col-md-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
					<label>时间区间</label>
				</div>
				<div class="col-sm-5 col-md-2" style="margin-bottom:10px;">
					<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
						<span class="input-group-addon btn btn-primary">
							<span class="glyphicon glyphicon-th"></span>
						</span>
						<input class="form-control" size="16" value="" readonly="" type="text" id="time_input_start" placeholder="开始时间">
						<span class="input-group-btn">
							<button class="btn btn-danger deleteThisTime" type="button">
								<span class="fa fa-times"></span>
							</button>
						</span>
					</div>
				</div>
				<div class="col-sm-5 col-md-2" style="margin-bottom:10px;">
					<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
						<span class="input-group-addon btn btn-primary">
							<span class="glyphicon glyphicon-th"></span>
						</span>
						<input class="form-control" size="16" value="" readonly="" type="text" id="time_input_end" placeholder="结束时间">
						<span class="input-group-btn">
							<button class="btn btn-danger deleteThisTime" type="button">
								<span class="fa fa-times"></span>
							</button>
						</span>
					</div>
				</div>
				<div class="col-sm-2" style=" vertical-align: middle; height: 34px; line-height: 34px;">
					<label>方式</label>
				</div>
				<div class="col-sm-4 " style="margin-bottom:10px;">
					<select id="way" class="form-control" style="width:100%">
						<option value="" selected="selected"></option>
						<option value="1">自动扣款</option>
						<option value="2">前台扣款</option>
						<option value="3">微信充值</option>
						<option value="4">前台充值</option>
						<option value="5">其他充值</option>
						<option value="6">其他扣款</option>
					</select>
				</div>
				<!-- 查询框结束 -->
				<!-- 操作按钮开始 -->
				<div class="col-sm-12">
					<button type="button" class="btn btn-primary " onclick="query()">
						<span>查询</span>
					</button>
				</div>
			</div>
			<!-- 操作按钮结束 -->
			<!-- 数据表格开始 -->
			<div class="row">
				<div class="col-sm-12">
					<table class="table table-bordered dataTable hover" id="datatable" aria-describedby="datatable_info">
						<thead>
							<tr role="row">
								<th name="needSort" class="sorting" onclick="queryBySort(this,'serialNumber')">
									<strong>流水号</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'type')">
									<strong>类型</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'amount')">
									<strong>金额</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'serviceTaskCode')">
									<strong>关联工单</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'chinese_rechargeEmployeeName')">
									<strong>充值人</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'rechargeMethod')">
									<strong>方式</strong>
								</th>
								<th name="needSort" class="sorting" onclick="queryBySort(this,'createTime')">
									<strong>时间</strong>
								</th>
							</tr>
						</thead>
						<tbody id="datacontainer">

						</tbody>
					</table>
				</div>
			</div>
			<!-- 数据表格结束 --
			<!-- 数据条数提示开始 -->
			<div class="row">
				<div class="col-sm-12">
					<div class="pull-left">
						<div id="datatable_info" class="dataTables_info">当前显示0 条总记录中的第0-0条</div>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
			<!-- 数据条数提示结束 -->
			<!-- 分页条开始 -->
			<div class="row">
				<div class="col-sm-4">
					<div class="dataTables_length" id="datatable2_length">
						<label style="margin-top:18px;">
							每页
							<select id="pageSizeSelector" size="1" onchange="query()">
								<option selected="selected" value="10">10</option>
								<option value="25">25</option>
								<option value="50">50</option>
								<option value="100">100</option>
							</select>
							条
						</label>
					</div>
				</div>
				<div class="col-sm-8">
					<div class="pull-right">
						<div class="dataTables_paginate paging_bs_normal">
							<ul id="paginationArea" class="pagination">
								<li class="prev disabled">
									<a href="#">
										<span class="fa fa-angle-left"></span>
										&nbsp;上一页
									</a>
								</li>
								<li class="active">
									<a href="#">1</a>
								</li>
								<li class="next">
									<a href="#">
										下一页&nbsp;
										<span class="fa fa-angle-right"></span>
									</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<!-- 分页条结束 -->
		</div>
		<div id="getHeight"></div>
	</div>
	<!-- 主页面结束 -->

	<div class="md-overlay"></div>

	<script type="text/javascript" src="js/mordo.tools/mordo.inputControl.js"></script>
	<script type="text/javascript" src="js/mordo.tools/mordo.timeProcessing.js"></script>
	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
	<script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>
	<script type="text/javascript" src="js/masonry.js"></script>
	<script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>
	<script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
	<script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>

	<script type="text/javascript">
	//根据排序规则重新查询
	function queryBySort(par,column){
		var classFlag = listSortClickEvent(par);
		var type = judgmentChinese(column);
		if(type != null && type != ""){
			classFlag = type + classFlag;
			column = column.substr(8,column.length);
		}
		$("#sortType").val(classFlag);
		$("#sortColumn").val(column);
		go2page(currentshownpage);
	}
        
	$(document).ready(function(){	
		balance();
		query();
		
    	App.init();
    	$(".md-trigger").modalEffects();
    	$(".deleteThisTime").click(function(){               //清除日期框中的值
 	       $(this).parent().prev()[0].value = "";
 		});
    	
	});
	
	//iframe内嵌页面设置高度
   	function reset() {
 		window.parent.reset();
	}
	
	//账户余额查询
	function balance(){
		var olderId="<%=request.getAttribute("olderId")%>";
	
		var reqmsg="{\"action\":\"QUERY_OLDER_LIST_REQUEST\",\"page\":{\"pageno\":\"1\",\"pagesize\":\"1\"},\"content\":{";
		reqmsg += "\"id\":" + olderId + "";
		reqmsg += "}}";
		jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "older.do?handler",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	            	  if (data.content.olderList != null && data.content.olderList.length > 0) {
					  	 $("#balance").html(data.content.olderList[0].accountNum);
					  }
	              }else if(data.des=="failure"){
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}
	
	
	//查询
	var currentshownpage = 1;
	
	function query() {
		go2page(1);
	}
	
	function go2page(pagenumber){
		var reg1 = new RegExp("^(0|[1-9][0-9]*)$"); 
		
		var pagesize = $("#pageSizeSelector option:selected").val();
		var serialNumber = $("#serialNumber").val();//流水号
		var type = $("#type").val();//消费充值类型
		var minMoney = $("#minMoney").val();//最小金额
		if(minMoney != null && minMoney != ""){
			if(!reg1.test(minMoney)){ 
				alert("最小金额为整数");
	        	return;  
			}
		}
		var maxMoney = $("#maxMoney").val();//最大金额
		if(maxMoney != null && maxMoney != ""){
			if(!reg1.test(maxMoney)){ 
				alert("最大金额为整数");
	        	return;  
			}
		}
		if(minMoney != null && minMoney != "" && maxMoney != null && maxMoney != ""){
			if(parseInt(minMoney) > parseInt(maxMoney)){
				alert("最小金额不能大于最大金额");
	        	return; 
			}
		}
		var time_input_start = $("#time_input_start").val();//开始时间
		var time_input_end = $("#time_input_end").val();//结束时间
		if (time_input_start != null && time_input_start != "") {
	   		time_input_start = time_input_start.substring(0, 4) + time_input_start.substring(5, 7) + time_input_start.substring(8, 10) + "000001";
		}
		if (time_input_end != null && time_input_end != "") {
			time_input_end = time_input_end.substring(0, 4) + time_input_end.substring(5, 7) + time_input_end.substring(8, 10) + "235959";
		}
		if (time_input_start != null && time_input_start != "" && time_input_end != null && time_input_end != "") {
			if(time_input_start > time_input_end){
				alert("开始时间不能大于结束时间");
				return;
			}
		}
		var way = $("#way").val();//方式
		
		var olderId="<%=request.getAttribute("olderId")%>";
		var reqmsg="{\"action\":\"QUERY_RECHARGE_LIST_REQUEST\",";
		
		var sortType = $("#sortType").val();
		var sortColumn = $("#sortColumn").val();
		if(sortType != null && sortType != ""){
			reqmsg += "'order':[{'column':'" + sortColumn + "','type':'" + sortType + "'}],";
		}
	
		reqmsg += "\"page\":{\"pageno\":\"" + pagenumber + "\",\"pagesize\":\"" + pagesize + "\"},\"content\":{";
		
		reqmsg += "\"olderId\":" + olderId + ",";
		if (serialNumber != null && serialNumber != "") {
			reqmsg += "\"serialNumber_like\":\"" + serialNumber + "\",";
		}
		if (type != null && type != "") {
			reqmsg += "\"type\":" + type + ",";
		}
		if (minMoney != null && minMoney != "") {
			reqmsg += "\"amount_ge\":" + minMoney + ",";
		}
		if (maxMoney != null && maxMoney != "") {
			reqmsg += "\"amount_le\":" + maxMoney + ",";
		}
		if (time_input_start != null && time_input_start != "") {
			reqmsg += "\"createTime_ge\":\"" + time_input_start + "\",";
		}
		if (time_input_end != null && time_input_end != "") {
			reqmsg += "\"createTime_le\":\"" + time_input_end + "\",";
		}
		if (way != null && way != "") {
			reqmsg += "\"rechargeMethod\":" + way + ",";
		}
		
		reqmsg += "}}";

	    jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "recharge.do?handler",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	            	  changeData(data);
	              }else if(data.des=="failure"){
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}

	function changeData(data){
		var htmlCode = "";
		if (data.content != null) {
			if(data.content.rechargeList != null){
				jQuery.each(data.content.rechargeList, function(i, item) {
					htmlCode += "<tr>";	
					htmlCode += "<td>" + item.serialNumber + "</td>";	
					htmlCode += "<td>" + changeType(item.type) + "</td>";
					htmlCode += "<td>" + item.amount + "</td>";	
					htmlCode += "<td>" + item.serviceTaskCode + " " + item.serviceName + "</td>";	
					htmlCode += "<td>" + item.rechargeEmployeeName + " " + item.rechargeEmployeeIndexNum + "</td>";	
					htmlCode += "<td>" + chongzhiWay(item.rechargeMethod)+ "</td>";	
					htmlCode += "<td>" + formateTime2(item.createTime) + "</td>";
					htmlCode += "</tr>";
				});
			}
		}
		$("#datacontainer").html(htmlCode);
		if (data.page != null) {
			genaratePaginateHtml(data.page.pageno, data.page.pageCount);
			genarateRecordNumberHtml(data.page.pageno, data.page.pagesize, data.page.recordCount);
				
		} else {
			genaratePaginateHtml(1, 1);
			genarateRecordNumberHtml(1, 10, 0);
				
		}
		balance();
		reset();
	}
	 
	/**
	 * 生成记录数信息
	 * @method genarateRecordNumberHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} pagesize 每页记录条目数
	 * @param {Number} totalRecord 总记录数
	 */
	function genarateRecordNumberHtml(currentpage, pagesize, totalRecord) {
		var recordInfos = "";
		if (totalRecord > 0) {
		    recordInfos = "当前显示" + totalRecord + "条总记录";
			recordInfos += "中第" + ((currentpage - 1) * pagesize + 1) + "-";
			if (currentpage * pagesize > totalRecord) {
				recordInfos += totalRecord;
			} else {
				recordInfos += currentpage * pagesize;
			}
			recordInfos += "条 ";
		} else {
			recordInfos = "当前显示0 条总记录中的第0-0条";
		}
		
		$("#datatable_info").html(recordInfos);
	}
	
	/**
	 * 生成分页信息
	 * @method genaratePaginateHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} totalpage 总页数
	 */
	function genaratePaginateHtml(currentpage, totalpage, pagesize) {
		currentshownpage = currentpage;
		var htmlcode = "";	
		//上一页
		if (currentpage > 1) {
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		} else {
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		}
		
		//具体页码
		if (totalpage <= 5) {
			for (var i = 1; i <= totalpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		} else {
			var startpage = currentpage;
			var endpage = currentpage;
			while (true) {
				if (endpage - startpage >= 4) {
					break;
				} else {
					if (startpage > 1) {
						startpage = startpage - 1;
					}
					if (endpage < totalpage) {
						endpage = endpage - (-1);
					}
				}
			}
			
			for (var i = startpage; i <= endpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		}
		
		//下一页
		if (totalpage > currentpage) {
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		} else {
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		}
		$("#paginationArea").html(htmlcode);
	}

	//类型
	function changeType(type){
		var typeName = "";
		switch(type){
			case 1:
				typeName = "充值";
				break;
				
			case 2:
				typeName = "消费";
				break;
			
			default:
				typeName = "未知";
				break;
		}
		return typeName;
	}

	//充值扣款方式
	function chongzhiWay(rechargeMethod){
		var name = "未知";
     	switch (rechargeMethod)
		{
			case 1:
  			name = "自动扣款";
  			break;
  			
			case 2:
  			name = "前台扣款";
  			break;
  			
  			case 3:
  			name = "微信充值";
  			break;
  			
  			case 4:
  			name = "前台充值";
  			break;
  			
  			case 5:
  			name = "其他充值";
  			break;
  			
  			case 6:
  			name = "其他扣款";
  			break;
  			
  			default:
  			break;
		}
		return name;
	}
	</script>

	<script src="js/behaviour/voice-commands.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
</body>

</html>
