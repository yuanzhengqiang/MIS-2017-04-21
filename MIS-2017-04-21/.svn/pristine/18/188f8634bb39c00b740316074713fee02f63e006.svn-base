<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%> 
<%@ page import="fsk.init.SystemInit" %>
<%
	String nickname = (String) session.getAttribute("nickname");
	if (nickname == null) {
		nickname = "";
	}
	String header = SystemInit.header;
	String headerImage = SystemInit.headerImage;
%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="images/logo.png">

	<title>新增设备</title>

	<!-- Bootstrap core CSS -->
	<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />

	<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	<![endif]-->


	<link href="css/style.css" rel="stylesheet" />	
<style>
	.hideul{position:absolute;top:33px;z-index:200;right:15px;left:15px;display:none}
	.hideul ul{ border:1px solid #ccc;width:100%;background:#f4f4f4;padding-left:0}
	.hideul ul li{ list-style-type:none;text-indent:20px}
	.hideul ul li:hover{ background:#ddd}
	.accordion .panel,.accordion .panel:first-child{border-top:1px solid #ECECEC;border-bottom:1px solid #ECECEC;}
 .BMap_bubble_content td{border:0 !important}
	 .BMap_cpyCtrl{ display:none; } 
.BMap_bubble_content td,.BMap_bubble_content tr ,.BMap_bubble_content table{border:0 !important;background:#fff}
</style>
<script type="text/javascript" src="js/addressJS.js"></script>
</head>

<body >	
<!-- 上侧栏开始 -->
    <div id="head-nav" class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="fa fa-gear"></span>
          </button>
          <a class="navbar-brand" href="#"  style="width:auto;background: url(images/<%=headerImage %>) no-repeat 0 10px;"><span><%=header %>/新增设备</span></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right user-nav">
            <li class="dropdown profile_menu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <img src="images/avatar2.jpg"/>
                <span id="accountNickname"><%=nickname %></span>
<!--                 <b class="caret"></b> -->
              </a>
<!--               <ul class="dropdown-menu"> -->
<!--                 <li><a href="#" class="md-trigger" data-modal="md-scale3">密码修改</a></li> -->
<!--                 <li class="divider"></li> -->
<!--                 <li><a href="systemLogin.do?logout">退出登录</a></li> -->
<!--               </ul> -->
            </li>
          </ul>
        </div><!--/.nav-collapse animate-collapse -->
      </div>
    </div>  <!-- 上侧栏结束 -->
    
<div id="cl-wrapper" style="padding-top:0px">	
	<div class="cl-mcont">
    	<div class="block-flat">  
				
					<div class="panel-group accordion accordion-semi"  style="margin-top:50px;">
					  <div class="panel panel-default">
						<div class="panel-heading">
						  <h4 class="panel-title">
							<a >基本信息</a>
						  </h4>
						</div>
						<div  class="panel-collapse collapse in">
						  <div class="panel-body form-horizontal">
								<div class="form-group">
								  <label class="col-sm-2 control-label">设备编号<span style="color:red">*</span></label>
								  <div class="col-sm-4">
									<input type="text" class="form-control" id="dev_bianhao" >									
								  </div>
								  <label  class="col-sm-2 control-label">绑定老人</label>
								  <input type="hidden" class="form-control" id="oldinput_searchId" value="">
								  <div class="col-sm-4 "  style="position:relative">
										<div class="input-group " >
											<input class="form-control"  type="text" id="oldinput_search" onclick="getolderName()" oninput="getolderName()" onmouseout="javascript:$('#hideul-1').hide();" onmouseover="javascript:$('#hideul-1').show();">
											<span class="input-group-btn"><button class="btn btn-primary " style="height:34px"  type="button"><span class="fa fa-search"></span></button></span>
										</div>
										<div class="hideul" id="hideul-1"  onmouseover="javascript:$('#hideul-1').show();" onmouseout="javascript:$('#hideul-1').hide();">
											<ul id="hideul_nei1">
						
											</ul>
										</div>
								  </div>
								</div>
								<div class="form-group">
								  <label  class="col-sm-2 control-label">设备类型<span style="color:red">*</span></label>
								  <div class="col-sm-4">
									<select class="form-control" id="dev_type" ><option value="1">老人定位器</option><option value="2">安护宝</option></select>
								  </div>
								  <label  class="col-sm-2 control-label">设备电话</label>
								  <div class="col-sm-4">
									<input type="text" class="form-control" id="dev_telephone" onkeypress="keyPress()">	
								  </div>
								</div>
								<div class="form-group">
								  <label  class="col-sm-2 control-label">设备名称</label>
								  <div class="col-sm-4">
									<input type="text" class="form-control" id="dev_name" >									
								  </div>
								</div>
						  </div>
						</div>
					  </div>
					</div>	
					<div class="panel-group accordion accordion-semi"  >
					  <div class="panel panel-default">
						<div class="panel-heading">
						  <h4 class="panel-title">
							<a >安装位置<span id="headlantiao_address"></span></a>
							<input type="hidden" class="form-control" id="dev_posLong" value="0">	
							<input type="hidden" class="form-control" id="dev_posLat" value="0">
						  </h4>
						</div>
						<div  class="panel-collapse collapse in">
						  <div class="panel-body form-horizontal">
						  						
								<div class="form-group ">
								 <label  class="col-sm-2 control-label">地址搜索</label>								   
								  <div class="col-sm-4 " style="padding-right:20px">
										<div class="input-group " >
											<input class="form-control easyui-textbox-simple" type="text" id="searchplace" value="">
											<span class="input-group-btn easyui-linkbutton" id="s_p_search_btn"><button style="height:34px"  class="btn btn-primary " type="button"><span class="fa fa-search"></span></button></span>
										</div>										
								</div>	
								</div>									
								  <div class="col-sm-6" >
								  		<p>当前位置经纬度：<span id="lng-lat"></span></p>		
								  	<div id="BaiduDitu" style="height:500px;" ></div>										
								  </div>
								  <div class="form-group">
								    <input type="hidden" id="searchlistNum" value="0">
								  	<div class="col-sm-3" style="display:none;" id="searchlist_hideForChoose">															
								    </div>
									<div class="col-sm-3" id="searchlist" style="padding-top: 33px" onclick="listclick()">															
								    </div>
									
								</div>
								
						  </div>
						</div>
					  </div>
					</div>
				
					
					<div class="row"><div class="col-sm-12" style="text-align:center;"  id=""><button class="btn btn-flat btn-rad  btn-primary"  onclick="save()">保存全部</button></div></div>
			

				</div>
				</div>

			</div> 
	
					 <!-- 主页面结束 -->

    <!-- 模态框开始-->
               


                
	<div class="md-overlay"></div>


	<script src="js/jquery.js"></script>

	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
  


  <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  
  <!-- The basic File Upload plugin -->

	<script type="text/javascript" src="js/behaviour/general.js"></script>


      <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=TbEPXcQbr7UROaKUR1zzKGoB"></script>
      <!--加载鼠标绘制工具-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
	<!--加载检索信息窗口-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css" />
    <script type="text/javascript">
    		//地图初始化
    		var map = window.map;
    		$(function(){
    			var homeUrl = "<%=request.getContextPath()%>" + "/welcome.do?main";
    	    	$(".navbar-brand").attr("href",homeUrl);
                 var map = new BMap.Map("BaiduDitu");    // 创建Map实例
                 map.centerAndZoom('上海市',14);//设定地图的中心点和坐标，将地图显示在地图容器中
                 window.map = map;//将map变量存储在全局
				 //map.addControl(new BMap.ScaleControl());  //比例尺
				 //map.scaleControlEnabled(false);
				 map.enableScrollWheelZoom();     //开启鼠标滚轮缩放
				 map.enableKeyboard();//启用键盘上下左右键移动地图
				 
				 map.enableInertialDragging();
				 map.enableContinuousZoom();
			     var size = new BMap.Size(10, 20);
				 map.addControl(new BMap.CityListControl({
    				anchor: BMAP_ANCHOR_TOP_LEFT,
    				offset: size,
    				// 切换城市之间事件
    				// onChangeBefore: function(){
    				//    alert('before');
    				// },
    				// 切换城市之后事件
    				// onChangeAfter:function(){
    				//   alert('after');
    				// }
				}));
				
				 ///点击获取坐标位置
    			 var geoc = new BMap.Geocoder();
				 map.addEventListener("click",function(e){		
				 	 var pt = e.point;
					 geoc.getLocation(pt, function (rs) {
            		 	var addComp = rs.addressComponents;
            			var vAddress = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
						$("#searchplace").val(vAddress);//设备地址
						$("#headlantiao_address").html("：" + vAddress);
						
						$("#dev_posLong").val(e.point.lng);//设备经度
					    $("#dev_posLat").val(e.point.lat);//设备纬度
            			$("#lng-lat").text(e.point.lng + "," + e.point.lat);
            			
				        map.clearOverlays();
            			var point22 = new BMap.Point(e.point.lng, e.point.lat);
            			var marker22 = new BMap.Marker(point22);

            			map.addOverlay(marker22);
    					
    					//$("#searchlist").html("");
        			 });
				 });
				 
              	 createSearch();
                 $("#s_p_search_btn").click(function () {
                    searchPlace($("#searchplace").val());
                 });
                 
                 $("#searchplace").keydown(function() { //焦点在搜索框时，按回车，搜索
					if (event.keyCode == 13) {
						$("#s_p_search_btn").click();
						return;
					}
				 });
				 
				 
				 var olderId="<%=request.getAttribute("olderId")%>";
    			 if(olderId != null && olderId != ""){//-老人详情页跳转过来
    				query_older(olderId);//新增
    			 }
            });
            
    //获取老人基本信息
    function query_older(olderId){
		var reqmsg = "{'action':'QUERY_OLDER_INFO_REQUEST','content':{\"id\":" + olderId + "}}";
			jQuery.ajax({
				type : "post",
				async : false,
				url : "daeOlder.do?handler",
				dataType : "json",
				data : {
					"reqmsg" : reqmsg
				},
				success : function(data) {
					if (data.des == "success") {
						if (data.content != null) {
							$("#oldinput_search").val(data.content.name);
							$("#oldinput_searchId").val(data.content.id);
						}
					} else if (data.des == "failure") {
						alert("查询失败");
					}
				},
				error : function() {
					alert("error");
				}
			});
	}
			
			//百度地图列表搜索初始化
            function createSearch() {
                var local = new BMap.LocalSearch(map,
                    {
                        renderOptions: { map: map, panel: "searchlist" },
                        
                        onSearchComplete: function(results){
							// 判断状态是否正确
							if (local.getStatus() == BMAP_STATUS_SUCCESS){
								var html = "";
								for (var i = 0; i < results.getCurrentNumPois(); i ++){
									html += "<div id=\"dtlb_" + i + "\"><input type=\"hidden\" id=\"name_" + i + "\" value=\"" + results.getPoi(i).address + "\"><input type=\"hidden\" id=\"poilng_" + i + "\" value=\"" + results.getPoi(i).point.lng + "\"><input type=\"hidden\" id=\"poilat_" + i + "\" value=\"" + results.getPoi(i).point.lat + "\"></div>";
								}
								$("#searchlistNum").val(results.getCurrentNumPois());
								$("#searchlist_hideForChoose").html(html);
							}
						}
                    });
                window.local = local;
            }
            
            //搜索
            function searchPlace(value) {
                window.local.search(value);              
            }
            
            function listclick(){
            //zoom: 1; overflow: hidden; padding: 0px 5px;
            //zoom: 1; overflow: hidden; padding: 0px 5px; background-color: rgb(240, 240, 240);
            	var style = "";
            	var id = 0;
            	var searchlistNum = $("#searchlistNum").val();
            	
            	setTimeout(function(){
            		for(var i = 0;i < searchlistNum; i++){
            	 		style = $("#searchlist").find("div").find("div:eq(0)").find("ol").find("li:eq(" + i + ")").find("div").attr("style");
            	 		if(style.indexOf("background-color") != -1){//包含,百度地图控件被点击了
            	 			id = i;
            	 			break;
            	 		}
            		}
            		$("#searchplace").val($("#name_"  + id).val());//设备地址
            		$("#headlantiao_address").html("：" + $("#name_"  + id).val());
            		
					$("#dev_posLong").val($("#poilng_"  + id).val());//设备经度
					$("#dev_posLat").val($("#poilat_"  + id).val());//设备纬度
            		$("#lng-lat").text($("#poilng_"  + id).val() + "," + $("#poilat_"  + id).val());
            		
				    map.clearOverlays();
            		var point33 = new BMap.Point($("#poilng_"  + id).val(), $("#poilat_"  + id).val());
            		var marker33 = new BMap.Marker(point33);
					map.addOverlay(marker33);
    				map.centerAndZoom(point33,14);
            	
            	},500);
            }
</script>

<script type="text/javascript">
		//只能输入数字0-9
        function keyPress() {
            var theEvent = window.event || arguments.callee.caller.arguments[0];
    		var keyCode = theEvent.keyCode || theEvent.which;
    		if ((keyCode < 48 || keyCode > 57) && keyCode != 8 && keyCode != 37 && keyCode != 39) {
               theEvent.preventDefault();
            }
        } 
        
//实时获取老人姓名
function getolderName(){
	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
	var name = $.trim($("#oldinput_search").val());
	if (name != null && name != "") {
		reqmsg += "\"name_like\":\"" + name + "\"";
	}else{
		$("#hideul_nei1").html("");
		$("#hideul-1").hide();
		return;
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "older.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	  var htmlcode = "";
              	  if(data.content != null){
              	  	 if(data.content.olderList != null){
            	  		jQuery.each(data.content.olderList, function(i, item) {
            	  				if(item != null){
		    						htmlcode += "<li onclick=\"olderNamefuzhi('" + item.name + " " + item.memberNum + "'," + item.id + ")\">" + item.name + " " + item.memberNum + "</li>";		
            	  				}	
		    	  		});
		    	 	 }
		    	  }
		    	  $("#hideul_nei1").html(htmlcode);
		    	  $("#hideul-1").show();
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}
//老人姓名赋值
function olderNamefuzhi(name,id){
	$("#oldinput_searchId").val(id);
	$("#oldinput_search").val(name);
	$("#hideul_nei1").html("");
	$("#hideul-1").hide();
}
//保存设备
function save(){
	var dev_bianhao = $.trim($("#dev_bianhao").val());//设备编号
	if(dev_bianhao == null || dev_bianhao == ""){
		alert("请填写设备编号");
		return;
	}
	if(dev_bianhao.length > 50){
		alert("设备编号过长");
		return;
	}
	var dev_name = $.trim($("#dev_name").val());//设备名称
	if(dev_name.length > 50){
		alert("设备名称过长");
		return;
	}
	var dev_type = $.trim($("#dev_type").val());//设备类型
	var oldinput_search = $.trim($("#oldinput_search").val());//绑定老人
	var oldinput_searchId = $.trim($("#oldinput_searchId").val());//绑定老人Id
	if(oldinput_search != null && oldinput_search != ""){
		if(oldinput_searchId == null || oldinput_searchId == ""){
			alert("请选择绑定老人");
			return;
		}
	}else{
		oldinput_searchId = "0";
	}
	
	var dev_posLong = $.trim($("#dev_posLong").val());//设备经度
	var dev_posLat = $.trim($("#dev_posLat").val());//设备纬度
	var searchplace = $.trim($("#searchplace").val());//设备地址
	if(searchplace == null && searchplace == ""){
		dev_posLong = "";
		dev_posLat = "";
	}
	var dev_telephone = $.trim($("#dev_telephone").val());//设备电话
	if(dev_telephone != null && dev_telephone != ""){
	 	if(dev_telephone.length > 19){
			alert("请输入正确的设备电话");
			return;
		}
		var reg1 = new RegExp("^(0|[1-9][0-9]*)$"); 
		if(!reg1.test(dev_telephone)){ 
        	alert("请输入正确的设备电话");
			return;
    	}
	}
	
	var reqmsg="{'action':'ADD_DEV_INFO_REQUEST','content':{";
	
    reqmsg += "\"code\":\"" + dev_bianhao + "\",";
	reqmsg += "\"name\":\"" + dev_name + "\",";
	reqmsg += "\"olderId\":" + oldinput_searchId + ",";
	reqmsg += "\"type\":" + dev_type + ",";

	if(oldinput_searchId != "" && oldinput_searchId != null && oldinput_searchId != 0){
		reqmsg += "\"status\":\"设备绑定\",";
	}else{
		reqmsg += "\"status\":\"设备新增\",";
	}
	reqmsg += "\"addTime\":\"" + getNowFormatDate() + "\",";
	reqmsg += "\"flong\":0,";
	reqmsg += "\"flat\":0,";
	reqmsg += "\"address\":\"" + searchplace + "\",";
	reqmsg += "\"posLong\":" + dev_posLong + ",";
	reqmsg += "\"posLat\":" + dev_posLat + ",";
	reqmsg += "\"devPhone\":\"" + dev_telephone + "\",";
	reqmsg += "\"locationStatus\":0,";
	
	reqmsg=reqmsg.substr(0,reqmsg.length-1);
	reqmsg += "}}";

	jQuery.ajax({
          type : "post",
          async:true,
          url : "dev.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	alert("保存成功");
              	var devId=data.content.id;
              	var path="<%=request.getContextPath()%>";
              	var url=path+"/dev.do?mainDetails&devId=" + devId;
              	window.location.replace(url);
              }else if(data.des=="failure"){
                 alert("保存失败");
              }else{
              	alert(data.des);
              }
          },
          error:function(){
	           alert("error");
          }
     });
}

//获取当前时间return yyyymmddhhmmss
function getNowFormatDate() {
    var date = new Date();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    var strHour = date.getHours();
    var strMinutes = date.getMinutes();
    var strSeconds = date.getSeconds();
    
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    if (strHour >= 0 && strHour <= 9) {
        strHour = "0" + strHour;
    }
    if (strMinutes >= 0 && strMinutes <= 9) {
        strMinutes = "0" + strMinutes;
    }
    if (strSeconds >= 0 && strSeconds <= 9) {
        strSeconds = "0" + strSeconds;
    }
    var currentdate = date.getFullYear() + "" + month + "" + strDate + "" + strHour + "" + strMinutes + "" + strSeconds;
    return currentdate;
}
</script>

</body>
</html>
