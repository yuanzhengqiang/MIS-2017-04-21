<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%> 
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="images/logo.png">


<!-- Bootstrap core CSS -->

<link rel="stylesheet" type="text/css"
	href="js/jquery.gritter/css/jquery.gritter.css" />

<link rel="stylesheet"
	href="fonts/font-awesome-4/css/font-awesome.min.css">

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	<![endif]-->
<link rel="stylesheet" type="text/css"
	href="js/jquery.nanoscroller/nanoscroller.css" />

<link rel="stylesheet" type="text/css"
	href="js/bootstrap.switch/bootstrap-switch.css" />
<link rel="stylesheet" type="text/css"
	href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.select2/select2.css" />
<link rel="stylesheet" type="text/css"
	href="js/bootstrap.slider/css/slider.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.niftymodals/css/component.css" />
<link rel='stylesheet' type='text/css'
	href='js/jquery.fullcalendar/fullcalendar/fullcalendar.css' />
<link rel='stylesheet' type='text/css'
	href='js/jquery.fullcalendar/fullcalendar/fullcalendar.print.css'
	media='print' />
<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<!-- Custom styles for this template -->
<link href="css/style.css" rel="stylesheet" />
<style>
.label0 {
	padding: 6px 0 0 15px
}

.label1 {
	margin-bottom: 5px
}

textarea {
	resize: vertical
}

.ppppp span {
	margin-right: 15px
}

.ppppp .rednotice {
	color: red;
}

.yiwancheng {
	background-color: #60C060;
}

.yiwancheng:hover {
	background-color: #65ca65;
}

.daifenpei {
	background-color: #FF9900;
}

.daifenpei:hover {
	background-color: #ffa800;
}

.daishenhe {
	background-color: #5BC0DE;
}

.daishenhe:hover {
	background-color: #5fc8e7;
}

.hideul {
	position: absolute;
	top: 33px;
	z-index: 200;
	right: 15px;
	left: 15px;
	display: none
}

.hideul ul {
	border: 1px solid #ccc;
	width: 100%;
	background: #f4f4f4;
	padding-left: 0
}

.hideul ul li {
	list-style-type: none;
	text-indent: 20px
}

.hideul ul li:hover {
	background: #ddd
}
</style>
</head>

<body>
	<div id="head-nav" class="navbar-fixed-top">
		<div class="block-flat">
			<div class="row">
				<div class="page-head col-xs-6"
					style="padding-bottom:0;padding-top:0;border:0;">
					<h3>工单排班</h3>
					<ol class="breadcrumb">
						<li>服务管理</li>
						<li class="active">工单排班</li>
						<input type="hidden" id="userId_login" value="">
						<input type="hidden" id="OlderId_choose" value="">
						<input type="hidden" id="riqi_choose" value="">
						<input type="hidden" id="LoginName" value="">
						<input type="hidden" id="rl_viewname" value="month">
						<input type="hidden" id="rl_viewSXF" value="">
						<input type="hidden" id="rl_viewXXF" value="">
						<input type="hidden" id="rl_viewbiaoji1" value="">
						<input type="hidden" id="rl_viewbiaoji2" value="">
					</ol>
				</div>
			</div>
		</div>

	</div>


	<div id="cl-wrapper1" style="overflow:hidden">


		<div class="container-fluid" id="pcont">

			<div class="cl-mcont">
				<div class="row">
					<div class="col-md-9">
						<div class="block-flat">
							<div class="header">
								<h4>
								<c:if test="${servicePaiban_queryOld_btn_control != 'yes' or servicePaiban_queryOld_btn_show == 'yes'}">	
									<button type="button" class="btn btn-primary md-trigger"
										data-modal="choose-oldder" onclick="query()">选择老人</button>
								</c:if>			
									<span style="margin-left:50px" id="selectOlderZT"></span>

									<div class='input-group date form_date pull-right'
										style="width:150px">
										<input name="" id="datetimepicker" type='text'
											class="form-control " readonly="readonly" placeholder="选择月份" onchange="query_gdlb_zuoshangjiao()"/>
										<span class="input-group-addon "> <span
											class="glyphicon glyphicon-calendar"></span> </span>
									</div>
								</h4>
							</div>
							<div class="content">
								<div id='calendar'></div>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="block-flat">
							<div class="header">
								<h4 style="line-height:34px;margin-bottom:3px;overflow:hidden" id="gdlb_right">
									任务列表</h4>
							</div>
							<div class="content">
								<P style="margin-bottom:0">
									<input type='checkbox' id='rad-11' name="rad-1"
										onclick="adjusttasklist()" /> <label for='rad-11'
										style="margin-right:10px;color:#54A754">审核通过</label> <input
										type='checkbox' id='rad-12' name="rad-1"
										onclick="adjusttasklist()" /> <label for='rad-12'
										style="margin-right:10px;color:#28a1c4">待审核</label> <input
										type='checkbox' id='rad-13' name="rad-1"
										onclick="adjusttasklist()" /> <label for='rad-13'
										style="color:#E38800">待分配</label>
								</p>
								<div id='external-events'>
									<!--<div class='external-event yiwancheng'>1手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event yiwancheng'>2手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event yiwancheng'>2手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event yiwancheng'>2手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daifenpei'>3手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daifenpei'>4手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daifenpei'>4手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>5手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>6手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>6手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>6手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>6手足部清洁和护理（包括123456。。。）</div>
									<div class='external-event daishenhe'>6手足部清洁和护理（包括123456。。。）</div>-->
									<!--  <p>
                  <input type='checkbox' id='drop-remove' /> <label for='drop-remove'>拖动后从此处删除</label>
                </p>-->
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
	<!-- Nifty Modal -->



	<!-- Nifty Modal -->
	
	<div class="md-modal md-effect-9" id="choose-oldder"
		style="width:80%;max-width:80%;margin-top:-130px;">
		<div class="md-content">
			<div class="modal-header"
				style="padding-bottom:0;padding-top:10px;height:30px">
                <button type="button" id="close_xzlr" style="display:none;" class="btn btn-default btn-flat md-close" data-dismiss="modal">关闭</button>
				<button type="button" class="close md-close" data-dismiss="modal"
					aria-hidden="true" style="font-size:30px">&times;</button>
			</div>
			<div class="modal-body form">
				<div class="row">
					<div class="col-xs-2 col-sm-1 label0">姓名</div>
					<div class="col-xs-4 col-sm-2 label1" style="position:relative">
						<div class="input-group ">
							<input class="form-control" type="text" id="oldinput_search"
								onclick="getolderName()" oninput="getolderName()"
								onmouseout="javascript:$('#hideul-1').hide();"
								onmouseover="checkOlderName()"> <span
								class="input-group-btn"><button class="btn btn-primary "
									type="button">
									<span class="fa fa-search"></span>
								</button>
							</span>
						</div>
						<div class="hideul" id="hideul-1"
							onmouseover="javascript:$('#hideul-1').show();"
							onmouseout="javascript:$('#hideul-1').hide();">
							<ul id="hideul_nei1">

							</ul>
						</div>
					</div>
					<div class="col-xs-2  col-sm-1 label0">是否存在未审核通过的工单</div>
					<div class="col-xs-4 col-sm-2 label1">
						<select id="ifweishenhe" class="form-control " onchange="query()">
							<option value="">全部</option>
							<option value="2,3">是</option>
							<option value="4,5,6,7">否</option>
						</select>
					</div>
					<div class="col-xs-6  col-sm-2">
						<button type="button" class="btn btn-primary pull-right"
							onclick="allOlder()">全部老人</button>
					</div>
					<div class="col-xs-6  col-sm-2">
						<button type="button" class="btn btn-primary pull-right"
							onclick="xuanzeOlder()">确定</button>
					</div>
					<div class="col-xs-6  col-sm-2" id="dqyfChoose">
						
					</div>
					
				</div>
				<div class="row">
					<div class="col-sm-12">
						<h4>老人列表</h4>
						<input type="hidden" id="id2">
						<input type="hidden" id="hname2">
						<input type="hidden" id="allchooseId2">
                        <input type="hidden" id="allchooseName2">
					</div>
					<div class="col-sm-12">
						<table class="table table-bordered  hover" id="">
							<thead>
								<tr>
									<th style="width:2%;"><input id="firstcheckbox" type="checkbox" class="col_selector" onclick="selectAll();"></th>
									<th><strong>姓名</strong>
									</th>
									<th><strong>本月已完成</strong>
									</th>
									<th><strong>待分配</strong>
									</th>
									<th><strong>本月待审核</strong>
									</th>
								</tr>
							</thead>
							<tbody id="datacontainer" role="alert" aria-live="polite"
								aria-relevant="all">
								<!-- <tr>
									<td ><button type="button" class="btn btn-primary btn-xs" >选择</button></td>
									<td>老王3</td>
									<td>0</td>
									<td>0</td>
									<td>6</td>
									</tr>	 -->
							</tbody>
						</table>
					</div>

					<div class="col-sm-4">
						<div class="" id="">
							每页 <select id="pageSizeSelector" size="1"
								name="datatable2_length" onchange="query()"><option
									selected="selected" value="10">10</option>
								<option value="25">25</option>
								<option value="50">50</option>
								<option value="100">100</option>
							</select> 条</label>
						</div>
					</div>
					<div class="col-sm-8">
						<div class="pull-right">
							<div class="">
								<ul id="paginationArea" class="pagination" style="margin-top:0">
									<li class="prev disabled"><a href="#"><span
											class="fa fa-angle-left"></span>&nbsp;上一页</a>
									</li>
									<li class="active"><a href="#">1</a>
									</li>
									<li class="next"><a href="#">下一页&nbsp;<span
											class="fa fa-angle-right"></span>
									</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<input type="hidden" class="   md-trigger" data-modal="shenhe" value="工单信息弹出框" id="gongdanxinxi_tck">
	<div class="md-modal md-effect-9" id="shenhe">
		<div class="md-content">
			<div class="modal-body form">
				<div class="row ">
					<label class="form-group col-md-3 col-sm-3  col-xs-3 "> 负责人
					</label>
					<div class="form-group col-md-8 col-sm-9  col-xs-9 " id="gdxx_model_fzr"></div>
				</div>
				<div class="row ">
					<label class="form-group col-md-3 col-sm-3  col-xs-3 "> 参与人
					</label>
					<div class="form-group col-md-8 col-sm-9  col-xs-9 " id="gdxx_model_cyr"></div>
				</div>
				<div class="row ">
					<label class="form-group col-md-3 col-sm-3  col-xs-3 "> 老人
					</label>
					<div class="form-group col-md-8 col-sm-9  col-xs-9 " id="gdxx_model_old"></div>
				</div>
				<div class="row ">
					<label class="form-group col-md-3 col-sm-3  col-xs-3 ">
						服务内容 </label>
					<div class="form-group col-md-8 col-sm-9  col-xs-9 ">
						<textarea class="form-control" id="gdxx_model_fwnr"></textarea>
					</div>
				</div>
				<div class="row no-margin-y">
					<label class="form-group col-md-3 col-sm-3  col-xs-4 ">
						预计服务时间 </label>
					<div class="form-group col-md-8 col-sm-9  col-xs-9 no-margin">
						<div class="input-group">
							<input class="form-control" size="30" type="text"
								readonly="readonly" placeholder="YYYY-MM-DD HH:mm" id="gdxx_model_yujiTime" />
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer" style="text-align:center;">
                <button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal">关闭</button>
            </div>
		</div>
	</div>

	<div class="md-overlay"></div>


	<script src="js/jquery.js"></script>
	<script type="text/javascript"
		src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript"
		src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript"
		src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript"
		src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript"
		src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript"
		src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js"
		type="text/javascript"></script>
	<script type="text/javascript"
		src="js/jquery.gritter/js/jquery.gritter.js"></script>
	<script type="text/javascript"
		src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>

	<script type="text/javascript">
    $(document).ready(function(){
    //选择年月的    startView: 3,   minView: 3, format: 'yyyy-mm',  
      $('#datetimepicker').datetimepicker({  
              format: 'yyyy-mm',  
               weekStart: 1,  
               autoclose: true,  
               startView: 3,  
               minView: 3,  
               forceParse: false,  
               language: 'zh-CN'  
      }); 
      
      getLoginName();
	  query_gdlb_chushihua();//初始化

      $('#external-events div.external-event').each(function() {
      
        var eventObject = {
          title: $.trim($(this).text()) ,// use the element's text as the event title
          color: $(this).css("background-color"),
          textColor: $(this).css("color")
        };
        
        $(this).data('eventObject', eventObject);
        
        
        var flag = this.id;
		flag = flag.split("-")[0];
        if(flag != "tongguo"){
        	$(this).draggable({
          		zIndex: 999,
          		revert: true,      // will cause the event to go back to its
          		revertDuration: 0  //  original position after the drag
        	});
        }
        
      });
      
     
	  $(".yiwancheng").show();
	  $(".daifenpei").show();
	  $(".daishenhe").show();
	  $("input[name=rad-1]").attr("checked","checked");
			
      //initialize the javascript
      App.init();
      $('.md-trigger').modalEffects();
      $(".deleteThisTime").click(function(){               //清除日期框中的值
	      $(this).parent().prev()[0].value = "";
	      // $(this).parent().siblings("input").val("");
	  });
	    
    });
    
    //根据控件值计算日期类型一  
    function jisuanRQ(){//riqi_choose 8月 2016 /  8月 1 — 7 2016 / 8月 1 — 7 2016		/ 周一, 8月 1, 2016 
    	var riqi = $(".fc-header-title").find("h2").html();
    	var riqi1 = riqi.split(",");
    	var year = "";
    	var month = "";
    	if(riqi1.length == 3){
    		year = $.trim(riqi1[2]);
    		month = $.trim(riqi1[1].split("月")[0]);
    		if (month >= 1 && month <= 9) {
        		month = "0" + month;
   			}
    	}else{
    		riqi = $.trim(riqi);
    		year = riqi.substr(riqi.length-4);
    		month = $.trim(riqi.split("月")[0]);
    		if (month >= 1 && month <= 9) {
        		month = "0" + month;
   			}
    	}
    	return year+month;
    }
    //根据控件值计算日期类型二
    function jisuanRQ2(){//riqi_choose 8月 2016 /  8月 1 — 7 2016 / 8月 1 — 7 2016		/ 周一, 8月 1, 2016 
    	var riqi = $(".fc-header-title").find("h2").html();
    	if(riqi == null || riqi == ""){
    		return "";
    	}
    	var riqi1 = riqi.split(",");
    	var year = "";
    	var month = "";
    	if(riqi1.length == 3){
    		year = $.trim(riqi1[2]);
    		month = $.trim(riqi1[1].split("月")[0]);
    		if (month >= 1 && month <= 9) {
        		month = "0" + month;
   			}
    	}else{
    		riqi = $.trim(riqi);
    		year = riqi.substr(riqi.length-4);
    		month = $.trim(riqi.split("月")[0]);
    		if (month >= 1 && month <= 9) {
        		month = "0" + month;
   			}
    	}
    	return year + "-" + month;
    }
    
//获取当前时间return yyyymmddhhmmss
function getNowFormatDate2() {
    var date = new Date();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    var strHour = date.getHours();
    var strMinutes = date.getMinutes();
    var strSeconds = date.getSeconds();
    
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    if (strHour >= 0 && strHour <= 9) {
        strHour = "0" + strHour;
    }
    if (strMinutes >= 0 && strMinutes <= 9) {
        strMinutes = "0" + strMinutes;
    }
    if (strSeconds >= 0 && strSeconds <= 9) {
        strSeconds = "0" + strSeconds;
    }
    var currentdate = date.getFullYear() + "" + month + "" + strDate + "" + strHour + "" + strMinutes + "" + strSeconds;
    return currentdate;
}
//时间格式化return yyyymmddhhmmss
function formateTimeFromDate(date) {
    var date = new Date(date);
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    var strHour = date.getHours();
    var strMinutes = date.getMinutes();
    var strSeconds = date.getSeconds();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    if (strHour >= 0 && strHour <= 9) {
        strHour = "0" + strHour;
    }
    if (strMinutes >= 0 && strMinutes <= 9) {
        strMinutes = "0" + strMinutes;
    }
    if (strSeconds >= 0 && strSeconds <= 9) {
        strSeconds = "0" + strSeconds;
    }
    var currentdate = date.getFullYear() + "" + month + "" + strDate + "" + strHour + "" + strMinutes + "" + strSeconds + "";
    return currentdate;
}
  </script>
	<script type='text/javascript'
		src='js/jquery.fullcalendar/fullcalendar/fullcalendar.js'></script>
	<script type="text/javascript">
/**
 * 格式化时间
 * @method formateTime3
 * @param {String} time 时间信息(YYYYMMDDHHmmSS)
 * @return 格式化的时间(YYYY-MM-DD HH:mm)
 */
function formateTime3(time) {
	if (time != null && time.length == 14) {
		return time.substring(0, 4) + "-" + time.substring(4, 6) + "-" + time.substring(6, 8) + " " + time.substring(8, 10) + ":" + time.substring(10, 12);
	} else {
		return time;
	}
}

//打开工单信息弹出框
function openliebiaoTC(id){
	riliKuaiData(id);
	$("#gongdanxinxi_tck").click();
}
	//查询工单基本信息-弹出框
	function riliKuaiData(id){
		var reqmsg="{'action':'QUERY_SERVICE_TASK_INFO_REQUEST','content':{\"serviceListShow\":\"true\",\"serviceEmployeeListShow\":\"true\",";
		reqmsg += "\"id\":" + id + ",";
   
		reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "serviceTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	if(data.content != null){
              		var fzrName = "";
              		var cyrNames = "";
            	 	$("#gdxx_model_old").html(data.content.olderName + " " + data.content.olderMemberNum);
            	 	$("#gdxx_model_yujiTime").val(formateTime3(data.content.serviceExpectTime));
            	 	if(data.content.serviceList != null && data.content.serviceList[0] != null){
            	 		$("#gdxx_model_fwnr").val(data.content.serviceList[0].name + " 包括: " + data.content.serviceList[0].fuwuSonNames);
            	 	}
            	 	if(data.content.serviceEmployeeList != null){
            	 		jQuery.each(data.content.serviceEmployeeList, function(i, item) {
            	 			if(item.type == 1){
            	 				fzrName = item.name + "  " + item.employeeCode;
            	 			}else{
								cyrNames += item.name + "  " + item.employeeCode + ",";
								cyrNames.replace(",,",",");
							}
						});
						if(cyrNames != ""){
							cyrNames = cyrNames.substr(0,cyrNames.length-1);
						}
            	 		$("#gdxx_model_fzr").html(fzrName);
            	 		$("#gdxx_model_cyr").html(cyrNames);
            	 	}
            	}
              }else{
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
	
	}
	
	//加载图片控件
    function calender(yy,mm){
      var date = new Date();
      var d = date.getDate();
      var m = date.getMonth();
      var y = date.getFullYear();
	  
	  if(yy != 0 && yy != null){
        	y = yy;
      }
      if(mm != 0 && mm != null){
        	m = parseInt(mm) - 1;
      }
      var rl_viewname = $("#rl_viewname").val();
      if(rl_viewname == "agendaWeek" || rl_viewname == "agendaDay"){
      		var rl_viewSXF = $("#rl_viewSXF").val();
      	    y = rl_viewSXF.substr(0,4);
      	    m = parseInt(rl_viewSXF.substr(4,2)) - 1;
      	    d = rl_viewSXF.substr(6,2);
      }
      
      if($("#rl_viewname").val() == "month"){
      	 d=28;
      }
      
     // alert(y+"||"+m+"||"+d);
     $("#calendar").fullCalendar({
    	    eventClick: function(calEvent, jsEvent, view) {  //点击日程触发事件
    	    	 var id = calEvent.id;
    	    	 riliKuaiData(id);
				$("#gongdanxinxi_tck").click();
    	    //打开模态框，修改相应信息提交后，重新获取加载calendar
    	    },
    	    dayClick: function(date, allDay, jsEvent, view) { 
                var selDate =$.fullCalendar.formatDate(date,'yyyy-MM-dd HH:mm');//格式化日期   
               	//console.log(selDate);
                //var selDate_1 = selDate + " 00:00";
                //var selDate_2 = selDate + " 1:00";
                //$("#startTime1").val(selDate);
                //$("#endTime1").val(selDate);
                //$("#addevent").click(); //点击日历空白处打开模态框，添加相应信息提交后，重新获取加载calendar
            } ,
    	year:y,
    	month:m,
    	date:d,
		allDayText: '全天',
		//firstHour: 6,
		slotMinutes: 30, //周、日视图时，最小间隔30min
		defaultEventMinutes: 60,		
		timeFormat: {
			agenda: 'H:mm{ - H:mm}'
		},
    	axisFormat: 'H:mm',
    	// timeFormat: 'H:mm' ,
        header: {
          left: 'title',
          center: '',
          right: 'month,agendaWeek,agendaDay,today, prev,next',
        },
        
		defaultView:rl_viewname,
		viewDisplay: function (view) {
        		$("#rl_viewname").val(view.name);
        		$("#rl_viewSXF").val(formateTimeFromDate(view.visStart));
        		$("#rl_viewXXF").val(formateTimeFromDate(view.visEnd));
        	//console.log(formateTimeFromDate(view.visStart) + "||" +formateTimeFromDate(view.visEnd));
        		//alert($(".fc-header-title").find("h2").html());
        		$("#rl_viewbiaoji2").val($(".fc-header-title").find("h2").html());
        		//alert($("#rl_viewbiaoji1").val() + "||" + $("#rl_viewbiaoji2").val());
        		if($("#rl_viewbiaoji1").val() != $("#rl_viewbiaoji2").val()){
        			$("#rl_viewbiaoji1").val($("#rl_viewbiaoji2").val());
        			query_gdlb_daitiaojian();
        		}
        		
        		
        	$('#external-events div.external-event').each(function() {
                var eventObject = {
                  title: $.trim($(this).text()) ,// use the element's text as the event title
                  color: $(this).css("background-color"),
                  textColor: $(this).css("color")
                };
                
                $(this).data('eventObject', eventObject);
                
		        var flag2 = this.id;
				flag2 = flag2.split("-")[0];
        		if(flag2 != "tongguo"){
        			$(this).draggable({
          				zIndex: 999,
          				revert: true,      // will cause the event to go back to its
          				revertDuration: 0  //  original position after the drag
        			});
        		}
                
              }); 
        		
        	
               // console.log(view.name);//获得当前视图时 month、agendaWeek、agendaDay
				//if (viewname != view.name){
				 //alert("视图改变了！");//
				 //viewname = view.name;
				//}
                //console.log(formateTimeFromDate(view.visStart));//获得当前视图的开始时间
                //console.log(view.visStart);
                //console.log(formateTimeFromDate(view.visEnd));//获得当前视图的结束时间的后一天
        },
		
        monthNames: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
        monthNamesShort: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
        dayNames: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
        dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
        today: ["今天"],
        firstDay: 1,
        buttonText: {
        	 today: '今天',
        	 month: '月',
        	 week: '周',
        	 day: '日',
        	 prev: '<<上翻',
        	 next: '下翻>>'
        	 },
        editable: true,
        events: function(start, end, timezone, callback) {
            $("#calendar").fullCalendar('removeEvents'); //Removes events from the calendar.清除日历上所有事件

			for(var i=0;i<tubiao_dateArray.length;i++){
				//console.log(JSON.parse(tubiao_dateArray[i]));
				$('#calendar').fullCalendar('renderEvent', JSON.parse(tubiao_dateArray[i]), false); // 将此event添加进日历
			}
         },
        
        eventDrop:function( event, delta, revertFunc, jsEvent, ui, view ) {
        	//console.log(event.start);  //新时间
        	//console.log(event.id);  //事件id
        	var id = event.id;
        	var name = $("#LoginName").val();
        	if(name == "" || name == null){
				alert("当前非员工,无法操作");
				return;
			}
	
        	var reqmsgs="{'action':'ADD_SERVICE_TASK_INFO_REQUEST','content':{";
        	
        	var time = formateTimeFromDate(event.start);
        	var hybTime = time.substr(8,6);
        	if(hybTime == "000000"){//月视图
        		time = time.substr(0,8) + "090000";
        		reqmsgs += "\"timeChange\":\"" + time + "\",";
        	}else{
        		reqmsgs += "\"serviceExpectTime\":\"" + time + "\",";
        	}
        	
        	reqmsgs += "\"id\":" + id + ",";
        	reqmsgs += "\"status\":3,";
        	
        	reqmsgs += "\"serviceLogList\":[" ;
			reqmsgs += "{\"createTime\":\"" + getNowFormatDate2() +"\",";
			reqmsgs += "\"createPerson\":\"" + name +"\",";
			reqmsgs += "\"type\":\"工单排班\",";
			reqmsgs += "\"log\":\"" + name + "排班好了工单，等待审核\"}";
			reqmsgs += "],";
        	
        	reqmsgs=reqmsgs.substr(0,reqmsgs.length-1);
			reqmsgs += "}}";
			
        	 jQuery.ajax({
          		type : "post",
          		async:false,
          		url : "serviceTask.do?handler",
          		dataType : "json",
          		data: {
               		"reqmsg":reqmsgs
          		},
          	 success : function(data){
              if(data.des=="success"){
              	$("#calendar").fullCalendar('removeEvents');
              	query_gdlb_daitiaojian();
              	alert("排班成功,等待审核");
              }else{
                 alert("排班失败");
              }
         	 },
         	 error:function(){
	      		alert("error");
          	 }
     		 }); 
     		 
     		 $('#external-events div.external-event').each(function() {
                var eventObject = {
                  title: $.trim($(this).text()) ,// use the element's text as the event title
                  color: $(this).css("background-color"),
                  textColor: $(this).css("color")
                };
                
                $(this).data('eventObject', eventObject);
                
		        var flag2 = this.id;
				flag2 = flag2.split("-")[0];
        		if(flag2 != "tongguo"){
        			$(this).draggable({
          				zIndex: 999,
          				revert: true,      // will cause the event to go back to its
          				revertDuration: 0  //  original position after the drag
        			});
        		}
                
              }); 
        },
        
        droppable: true, // 右边的排班拖进来
        drop: function(date,view) { // this function is called when something is dropped\
        	
        	var id = this.id;
        	var name = $("#LoginName").val();
        	if(name == "" || name == null){
				alert("当前非员工,无法操作");
				return;
			}
	
        	var reqmsgs="{'action':'ADD_SERVICE_TASK_INFO_REQUEST','content':{";
        	
        	var time = formateTimeFromDate(date);
        	var hybTime = time.substr(8,6);
        	if(hybTime == "000000"){//月视图
        		time = time.substr(0,8) + "090000";
        		reqmsgs += "\"timeChange\":\"" + time + "\",";
        	}else{
        		reqmsgs += "\"serviceExpectTime\":\"" + time + "\",";
        	}
        	
        	reqmsgs += "\"id\":" + id + ",";
        	reqmsgs += "\"status\":3,";
        	
        	reqmsgs += "\"serviceLogList\":[" ;
			reqmsgs += "{\"createTime\":\"" + getNowFormatDate2() +"\",";
			reqmsgs += "\"createPerson\":\"" + name +"\",";
			reqmsgs += "\"type\":\"工单排班\",";
			reqmsgs += "\"log\":\"" + name + "排班好了工单，等待审核\"}";
			reqmsgs += "],";
        	
        	reqmsgs=reqmsgs.substr(0,reqmsgs.length-1);
			reqmsgs += "}}";
			
        	 jQuery.ajax({
          		type : "post",
          		async:false,
          		url : "serviceTask.do?handler",
          		dataType : "json",
          		data: {
               		"reqmsg":reqmsgs
          		},
          	 success : function(data){
              if(data.des=="success"){
              	$("#calendar").fullCalendar('removeEvents');
              	query_gdlb_daitiaojian();
              	alert("排班成功,等待审核");
              }else{
                 alert("排班失败");
              }
         	 },
         	 error:function(){
	      		alert("error");
          	 }
     		 }); 
        	
        	
        	
        	
             $('#external-events div.external-event').each(function() {
                var eventObject = {
                  title: $.trim($(this).text()) ,// use the element's text as the event title
                  color: $(this).css("background-color"),
                  textColor: $(this).css("color")
                };
                
                $(this).data('eventObject', eventObject);
                
		        var flag2 = this.id;
				flag2 = flag2.split("-")[0];
        		if(flag2 != "tongguo"){
        			$(this).draggable({
          				zIndex: 999,
          				revert: true,      // will cause the event to go back to its
          				revertDuration: 0  //  original position after the drag
        			});
        		}
                
              }); 
        
        
        
        
          // retrieve the dropped element's stored Event Object
         // var originalEventObject = $(this).data('eventObject');
          
       //   // we need to copy it, so that multiple events don't have a reference to the same object
         // var copiedEventObject = $.extend({}, originalEventObject);
          
          // assign it the date that was reported
       //   copiedEventObject.id = xxx;
       //   copiedEventObject.title = xxx;
        //  copiedEventObject.start = date;
       //   copiedEventObject.allDay = allDay;  
          //相应ajax操作保存此条信息
          
         // $('#calendar').fullCalendar('renderEvent', copiedEventObject, false);         

          
        }
      });
    }
  </script>
	<script type="text/javascript">
	function adjusttasklist(){ //三种状态切换选择
		if($("input[name=rad-1]:checked").length == 3){
			$(".yiwancheng").show();
			$(".daifenpei").show();
			$(".daishenhe").show();
		}else{
			if($("#rad-11").is(":checked")){
				$(".yiwancheng").show();
			}else{
				$(".yiwancheng").hide();
			}
			if($("#rad-12").is(":checked")){
				$(".daishenhe").show();
			}else{
				$(".daishenhe").hide();
			}
			if($("#rad-13").is(":checked")){
				$(".daifenpei").show();
			}else{
				$(".daifenpei").hide();
			}
		}
	}
</script>

	<script type="text/javascript">
	//获取当前登陆员工姓名
	function getLoginName(){
    	  var userId_login = "<%=request.getAttribute("userId")%>";
		  var reqmsg="{'action':'QUERY_EMPLOYEE_LIST_REQUEST','page':{'pageno':'1','pagesize':'1'},'content':{\"userId\":"+userId_login+"}}";
		  var name="";
		  jQuery.ajax({
          type : "post",
          async:false,
          url : "employee.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if (data.content != null) {
            	  	if(data.content.employeeList != null && data.content.employeeList.length == 1){
            	  	   name = data.content.employeeList[0].name;
            	  	   $("#LoginName").val(name);
            	  	   $("#gdlb_right").html(name + " 任务列表");
            	  	   $("#userId_login").val(data.content.employeeList[0].id);
            	  	}
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     	  });
	}
	
//实时获取老人姓名
function getolderName(){
	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
	var name = $.trim($("#oldinput_search").val());
	if (name != null && name != "") {
		reqmsg += "\"name_like\":\"" + name + "\"";
	}else{
		$("#hideul_nei1").html("");
		$("#hideul-1").hide();
		return;
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "older.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	  var htmlcode = "";
              	  if(data.content != null){
              	  	 if(data.content.olderList != null){
            	  		jQuery.each(data.content.olderList, function(i, item) {
            	  			if(item != null){
		    					htmlcode += "<li onclick=\"olderNamefuzhi('" + item.name + "')\">" + item.name + "</li>";		
            	  			}	
		    	  		});
		    	 	 }
		    	  }
		    	  $("#hideul_nei1").html(htmlcode);
		    	  $("#hideul-1").show();
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
     query();
}
//老人姓名赋值
function olderNamefuzhi(name){
	$("#oldinput_search").val(name);
	$("#hideul_nei1").html("");
	$("#hideul-1").hide();
}

//老人弹窗列表
function checkOlderName(){
	$('#hideul-1').show();
	if($.trim($("#oldinput_search").val()) == ""){
		query();
	}
}
var currentshownpage = 1;
function query() {
	$("#datetimepicker").val("");
	var time = jisuanRQ2();
	$("#dqyfChoose").html("当前为" + time.split("-")[0] + "年" + time.split("-")[1] + "月");
	go2page(1);
	
	document.getElementById("id2").value = "";
	document.getElementById("hname2").value = "";
}
function go2page(pagenumber){
	var time = jisuanRQ();
	var pagesize = $("#pageSizeSelector option:selected").val();
	var oldinput_search = $("#oldinput_search").val();
	var ifweishenhe = $("#ifweishenhe").val();
	//var userId_login = $("#userId_login").val();
	
	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'" + pagenumber + "','pagesize':'" + pagesize + "'},'content':{";
	
	if (oldinput_search != null && oldinput_search != "") {
		reqmsg += "\"name_like\":\"" + oldinput_search + "\",";
	}
	if (ifweishenhe != null && ifweishenhe != "") {
		reqmsg += "\"status_in\":\"" + ifweishenhe + "\",";
	}
	//if (userId_login != null && userId_login != "") {
	//	reqmsg += "\"fzrId\":" + userId_login + ",";
	//}
    if(time != null && time != ""){
    	reqmsg += "\"serviceExpectTime_ge\":\"" + time + "01000000" + "\",";
    	reqmsg += "\"serviceExpectTime_le\":\"" + time + "31235959" + "\",";
    }
    
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:true,
          url : "older.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  changeData(data);
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}
function changeData(data){
	var htmlcode = "";
	if (data.content != null) {
		var allchooseId2="";
		var allchooseName2="";
		jQuery.each(data.content.tcOlderCount, function(i, item) {
			htmlcode += "<tr class=\"gradeA odd\">";
			htmlcode += "<td><input id=\""+item.olderId+"\" value=\""+item.olderName+"\" name=\"index2\" type=\"checkbox\" onclick=\"selectOne2("+item.olderId+",'"+item.olderName+"')\" class=\"col_selector_t2\"></td>";
			//htmlcode += "<tr><td ><button type=\"button\" class=\"btn btn-primary btn-xs md-close\" onclick=\"xuanzeOlder(" + item.olderId + ",'"+ item.olderName +"')\">选择</button></td>";		
		    
			allchooseId2 += item.olderId+",";
			allchooseId2.replace(",,",",");
			allchooseName2 += item.olderName+",";
			allchooseName2.replace(",,",",");
			
		    htmlcode += "<td>" + item.olderName + "</td>";	
		    htmlcode += "<td>" + item.yiwancheng + "</td>";	
		    htmlcode += "<td>" + item.daifenpei + "</td>";	
		    htmlcode += "<td>" + item.daishenhe + "</td>";	
			htmlcode += "</tr>";
		});
		
		if(allchooseId2 != ""){
			allchooseId2 = allchooseId2.substr(0,allchooseId2.length-1);
		}
		$("#allchooseId2").val(allchooseId2);
		if(allchooseName2 != ""){
			allchooseName2 = allchooseName2.substr(0,allchooseName2.length-1);
		}
		$("#allchooseName2").val(allchooseName2);
		
	}
	$("#datacontainer").html(htmlcode);
	if (data.page != null) {
		genaratePaginateHtml(data.page.pageno, data.page.pageCount);
	} else {
		genaratePaginateHtml(1, 1);
	}
	checkSelect2();
}
function xuanzeOlder(){
	var id2 = document.getElementById("id2").value;
	var hname2 = document.getElementById("hname2").value;
	if (id2 == "" || hname2 == "") {
		alert("还未选中老人!");
		return;
	}
	if(hname2.length > 20){
		hname2 = hname2.substr(0,20) + "...";
	}
	$("#selectOlderZT").html(hname2);
	$("#OlderId_choose").val(id2);
	query_gdlb_daitiaojian();
	$("#close_xzlr").click();
}
	function selectAll() {//全选框判断
            if (document.getElementById("firstcheckbox").checked) {
            	document.getElementById("id2").value = $("#allchooseId2").val();
                document.getElementById("hname2").value = $("#allchooseName2").val();
                var checklist = document.getElementsByName("index2");
                for (var i = 0; i < checklist.length; i++) {
                    checklist[i].checked = 1;
                }
            }else {
            	document.getElementById("id2").value = "";
                document.getElementById("hname2").value = "";
                var checklist = document.getElementsByName("index2");
                for (var i = 0; i < checklist.length; i++) {
                    checklist[i].checked = 0;
                }
            }
	}
	function selectOne2(id, name) {//单框
			var haveChooseid2 = document.getElementById("id2").value.toString();
  			var haveChoose2id2 = haveChooseid2.split(",");
  			var haveChoose = document.getElementById("hname2").value.toString();
  			var haveChoose2 = haveChoose.split(",");
  			var flag = 0;
            if (document.getElementById(id).checked) {
            	for(var i = 0;i < haveChoose2.length;i++){
            		if(name == haveChoose2[i]){
            			flag = 1;
            		}
            	}
            	if(flag == 0){
            		if(haveChoose == ""){
            			document.getElementById("id2").value = id;
            			document.getElementById("hname2").value = name;
            		}else{
            			document.getElementById("id2").value =  haveChooseid2 + "," + id;
            			document.getElementById("hname2").value = haveChoose + "," + name;
            		}
            	}
            } else {
            	var qudiaoId = 0;
                for(var i = 0;i < haveChoose2.length;i++){
            		if(name == haveChoose2[i]){
            			qudiaoId = i;
            		}
            	}
            	haveChooseid2 = "";
            	haveChoose = "";
            	for(var i = 0;i < haveChoose2.length;i++){
            		if(i != qudiaoId){
            			haveChooseid2 += haveChoose2id2[i] + ",";
            			haveChooseid2.replace(",,",",");
            			haveChoose += haveChoose2[i] + ",";
            			haveChoose.replace(",,",",");
            		}
            	}
            	if(haveChooseid2 != ""){
					haveChooseid2 = haveChooseid2.substr(0,haveChooseid2.length-1);
				}
            	if(haveChoose != ""){
					haveChoose = haveChoose.substr(0,haveChoose.length-1);
				}
				document.getElementById("id2").value = haveChooseid2;
				document.getElementById("hname2").value = haveChoose;
            }
            document.getElementById("firstcheckbox").checked = false;
   }
  function checkSelect2() {//检查所有复选框
            var haveChoose = document.getElementById("hname2").value;
            var haveChoose2 = haveChoose.split(",");
            var checklist = document.getElementsByName("index2");
            for (var i = 0; i < checklist.length; i++) {
                for (var j = 0; j < haveChoose2.length; j++) {
                    if (checklist[i].value == haveChoose2[j]) {
                        checklist[i].checked = 1;
                    }
                }
            }
            if(haveChoose == ""){
            	 for (var i = 0; i < checklist.length; i++) {
            	 	checklist[i].checked = 0;
            	 }
            }
  }
function allOlder(){
	$("#selectOlderZT").html("");
	$("#OlderId_choose").val("");
	query_gdlb_daitiaojian();
	$("#close_xzlr").click();
	
	document.getElementById("id2").value = "";
	document.getElementById("hname2").value = "";
}
/**
 * 生成分页信息
 * @method genaratePaginateHtml
 * @param {Number} currentpage 当前页
 * @param {Number} totalpage 总页数
 */
function genaratePaginateHtml(currentpage, totalpage, pagesize) {
	currentshownpage = currentpage;

	var htmlcode = "";
	
	//上一页
	if (currentpage > 1) {
		htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
		htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
	} else {
		htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
		htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
	}
	
	//具体页码
	if (totalpage <= 5) {
		for (var i = 1; i <= totalpage; i++) {
			if (currentpage == i) {
				htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
			} else {
				htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
			}
		}
	} else {
		var startpage = currentpage;
		var endpage = currentpage;
		while (true) {
			if (endpage - startpage >= 4) {
				break;
			} else {
				if (startpage > 1) {
					startpage = startpage - 1;
				}
				if (endpage < totalpage) {
					endpage = endpage - (-1);
				}
			}
		}
		
		for (var i = startpage; i <= endpage; i++) {
			if (currentpage == i) {
				htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
			} else {
				htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
			}
		}
	}
	
	//下一页
	if (totalpage > currentpage) {
		htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
	} else {
		htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
	}
	$("#paginationArea").html(htmlcode);
}

/**
 * 格式化时间
 * @method formateTime
 * @param {String} time 时间信息(YYYYMMDDHHmmSS)
 * @return 格式化的时间(YYYY-MM-DD HH:mm:SS)
 */
function formateTime(time) {
	if (time != null && time.length == 14) {
		return time.substring(0, 4) + "-" + time.substring(4, 6) + "-" + time.substring(6, 8) + " " + time.substring(8, 10) + ":" + time.substring(10, 12) + ":" + time.substring(12, 14);
	} else {
		return time;
	}
}
/**
 * 格式化时间
 * @method formateTime2
 * @param {String} time 时间信息(YYYYMMDDHHmmSS)
 * @return 格式化的时间(YYYY-MM-DD)
 */
function formateTime2(time) {
	if (time != null && time.length == 14) {
		return time.substring(0, 4) + "-" + time.substring(4, 6) + "-" + time.substring(6, 8);
	} else {
		return time;
	}
}

//获取工单列表
var tubiao_dateArray = new Array();
function query_gdlb_chushihua(){
	$("#calendar").html("");
	tubiao_dateArray = new Array();
	
	var userId_login = $("#userId_login").val();
	
	var reqmsg="{'action':'QUERY_SERVICE_TASK_LIST_REQUEST','page':{'pageno':'1','pagesize':'2000000'},'content':{\"serviceEmployeeListShow\":\"true\",\"serviceListShow\":\"true\",";
	var year = 0;
	var month = 0;
	
	var daten = new Date();
	var monthn = daten.getMonth() + 1;
	if (monthn >= 1 && monthn <= 9) {
        monthn = "0" + monthn;
    }
	reqmsg += "\"serviceExpectTime_ge\":\"" + daten.getFullYear() + monthn + "01000000" + "\",";
    reqmsg += "\"serviceExpectTime_le\":\"" + daten.getFullYear() + monthn + "31235959" + "\",";

	reqmsg += "\"status_in\":\"3,4,5,6,7\",";
	
	reqmsg += "\"source_isNull\":\"null\",";
	
	if (userId_login != null && userId_login != "") {
    	reqmsg += "\"fzrId\":" + userId_login + ",";
    }
    
	reqmsg += "}}";

	var html = "";
	
	var tubiao_date = "";
	query_gdlb2();
	
	var externalEvents = $("#external-events").html();
	
    jQuery.ajax({
          type : "post",
          async:false,
          url : "serviceTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              		if(data.content != null){
            	 	 if(data.content.serviceTaskList != null){
            	 	 	var xmName = "未知";
            	 	 	var peopleName = "未知";
            	  		jQuery.each(data.content.serviceTaskList, function(i, item) {
            	  			if(item.serviceList[0] != null){
            	  				xmName = item.serviceList[0].name;
            	  			}
            	  			if($("#OlderId_choose").val() != null && $("#OlderId_choose").val() != ""){
            	  				jQuery.each(item.serviceEmployeeList, function(j, item2) {
            	  					if(item2.type == "1"){
            	  						peopleName = item2.name;
            	  					}
            	  				});
            	  			}else{
            	  				peopleName = item.olderName;
            	  			}
            	  			if(item.status == 2){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daifenpei' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 3){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daishenhe' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event yiwancheng' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}
            	  			tubiao_date += "{\"id\":" + item.id + ",";
            	  			tubiao_date += "\"title\":\"" + peopleName + " " + xmName + "\",";
            	  			tubiao_date += "\"start\":\"" + formateTime(item.serviceExpectTime) + "\",";
            	  			if(item.status == 2){
        	  					tubiao_date += "\"color\":\"#FF9900\",";
        	  				}else if(item.status == 3){
        	  					tubiao_date += "\"color\":\"#5BC0DE\",";
        	  				}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
        	  					tubiao_date += "\"color\":\"#60C060\",";
        	  					tubiao_date += "\"editable\":false,";
        	  				}
            				tubiao_date += "\"textColor\":\"#FFF\",";
            				tubiao_date += "\"allDay\":false}";
            				
            				tubiao_dateArray.push(tubiao_date);
            				tubiao_date = "";
            				xmName = "未知";
            				peopleName = "未知";
            	  		});
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}else{
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}
            	  }else{
            	  	$("#external-events").html(externalEvents + html);
            	  	calender(year,month);
            	  }
              }else if(data.des=="failure"){
              	 $("#external-events").html("");
              	 calender(year,month);
                 alert("查询失败");
              }
          },
          error:function(){
          	   $("#external-events").html("");
          	   calender(year,month);
	           alert("error");
          }
     });
}
function getthedate(dd,dadd)
{
	var a = new Date(dd);
	a = a.valueOf();
	a = a + dadd * 24 * 60 * 60 * 1000;
	a = new Date(a);
	var m = a.getMonth() + 1;
	if(m.toString().length == 1){
	    m='0'+m;
	}
	var d = a.getDate();
	if(d.toString().length == 1){
	    d='0'+d;
	}
	return a.getFullYear() + "-" + m + "-" + d;
}
function query_gdlb_daitiaojian() {
	$("#calendar").html("");
	tubiao_dateArray = new Array();
	
	var userId_login = $("#userId_login").val();
	
	var reqmsg="{'action':'QUERY_SERVICE_TASK_LIST_REQUEST','page':{'pageno':'1','pagesize':'2000000'},'content':{\"serviceEmployeeListShow\":\"true\",\"serviceListShow\":\"true\",";
	var year = 0;
	var month = 0;
	
	var rl_viewSXF = $("#rl_viewSXF").val();
	var rl_viewXXF = $("#rl_viewXXF").val();
	var rl_viewname = $("#rl_viewname").val();
	reqmsg += "\"serviceExpectTime_ge\":\"" + rl_viewSXF + "\",";
	reqmsg += "\"serviceExpectTime_le\":\"" + rl_viewXXF + "\",";
	
	if(rl_viewname == "month"){
		var newriqi = getthedate(rl_viewSXF.substr(0,4) + "-" + rl_viewSXF.substr(4,2) + "-" + rl_viewSXF.substr(6,2),15);
		year = newriqi.substr(0,4);
		month = newriqi.substr(5,2);
	}else{
		year = rl_viewSXF.substr(0,4);
    	month = rl_viewSXF.substr(4,2);
	}
	
	reqmsg += "\"source_isNull\":\"null\",";
	
	reqmsg += "\"status_in\":\"3,4,5,6,7\",";
	
    var OlderId_choose = $("#OlderId_choose").val();
    if (OlderId_choose != null && OlderId_choose != "") {
    	reqmsg += "\"olderId_in\":\"" + OlderId_choose + "\",";
    }
   
    if (userId_login != null && userId_login != "") {
    	reqmsg += "\"fzrId\":" + userId_login + ",";
    }
    
	reqmsg += "}}";

	var html = "";
	
	var tubiao_date = "";
	query_gdlb2();
	
	var externalEvents = $("#external-events").html();
	
    jQuery.ajax({
          type : "post",
          async:false,
          url : "serviceTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              		if(data.content != null){
            	 	 if(data.content.serviceTaskList != null){
            	 	 	var xmName = "未知";
            	 	 	var peopleName = "未知";
            	  		jQuery.each(data.content.serviceTaskList, function(i, item) {
            	  			if(item.serviceList[0] != null){
            	  				xmName = item.serviceList[0].name;
            	  			}
            	  			if($("#OlderId_choose").val() != null && $("#OlderId_choose").val() != ""){
            	  				jQuery.each(item.serviceEmployeeList, function(j, item2) {
            	  					if(item2.type == "1"){
            	  						peopleName = item2.name;
            	  					}
            	  				});
            	  			}else{
            	  				peopleName = item.olderName;
            	  			}
            	  			if(item.status == 2){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daifenpei' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 3){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daishenhe' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event yiwancheng' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}
            	  			tubiao_date += "{\"id\":" + item.id + ",";
            	  			tubiao_date += "\"title\":\"" + peopleName + " " + xmName + "\",";
            	  			tubiao_date += "\"start\":\"" + formateTime(item.serviceExpectTime) + "\",";
            	  			if(item.status == 2){
        	  					tubiao_date += "\"color\":\"#FF9900\",";
        	  				}else if(item.status == 3){
        	  					tubiao_date += "\"color\":\"#5BC0DE\",";
        	  				}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
        	  					tubiao_date += "\"color\":\"#60C060\",";
        	  					tubiao_date += "\"editable\":false,";
        	  				}
            				tubiao_date += "\"textColor\":\"#FFF\",";
            				tubiao_date += "\"allDay\":false}";
            				
            				tubiao_dateArray.push(tubiao_date);
            				tubiao_date = "";
            				xmName = "未知";
            				peopleName = "未知";
            	  		});
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}else{
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}
            	  }else{
            	  	$("#external-events").html(externalEvents + html);
            	  	calender(year,month);
            	  }
              }else if(data.des=="failure"){
              	 $("#external-events").html("");
              	 calender(year,month);
                 alert("查询失败");
              }
          },
          error:function(){
          	   $("#external-events").html("");
          	   calender(year,month);
	           alert("error");
          }
     });
}
function query_gdlb_zuoshangjiao(){
	$("#calendar").html("");
	tubiao_dateArray = new Array();
	
	var userId_login = $("#userId_login").val();
	
	var reqmsg="{'action':'QUERY_SERVICE_TASK_LIST_REQUEST','page':{'pageno':'1','pagesize':'2000000'},'content':{\"serviceEmployeeListShow\":\"true\",\"serviceListShow\":\"true\",";
	var year = 0;
	var month = 0;
	
	var time = $("#datetimepicker").val();
	if(time != null && time != ""){
		reqmsg += "\"serviceExpectTime_ge\":\"" + time.split("-")[0] + time.split("-")[1] + "01000000" + "\",";
    	reqmsg += "\"serviceExpectTime_le\":\"" + time.split("-")[0] + time.split("-")[1] + "31235959" + "\",";
    	year = time.split("-")[0];
    	month = time.split("-")[1];
	}
	$("#rl_viewbiaoji1").val("");
	$("#rl_viewbiaoji2").val("");
    $("#rl_viewSXF").val(time.split("-")[0] + time.split("-")[1] + "01000000");
	$("#rl_viewXXF").val(time.split("-")[0] + time.split("-")[1] + "31235959");
	$("#rl_viewname").val("month");
	
	reqmsg += "\"status_in\":\"3,4,5,6,7\",";
	reqmsg += "\"source_isNull\":\"null\",";
	
    var OlderId_choose = $("#OlderId_choose").val();
    if (OlderId_choose != null && OlderId_choose != "") {
    	reqmsg += "\"olderId_in\":\"" + OlderId_choose + "\",";
    }
   
    if (userId_login != null && userId_login != "") {
    	reqmsg += "\"fzrId\":" + userId_login + ",";
    }
    
	reqmsg += "}}";

	var html = "";
	
	var tubiao_date = "";
	query_gdlb2();
	
	var externalEvents = $("#external-events").html();
	
    jQuery.ajax({
          type : "post",
          async:false,
          url : "serviceTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              		if(data.content != null){
            	 	 if(data.content.serviceTaskList != null){
            	 	 	var xmName = "未知";
            	 	 	var peopleName = "未知";
            	  		jQuery.each(data.content.serviceTaskList, function(i, item) {
            	  			if(item.serviceList[0] != null){
            	  				xmName = item.serviceList[0].name;
            	  			}
            	  			if($("#OlderId_choose").val() != null && $("#OlderId_choose").val() != ""){
            	  				jQuery.each(item.serviceEmployeeList, function(j, item2) {
            	  					if(item2.type == "1"){
            	  						peopleName = item2.name;
            	  					}
            	  				});
            	  			}else{
            	  				peopleName = item.olderName;
            	  			}
            	  			if(item.status == 2){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daifenpei' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 3){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daishenhe' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event yiwancheng' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + peopleName + " " + xmName + "</div></br>";
            	  			}
            	  			tubiao_date += "{\"id\":" + item.id + ",";
            	  			tubiao_date += "\"title\":\"" + peopleName + " " + xmName + "\",";
            	  			tubiao_date += "\"start\":\"" + formateTime(item.serviceExpectTime) + "\",";
            	  			if(item.status == 2){
        	  					tubiao_date += "\"color\":\"#FF9900\",";
        	  				}else if(item.status == 3){
        	  					tubiao_date += "\"color\":\"#5BC0DE\",";
        	  				}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
        	  					tubiao_date += "\"color\":\"#60C060\",";
        	  					tubiao_date += "\"editable\":false,";
        	  				}
            				tubiao_date += "\"textColor\":\"#FFF\",";
            				tubiao_date += "\"allDay\":false}";
            				
            				tubiao_dateArray.push(tubiao_date);
            				tubiao_date = "";
            				xmName = "未知";
            				peopleName = "未知";
            	  		});
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}else{
            	  		$("#external-events").html(externalEvents + html);
            	  		calender(year,month);
            	  	}
            	  }else{
            	  	$("#external-events").html(externalEvents + html);
            	  	calender(year,month);
            	  }
              }else if(data.des=="failure"){
              	 $("#external-events").html("");
              	 calender(year,month);
                 alert("查询失败");
              }
          },
          error:function(){
          	   $("#external-events").html("");
          	   calender(year,month);
	           alert("error");
          }
     });
}

function query_gdlb2() {
	var html = "";
	//var tubiao_date = "";
	
	var userId_login = $("#userId_login").val();
	
	var reqmsg="{'action':'QUERY_SERVICE_TASK_LIST_REQUEST','page':{'pageno':'1','pagesize':'20000000'},'content':{\"serviceListShow\":\"true\",";
	
	reqmsg += "\"status_in\":\"2\",";
	
	reqmsg += "\"source_isNull\":\"null\",";
	
    var OlderId_choose = $("#OlderId_choose").val();
    if (OlderId_choose != null && OlderId_choose != "") {
    	reqmsg += "\"olderId_in\":\"" + OlderId_choose + "\",";
    }
    
	if (userId_login != null && userId_login != "") {
		reqmsg += "\"fzrId\":" + userId_login + ",";
	}
	
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "serviceTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              		if(data.content != null){
            	 	 if(data.content.serviceTaskList != null){
            	  		var xmName = "未知";
            	  		jQuery.each(data.content.serviceTaskList, function(i, item) {
            	  			if(item.serviceList[0] != null){
            	  				xmName = item.serviceList[0].name;
            	  			}
            	  			if(item.status == 2){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daifenpei' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + item.olderName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 3){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event daishenhe' id=\"" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + item.olderName + " " + xmName + "</div></br>";
            	  			}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
            	  				html += "<div onclick=\"openliebiaoTC(" + item.id + ")\" class='external-event yiwancheng' id=\"tongguo-" + item.id + "\">" + formateTime2(item.serviceExpectTime) + " " + item.olderName + " " + xmName + "</div></br>";
            	  			}
            	  			/* tubiao_date += "{\"id\":" + item.id + ",";
            	  			tubiao_date += "\"title\":\"" + item.olderName + " " + xmName + "\",";
            	  			tubiao_date += "\"start\":\"" + formateTime(item.serviceExpectTime) + "\",";
            	  			if(item.status == 2){
        	  					tubiao_date += "\"color\":\"#FF9900\",";
        	  				}else if(item.status == 3){
        	  					tubiao_date += "\"color\":\"#5BC0DE\",";
        	  				}else if(item.status == 4 || item.status == 5 || item.status == 6 || item.status == 7){
        	  					tubiao_date += "\"color\":\"#60C060\",";
        	  					tubiao_date += "\"editable\":false,";
        	  				}
            				tubiao_date += "\"textColor\":\"#FFF\",";
            				tubiao_date += "\"allDay\":false}";
            				
            				tubiao_dateArray.push(tubiao_date);
            				tubiao_date = ""; */
            				xmName = "未知";
            	  		});
            	  		$("#external-events").html(html);
            	  	}else{
            	  		$("#external-events").html(html);
            	  	}
            	  }else{
            	  	$("#external-events").html(html);
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
     
     //return tubiao_date;
}

</script>
	<!-- Bootstrap core JavaScript
================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="js/behaviour/voice-commands.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript"
		src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript"
		src="js/jquery.flot/jquery.flot.labels.js"></script>
</body>
</html>
