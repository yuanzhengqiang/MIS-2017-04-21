<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">

	<title>慢病标签</title>
	
	<link rel="shortcut icon" href="images/logo.png">
	<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />
	<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	<![endif]-->
	<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
  	<link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
  	<link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">
  	<link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
	<link href="css/style.css" rel="stylesheet" />	
	<style>
	.hideAndShow{display:none;}
	.cursor{cursor:pointer;}
	.liclose {
		position: absolute;
	    right: 3px;
	    top: 4px;
	    left:3px;
	    display: block;
	    width: 12px;
	    height: 13px;
	    font-size: 1px;
	    background: url('js/jquery.select2/select2.png') right top no-repeat; 
	    outline: none;
	}
	
	.divHeight {
		height: 150px !important;
		border: 1px solid #aaa;
	}
	
	.btnhide{
		margin-bottom:10px;
		margin-right:5px;
		color:#FFF;
		background-color:#F07E5A; 
		border: none;
	    -moz-border-radius: 5px;      /* Gecko browsers */
	    -webkit-border-radius: 5px;   /* Webkit browsers */
	    border-radius:5px;            /* W3C syntax */
    }
    .libg{background-color:#439FDE;}
    .button-save{
    	margin-left:5px;
    	margin-right:0; 
    	float: right;
    }
    
    .btnList{
    	vertical-align: middle; 
    	height: 34px; 
    	line-height: 34px;
    	margin-bottom:5px;
    }
    
    .selected-tag{
    	vertical-align: middle; 
    	height: 34px; 
    	width:60%; 
    	line-height: 34px;
    	margin-bottom:10px;
    	margin-top:50px;
    }
    
    .margin-b5{
    	margin-bottom:5px; 
    	width:60%;
    }
    
    .pcont{
    	padding-top:0px; 
   		background-color:#fff;
    }
    .margin-t0{margin-top:0px;}
	</style>
</head>
<body style="overflow-y:hidden">
	<div id="cl-wrapper" class="fixed-menu pcont">
	<!-- 页面主体 -->
		<div class="container-fluid pcont">
			<div class="cl-mcont pcont margin-t0">
				<div class="row margin-t0">
					<div class="col-md-12">
		 				 <div class="content">
							  <input type="hidden" id = chronicDiseaseId>
		  					  <input type="hidden" id = parentId>
						  	  <input type="hidden" id = Field>
						      <div class="row margin-t0" style="margin-bottom: 15px;">
								  <div class="col-sm-12 margin-t0"><h3>常用标签</h3></div>
								  <div class="col-sm-12 btnList"></div>
								  <div class="col-sm-12 selected-tag">
								  	  <span style="font-size:24px; margin-right:10px">已选标签</span><lable>提示</lable>
								  </div>
								  <div class="col-sm-12 margin-b5" >
									  <input id="nicknames" class="tags" type="hidden" value="" />
		 						  </div>
		             			  <div class="col-sm-8 margin-b5">
									  <button type="button" class="btn btn-primary button-save" id="saveInfo" onclick="saveInfo()">
				  						  <span>保存</span>
									  </button>
		              			  </div>
		            		  </div>
		          		 </div>
		            </div>
		      	</div>
		    </div>
		    <div id="getHeight"></div>
		</div>
	</div>     
	<div class="md-overlay"></div>

	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
  	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
  	<script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>   
  	<script type="text/javascript" src="js/masonry.js"></script>
  	<script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>
  	<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  	<script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
  	<!-- The basic File Upload plugin -->
  	<script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>
    <script type="text/javascript">
	$(document).ready(function(){	
    	App.init();
    	$(".md-trigger").modalEffects();
    	$(".deleteThisTime").click(function(){               //清除日期框中的值
 	       $(this).parent().prev()[0].value = "";
 		});
    	queryFieldId();//获取标签
    	$(".select2-choices").css("cssText", "height:150px !important;");//设置输入选择框高度
    	reset();
	});
	
	//iframe内嵌页面设置高度
   	function reset() {
 		window.parent.reset();
	}
	
	//获取标签
	function queryFieldId(){
		var name = "manxingbing";
		var reqmsg="{\"action\":\"QUERY_DATA_DIC_LIST_REQUEST\",\"content\":{";
		reqmsg += "\"disease\":\""+name+"\"";
		reqmsg += "}}";
	    jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "systemDataDic.do?queryDisease&disease=" + "manxingbing",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){	
	              	var htmlCode = "";
					if (data.disease != null) {
						var disease = data.disease.split(",");
						for(var i = 0; i < disease.length; i++){
							htmlCode+="<button class=\"btnhide\">" + disease[i] + "</button>";
						}
						$(".btnList").html(htmlCode);
						reset();
						go2page(1);
					}
	              }else if(data.des=="failure"){
	                 alert("获取标签失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}
	
	//点击按钮添加标签
	$(document).on("click", ".btnhide", function() {
         var addtext = $(this).text();
         var add = true;
         $(".select2-choices .select2-search-choice").each(function(index) {
			var divText = $(this).find("div").text();//获取div内容
			if(addtext == divText){
         		alert("标签已添加，请重新选择");
         		add = false;
         		return;
         	}
		});
		if(add){
			var html="";
	        html += "<li class=\"select2-search-choice libg\"><div>" +addtext+ "</div><a href=\"#\" onclick=closeA(this)"; 
	        html += " class=\"liclose\" tabindex=\"-1\"></a></li>";
	        $(".select2-search-field").before(html);
		}
    });
    
    //删除通过选择添加的标签
    function closeA(a){
        var deltext = $(a).prev().text();
        $(".select2-choices .select2-search-choice").each(function(index) {
			var divText = $(this).find("div").text();//获取div内容
			if(deltext == divText){
         		$(a).parent().remove();
         		return;
         	}
		});
    }
    
	//判断手动输入内容
	$(document).on("keyup", function(event) {  
    	if(event.keyCode == "13"){//判断点击回车
             var addtext = $(".select2-choices .select2-search-choice").last().text();
             addtext = $.trim(addtext);//清除左右空格
	         $(".select2-choices .select2-search-choice").last().siblings().each(function(index) {
				var divText = $(this).find("div").text();//获取div内容
				if(addtext == divText){
	         		alert("标签已添加，请重新选择");
	         		return;
	         	}
			 });
	         $(".select2-search-choice-close").attr("onclick","").click( eval(function(){closeA(this);}));
         }
    });
	
	//保存
	function saveInfo(){
		var chronicDisease = new Array();//获取所有已选标签内容
		$(".select2-choices .select2-search-choice").each(function(index) {
			var divText = $(this).find("div").text();//获取div内容
			if(divText){
				chronicDisease[index] = divText;
			}
		});
		var id="<%=request.getAttribute("olderId")%>";
		if(chronicDisease == ""){
			alert("已选标签不能为空");
			return;
		}
		var reqmsg="{\"action\":\"ADD_OLDER_INFO_REQUEST\",\"content\":{";
		if ( id!= null && id != "") { //id
			reqmsg += "\"id\":" + id + ",";
			reqmsg += "\"chronicDisease\":\"" + chronicDisease + "\"";
			reqmsg += "}}";
		    jQuery.ajax({
		        type : "post",
		        async:true,
		        url : "older.do?handler",
		        dataType : "json",
		        data: {
		             "reqmsg":reqmsg
		        },
		        success : function(data){
		            if(data.des=="success"){
		            	$("#chronicDiseaseId").val(data.content.id);
		        		  alert("保存成功");
		        		  $(".select2-choices .select2-search-choice").remove();
		        		  go2page(1);
		        		  chronicDisease = null;
		            }else if(data.des=="failure"){
		               alert("保存失败");
		            }
		        },
		        error:function(){
		          alert("error");
		        }
		    });
		}
	}
	
	//查询信息
	var currentshownpage = 1;
	function go2page(pagenumber){
		var olderId="<%=request.getAttribute("olderId")%>";
		olderId = parseInt(olderId);
		var reqmsg="{\"action\":\"QUERY_OLDER_INFO_REQUEST\",\"content\":{";
		reqmsg += "\"id\":" + olderId + "";
		reqmsg += "}}";

	    jQuery.ajax({
	        type : "post",
	        async:true,
	        url : "older.do?handler",
	        dataType : "json",
	        data: {
	             "reqmsg":reqmsg
	        },
	        success : function(data){
	            if(data.des=="success"){
	          	  changeDatafy(data);
	            }else if(data.des=="failure"){
	               alert("查询失败");
	            }
	        },
	        error:function(){
	          alert("error");
	        }
	    });
	}
	
	function changeDatafy(data){
		if (data.content != null) {
			if(data.content.chronicDisease != ""){
				$("#chronicDiseaseId").val(data.content.chronicDisease);
				var tagArray = data.content.chronicDisease.split(",");
				for(var i = 0; i < tagArray.length; i++){
					var html="";
			        html += "<li class=\"select2-search-choice libg\"><div>" +tagArray[i]+ "</div><a href=\"#\" onclick=closeA(this)"; 
			        html += " class=\"liclose\" tabindex=\"-1\"></a></li>";
			        $(".select2-search-field").before(html);
				}
			}
		}
	}

 	</script>
  	<script src="js/behaviour/voice-commands.js"></script>
  	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
</body>
</html>