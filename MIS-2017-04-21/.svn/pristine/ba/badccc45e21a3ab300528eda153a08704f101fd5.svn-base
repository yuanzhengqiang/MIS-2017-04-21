<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%> 
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="images/logo.png">

    <title>充值/扣款</title>
  
    <!-- Bootstrap core CSS -->
    <link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
	<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
    <![endif]-->
	    <link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />

  <link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
  <link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
	<link rel="stylesheet" type="text/css" href="js/intro.js/introjs.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.datatables/bootstrap-adapter/css/datatables.css" />
	<script type="text/javascript" src="js/sortListTool.js"></script>
  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet" />
  <style type="text/css">
      .timeTip{width:220px;height:80px;background:#f3f9ff;border:2px solid #dadada;z-index:10;}
      .timeTip div{margin:20px 30px}
      .hideAndShow{display:none;}
  </style>
</head>
<body style="opacity: 1; margin-left: 0px;">
	<div style="width: 100%; height: 100%;">
		<div class="container-fluid" style="padding: 0px">
		<!-- 头部开始 -->
			<div class="page-head">
				<h2>充值/扣款</h2>
				<ol class="breadcrumb">
					<li>内部管理</li>
					<input type="hidden" value="" id="sortType">
					<input type="hidden" value="" id="sortColumn">
					<li class="active">充值/扣款</li>
				</ol>
			</div>
		</div>
		<!-- 头部结束 -->

		<div class="cl-mcont">
			<div class="row">
				<div class="col-md-12">
					<div class="block-flat">
				
						<div class="content">
							<div class="table-responsive">
								<div class="dataTables_wrapper form-inline">
								    <!-- 查询框开始 -->
									<div class="row">
										<div class="col-sm-1   " style="text-align: right; vertical-align: middle; height: 34px; line-height: 34px;">
											<label>搜索类型</label>
										</div>
										<div class="col-sm-5   " style="margin-bottom:10px;">
											<select class="form-control" type="text" id="query_type" style="width: 100%" onchange="zhikong()">
												<option value="">全部</option>
												<option value="会员号">会员号</option>
												<option value="会员卡号">会员卡号</option>
												<option value="身份证号">身份证号</option>
											</select>
										</div>
										<div class="col-sm-1" style="text-align: right; vertical-align: middle; height: 34px; line-height: 34px;">
											<label>搜索内容</label>
										</div>
										<div class="col-sm-5" style="margin-bottom:10px;">
											<input class="form-control" type="text" style="width: 100%" id="query_content">
										</div>
									</div>
									<!-- 查询框结束 -->
									<!-- 操作按钮开始 -->
									<div class="row"  style="margin:30px 0px">
										<div class="col-sm-12">
											<c:if test="${rechargeDebit_query_btn_control != 'yes' or rechargeDebit_query_btn_show == 'yes'}">
												<button class="btn btn-primary" style="margin-bottom: 0px !important; height: 34px;margin-left:0;" onclick="query()">查询</button>
										    </c:if>
										    <c:if test="${rechargeDebit_query_btn_control != 'yes' or rechargeDebit_query_btn_show == 'yes'}">
												<button class="btn btn-primary" style="margin-bottom: 0px !important; height: 34px;margin-left:10px;" onclick="recharge_click()">充值</button>
										    </c:if>
										    <c:if test="${rechargeDebit_query_btn_control != 'yes' or rechargeDebit_query_btn_show == 'yes'}">
												<button class="btn btn-primary" style="margin-bottom: 0px !important; height: 34px;margin-left:10px;" onclick="debit_click()">扣款</button>
										    </c:if>
										</div>
									</div>
									<!-- 操作按钮结束 -->
                                    <!-- 数据表格开始 -->
                                    <div class="row" style=" padding-top:30px" id="content_body_null">
                                    	
                                    </div>
									<div class="row" style=" padding-top:30px" id="content_body">
										 <input type="hidden" value="0" id="olderId_hide">
										 <div class="col-sm-4">
											<label class="col-sm-4" for="nick"   style="vertical-align:middle; height:250px; line-height:250px">头像</label>
											<div class="col-sm-8"> 
									  			<div class="avatar-upload" style="height:250px;width:250px">
													<img src="###" id="touxiangId" style="height:250px;width:250px" class="profile-avatar img-thumbnail"/>
									  			</div>
											</div>
								 		</div>
								 		<div class="col-sm-4">
									 		<div class="col-sm-12" style="margin:40px 0px">
									  			<label class="col-sm-4" >姓名</label>
									  			<div class="col-sm-8">
													<input type="text" class="form-control" id="name_input" readonly="readonly">
									  			</div>
											</div>
											<div class="col-sm-12" style="margin-top:30px">
									  			<label class="col-sm-4">身份证号</label>
									  			<div class="col-sm-8">
													<input type="text" class="form-control" id="idNumber_input" readonly="readonly">
									  			</div>
											</div>
										</div>
										<div class="col-sm-4">
											<div class="col-sm-12" style="margin:40px 0px">
									  			<label class="col-sm-4" >会员号</label>
									  			<div class="col-sm-8">
													<input type="text" class="form-control" id="memberNum_input" readonly="readonly">
									  			</div>
											</div>
											<div class="col-sm-12"  style="margin-top:30px">
									  			<label class="col-sm-4">账户余额</label>
									  			<div class="col-sm-8">
													<input type="text" class="form-control" id="zhanghuYE_input" readonly="readonly">
									  			</div>
											</div>
										</div>
									</div>
									<!-- 数据表格结束 -->
								   
								</div>
							</div>
						</div>
					</div>
				</div>				
			</div>
		</div>
	</div>
	
	<input type="hidden" value="0" id="olderId_hide">
	
	<input type="hidden" class="md-trigger" data-modal="recharge" value="金额充值弹出框" id="recharge_hide">
	<div class="md-modal md-effect-9" id="recharge" >
                    <div class="md-content">
                      <div class="modal-body form">
                        <div class="row ">
                          <label class="form-group col-md-2 col-sm-3  col-xs-3 ">
                          		金额
                          </label>
                          <div class="form-group col-md-10 col-sm-9  col-xs-9 ">
                          	  <input class="form-control" type="text"id="moneyrecharge_input" onpaste="return false;" onkeypress="keyPress()">
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer" style="text-align:center;">
                        <button type="button" class="btn btn-success btn-flat" data-dismiss="modal" onclick="save_recharge()">确定</button>
                        <button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal" id="close_recharge">关 闭</button>
                      </div>
                    </div>
     </div>
     
     <input type="hidden" class="md-trigger" data-modal="debit" value="金额扣款弹出框" id="debit_hide">
	 <div class="md-modal md-effect-9" id="debit" >
                    <div class="md-content">
                      <div class="modal-body form">
                        <div class="row ">
                          <label class="form-group col-md-2 col-sm-3  col-xs-3 ">
                          		金额
                          </label>
                          <div class="form-group col-md-10 col-sm-9  col-xs-9 ">
                          	  <input class="form-control" type="text"id="moneydebit_input" onpaste="return false;" onkeypress="keyPress()">
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer" style="text-align:center;">
                        <button type="button" class="btn btn-success btn-flat" data-dismiss="modal" onclick="save_debit()">确定</button>
                        <button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal" id="close_debit">关 闭</button>
                      </div>
                    </div>
     </div>
	
	<!-- Nifty Modal -->

	<div class="md-overlay"></div> <!-- Nifty Modal的遮罩层-->
<script type="text/javascript" src="js/addressJS.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
<script type="text/javascript" src="js/behaviour/general.js"></script>
<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
<script src="js/skycons/skycons.js" type="text/javascript"></script>
<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
<script src="js/intro.js/intro.js" type="text/javascript"></script> 
<script src="js/behaviour/voice-commands.js"></script>
<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
<script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>
<script type="text/javascript" src="js/jquery.form.js"></script>
<script type="text/javascript">
		//只能输入数字0-9
        function keyPress() {
            var theEvent = window.event || arguments.callee.caller.arguments[0];
    		var keyCode = theEvent.keyCode || theEvent.which;
    		if ((keyCode < 48 || keyCode > 57) && keyCode != 8 && keyCode != 37 && keyCode != 39) {
               theEvent.preventDefault();
            }
        } 
        
$(document).ready(function(){

    App.init();
    $(".md-trigger").modalEffects();
	
	$("#content_body").hide();
});

function zhikong(){
	$("#query_content").val("");
}

function query() {
	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'1','pagesize':'1'},'content':{";
	
	var query_type = $("#query_type").val();
	var query_content = $.trim($("#query_content").val());
	if(query_type == null || query_type == ""){
		alert("请选择搜索类型");
		return;
	}else{
		if(query_type == "会员号"){
			if(query_content != null && query_content != ""){
				reqmsg += "\"memberNum\":\"" + query_content + "\",";
			}else{
				alert("请填写会员号");
				return;
			}
		}
		if(query_type == "会员卡号"){
			if(query_content != null && query_content != ""){
				reqmsg += "\"memberCard\":\"" + query_content + "\",";
			}else{
				alert("请填写会员卡号");
				return;
			}
		}
		if(query_type == "身份证号"){
			if(query_content != null && query_content != ""){
				reqmsg += "\"idnumber\":\"" + query_content + "\",";
			}else{
				alert("请填写身份证号");
				return;
			}
		}	
	}
	
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:true,
          url : "older.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  changeData(data);
              }else if(data.des=="failure"){
              	 $("#olderId_hide").val("0");
				 $("#touxiangId").attr("src","###");
				 $("#name_input").val("");
				 $("#memberNum_input").val("");
				 $("#idNumber_input").val("");
				 $("#zhanghuYE_input").val("");
				 $("#content_body_null").html("不存在该会员！");
				 $("#content_body_null").show();
	   			 $("#content_body").hide();
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}

function changeData(data){
	var htmlcode = "";
	if (data.content != null) {
	   if(data.content.olderList != null){
	   		jQuery.each(data.content.olderList, function(i, item) {
	   			$("#olderId_hide").val(item.id);
	   			$("#touxiangId").attr("src",item.mainPhoto + "?random=" + Math.random());
	   			$("#name_input").val(item.name);
	   			$("#memberNum_input").val(item.memberNum);
	   			$("#idNumber_input").val(item.idnumber);
	   			$("#zhanghuYE_input").val(item.accountNum);
	   		});
	   		
	   		$("#content_body_null").hide();
	   		$("#content_body").show();
	   }else{
	   		$("#olderId_hide").val("0");
			$("#touxiangId").attr("src","###");
			$("#name_input").val("");
			$("#memberNum_input").val("");
			$("#idNumber_input").val("");
			$("#zhanghuYE_input").val("");
			$("#content_body_null").html("不存在该会员！");
			$("#content_body_null").show();
	   		$("#content_body").hide();
	   }
	}else{
		$("#olderId_hide").val("0");
		$("#touxiangId").attr("src","###");
		$("#name_input").val("");
		$("#memberNum_input").val("");
		$("#idNumber_input").val("");
		$("#zhanghuYE_input").val("");
		$("#content_body_null").html("不存在该会员！");
		$("#content_body_null").show();
	   	$("#content_body").hide();
	}
}

//充值
function recharge_click(){
	$("#moneyrecharge_input").val("");
	var userId_login = "<%=request.getAttribute("userId")%>";
	if(userId_login == null || userId_login == "" || userId_login == "1"){
		alert("当前非员工，无法操作");
		return;
	}
	var olderId = $("#olderId_hide").val();
	if(olderId == null || olderId == "" || olderId == "0"){
		alert("请先选择老人");
		return;
	}
	$("#recharge_hide").click();
}
function save_recharge(){
	var olderId = $("#olderId_hide").val();
	
	var moneyrecharge_input = $("#moneyrecharge_input").val();
	var reg1 = new RegExp("^(0|[1-9][0-9]*)$"); 
	if(moneyrecharge_input == "" || moneyrecharge_input == null){
		alert("请填写充值金额");
		return;
	}else{
		if(!reg1.test(moneyrecharge_input)){
			alert("请填写整数");
			return;
		}
	}
	
	var reqmsg="{'action':'ADD_OLDER_INFO_REQUEST','content':{";
	reqmsg += "\"id\":" + olderId + ",";
	reqmsg += "\"accountNumType\":\"add\",";
	reqmsg += "\"accountNum\":" + moneyrecharge_input + ",";
	reqmsg += "}}";

	jQuery.ajax({
          type : "post",
          async:true,
          url : "addOlders.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.result=="100"){
              	 query();
              	 alert("充值成功");
              	 $("#close_recharge").click();
              }else{
                 alert("充值失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}

//扣款
function debit_click(){
	$("#moneydebit_input").val("");
	var userId_login = "<%=request.getAttribute("userId")%>";
	if(userId_login == null || userId_login == "" || userId_login == "1"){
		alert("当前非员工，无法操作");
		return;
	}
	var olderId = $("#olderId_hide").val();
	if(olderId == null || olderId == "" || olderId == "0"){
		alert("请先选择老人");
		return;
	}
	$("#debit_hide").click();
}
function save_debit(){
	var olderId = $("#olderId_hide").val();
	
	var moneydebit_input = $("#moneydebit_input").val();
	var reg1 = new RegExp("^(0|[1-9][0-9]*)$"); 
	if(moneydebit_input == "" || moneydebit_input == null){
		alert("请填写扣款金额");
		return;
	}else{
		if(!reg1.test(moneydebit_input)){
			alert("请填写整数");
			return;
		}
	}
	/*if(parseInt(moneydebit_input) > parseInt(accountNum)){
		alert("扣款金额大于账户余额,请充值后再扣款");
	}*/
	
	var reqmsg="{'action':'ADD_OLDER_INFO_REQUEST','content':{";
	reqmsg += "\"id\":" + olderId + ",";
	reqmsg += "\"accountNumType\":\"del\",";
	reqmsg += "\"accountNum\":" + moneydebit_input + ",";
	reqmsg += "}}";

	jQuery.ajax({
          type : "post",
          async:true,
          url : "addOlders.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.result=="100"){
              	 query();
              	 alert("扣款成功");
              	 $("#close_debit").click();
              }else{
                 alert("扣款失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}

</script>
  </body>
</html>