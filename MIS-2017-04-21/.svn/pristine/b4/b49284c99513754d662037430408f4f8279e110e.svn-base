<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%> 
<%@ page import="fsk.init.SystemInit" %>
<%
	String nickname = (String) session.getAttribute("nickname");
	if (nickname == null) {
		nickname = "";
	}
	String header = SystemInit.header;
	String headerImage = SystemInit.headerImage;
%>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="images/logo.png">

	<title>健康评估任务新增</title>

	<!-- Bootstrap core CSS -->
	<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />

	<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	<![endif]-->
	<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
  <link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
  <link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">

  <link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
	<link href="css/style.css" rel="stylesheet" />	
<style>
.hideAndShow{display:none;}
.hideul{position:absolute;top:33px;z-index:200;right:15px;left:15px;display:none}
.hideul ul{ border:1px solid #ccc;width:100%;background:#f4f4f4;padding-left:0}
.hideul ul li{ list-style-type:none;text-indent:20px}
.hideul ul li:hover{ background:#ddd}
textarea{resize:vertical}

</style>
<script type="text/javascript" src="js/addressJS.js"></script>
</head>

<body>
<!-- 上侧栏开始 -->
<div class="navbar-fixed-top">
	<div class="navbar navbar-default" style="margin-bottom: 0;">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="fa fa-gear"></span>
          </button>
          <a class="navbar-brand" href="#"  style="width:auto;background: url(images/<%=headerImage %>) no-repeat 0 10px;"><span><%=header %>/健康评估任务新增</span></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right user-nav">
            <li class="dropdown profile_menu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <img src="images/avatar2.jpg"/>
                <span id="accountNickname"><%=nickname %></span>
<!--                 <b class="caret"></b> -->
              </a>
<!--               <ul class="dropdown-menu"> -->
<!--                 <li><a href="#" class="md-trigger" data-modal="md-scale3">密码修改</a></li> -->
<!--                 <li class="divider"></li> -->
<!--                 <li><a href="systemLogin.do?logout">退出登录</a></li> -->
<!--               </ul> -->
            </li>
          </ul>
        </div><!--/.nav-collapse animate-collapse -->
      </div>
    </div>  <!-- 上侧栏结束 -->
	<div id="head-nav" class=""> 
        <div class="block-flat" >
          <div class="row">
            <div class="page-head col-xs-6" style="padding-bottom:0;padding-top:0;border:0;">
				<h3>健康评估任务新增</h3>
				<ol class="breadcrumb">
					<li >健康管理</li>
					<li class="active">健康评估任务新增</li>
				</ol>
			</div>
            <div class="col-xs-6" style="text-align:right;padding-top:25px">
		 		<button class="btn btn-primary  " onclick="save()">确定</button>	
            </div>
          </div>
        </div>
	</div>
</div>
<div id="cl-wrapper1" style="overflow:hidden;margin-bottom: 0px;padding-top:180px">
	<div class="cl-mcont" >
	<div class="block-flat">
   
         <div class="row">
					<div class=" col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						 <strong>老人姓名</strong>
						 <input type="hidden" value="" id="oldinputId">
					</div>
					<div class=" col-xs-8 col-sm-4 col-md-4 col-lg-2" style="position:relative">
						<div class="input-group " >
							<input class="form-control"  type="text" id="oldinput_search" onclick="getolderName()" oninput="getolderName()" onmouseout="javascript:$('#hideul-1').hide();" onmouseover="javascript:$('#hideul-1').show();">
							<span class="input-group-btn"><button class="btn btn-primary " type="button"><span class="fa fa-search"></span></button></span>
						</div>
						<div class="hideul" id="hideul-1"  onmouseover="javascript:$('#hideul-1').show();" onmouseout="javascript:$('#hideul-1').hide();">
							<ul id="hideul_nei1">
							
							</ul>
						</div>
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						<strong>评估人</strong> 
						<input type="hidden" value="" id="pgrinputId">
					</div>
					<div class=" col-xs-8 col-sm-4 col-md-4 col-lg-2" style="position:relative">
						<div class="input-group " >
							<input class="form-control"  type="text" id="pgrinput_search" onclick="getepgrName()" oninput="getepgrName()" onmouseout="javascript:$('#hideul-2').hide();" onmouseover="javascript:$('#hideul-2').show();">
							<span class="input-group-btn"><button class="btn btn-primary " type="button"><span class="fa fa-search"></span></button></span>
						</div>
						<div class="hideul" id="hideul-2"  onmouseover="javascript:$('#hideul-2').show();" onmouseout="javascript:$('#hideul-2').hide();">
							<ul id="hideul_nei2">
							
							</ul>
						</div>
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						 <strong>分配人</strong> 
						 <input type="hidden" value="" id="fprinputId">
						 <input type="hidden" value="" id="fprinputName">
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:20px; padding-top:6px" id ="fpr_input">
								无						  
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						<strong>期望完成时间</strong>
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:20px;">
						<div class="input-group date datetime" data-min-view="2" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
							<span class="input-group-addon btn btn-primary"><span class="glyphicon glyphicon-th"></span></span>
							<input class="form-control" size="16" value="" readonly="" type="text" id="qwwcsj_input" >
							<span class="input-group-btn"><button class="btn btn-danger deleteThisTime" type="button"><span class="fa fa-times"></span></button></span>
						</div>
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						 <strong>健康评估类型</strong>
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:10px;">
						<select class="form-control" id="pglx_input" >
						<option value="1">康复评估</option><option value="2">护理评估</option><option value="3">混合健康评估</option>
						</select>
								  
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						 <strong>任务状态</strong>
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:25px; padding-top:6px">
						   待评估
								  
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						 <strong>健康评估状态</strong>
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:25px; padding-top:6px">
						 未完成
								  
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						<strong>审核通过时间</strong>
					</div>
					<div class="col-xs-8 col-sm-4 col-md-4 col-lg-2" style="margin-bottom:25px; padding-top:6px">
						无
								  
					</div>
					<div class="col-xs-4 col-sm-2 col-md-2 col-lg-1" style="padding-top:6px">
						<strong>备注</strong>
					</div>
					<div class="col-xs-8 col-sm-10 col-md-10 col-lg-11" style="margin-bottom:20px; ">
					<textarea class="form-control" id="beizhu_input"></textarea>
								  
					</div>
				</div>   
     
</div>

	</div>
</div> <!-- 主页面结束 -->

  <!-- 模态框开始-->
       
		 <div class="md-overlay" style="z-index:1050"></div>


	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
  <script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
  <script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>   
  <script type="text/javascript" src="js/masonry.js"></script>
  <script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>

  <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  <script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
  <!-- The basic File Upload plugin -->
  <script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>
<script type="text/javascript" src="js/highcharts.js"></script>

    <script type="text/javascript">
     
      $(document).ready(function(){
    	var homeUrl = "<%=request.getContextPath()%>" + "/welcome.do?main";
		$(".navbar-brand").attr("href",homeUrl);
        
        //获取老人id，老人页面跳转过来，新增健康评估任务，带上老人id
        var olderId = "<%=request.getAttribute("olderId")%>";
        if(olderId != null && olderId != "" && olderId != "null"){
        	$("#oldinputId").val(olderId);
        	var name = getOlderJBXX(olderId);
        	$("#oldinput_search").val(name);
        }
        
        getLoginName();
    	$(".deleteThisTime").click(function(){               //清除日期框中的值
    	       $(this).parent().prev()[0].value = "";
    	    });
        App.init();

		
	  });
      
    //获取当前登陆员工姓名
	function getLoginName(){
    	  var userId_login = "<%=request.getAttribute("userId")%>";
		  var reqmsg="{'action':'QUERY_EMPLOYEE_LIST_REQUEST','page':{'pageno':'1','pagesize':'1'},'content':{\"userId\":"+userId_login+"}}";
		  var name="";
		  jQuery.ajax({
          type : "post",
          async:false,
          url : "employee.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if (data.content != null) {
            	  	if(data.content.employeeList != null && data.content.employeeList.length == 1){
            	  	   $("#fprinputId").val(data.content.employeeList[0].id);
            	  	   $("#fprinputName").val(data.content.employeeList[0].name);
            	  	   $("#fpr_input").html(data.content.employeeList[0].name);
            	  	}else{
            	  	   $("#fprinputId").val("");
            	  	   $("#fprinputName").val("当前用户非员工");
            	  	   $("#fpr_input").html("当前用户非员工");
            	  	}
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     	  });
	}

//实时获取老人姓名
function getolderName(){
	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
	var name = $("#oldinput_search").val();
	if (name != null && name != "") {
		reqmsg += "\"name_like\":\"" + name + "\"";
	}else{
		$("#hideul_nei1").html("");
		$("#hideul-1").hide();
		return;
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "older.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	  var htmlcode = "";
              	  if(data.content != null){
              	  	 if(data.content.olderList != null){
            	  		jQuery.each(data.content.olderList, function(i, item) {
            	  				if(item != null){
		    						htmlcode += "<li onclick=\"olderNamefuzhi('" + item.name + "'," + item.id + ")\">" + item.name + "</li>";		
            	  				}	
		    	  		});
		    	 	 }
		    	  }
		    	  $("#hideul_nei1").html(htmlcode);
		    	  $("#hideul-1").show();
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}
//老人姓名赋值
function olderNamefuzhi(name,id){
	$("#oldinputId").val(id);
	$("#oldinput_search").val(name);
	$("#hideul_nei1").html("");
	$("#hideul-1").hide();
}
//实时获取评估人姓名
function getepgrName(){
	var reqmsg="{'action':'QUERY_EMPLOYEE_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
	var name = $("#pgrinput_search").val();
	if (name != null && name != "") {
		reqmsg += "\"name_like\":\"" + name + "\"";
	}else{
		$("#hideul_nei2").html("");
		$("#hideul-2").hide();
		return;
	}
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:false,
          url : "employee.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	  var htmlcode = "";
              	  if(data.content != null){
              	  	 if(data.content.employeeList != null){
            	  		jQuery.each(data.content.employeeList, function(i, item) {
            	  				if(item != null){
		    						htmlcode += "<li onclick=\"pgrNamefuzhi('" + item.name + "'," + item.id + ")\">" + item.name + "</li>";		
            	  				}	
		    	  		});
		    	 	 }
		    	  }
		    	  $("#hideul_nei2").html(htmlcode);
		    	  $("#hideul-2").show();
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}
//评估人姓名赋值
function pgrNamefuzhi(name,id){
	$("#pgrinputId").val(id);
	$("#pgrinput_search").val(name);
	$("#hideul_nei2").html("");
	$("#hideul-2").hide();
}
//获取当前时间return yyyymmddhhmmss
function getNowFormatDate() {
    var date = new Date();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    var strHour = date.getHours();
    var strMinutes = date.getMinutes();
    var strSeconds = date.getSeconds();
    
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    if (strHour >= 0 && strHour <= 9) {
        strHour = "0" + strHour;
    }
    if (strMinutes >= 0 && strMinutes <= 9) {
        strMinutes = "0" + strMinutes;
    }
    if (strSeconds >= 0 && strSeconds <= 9) {
        strSeconds = "0" + strSeconds;
    }
    var currentdate = date.getFullYear() + "" + month + "" + strDate + "" + strHour + "" + strMinutes + "" + strSeconds;
    return currentdate;
}
//保存健康评估任务
function save(){
	var oldinputId = $("#oldinputId").val();
	var pgrinputId = $("#pgrinputId").val();
	var fprinputId = $("#fprinputId").val();
	var oldinput_search = $("#oldinput_search").val();
	var pgrinput_search = $("#pgrinput_search").val();
	var fpr_input = $("#fprinputName").val();
	if(oldinputId == null || oldinputId == ""){
		alert("请选择老人");
		return;
	}
	if(pgrinputId == null || pgrinputId == ""){
		alert("请选择评估人");
		return;
	}
	if(fprinputId == null || fprinputId == ""){
		alert("当前分配人(用户)非员工，无法操作");
		return;
	}
	var qwwcsj_input = $("#qwwcsj_input").val();
	if(qwwcsj_input == null || qwwcsj_input == ""){
		alert("请选择期望完成时间");
		return;
	}

	var pglx_input = $("#pglx_input").val();
	var beizhu_input = $("#beizhu_input").val();
	if (beizhu_input != null && beizhu_input != "") {
		beizhu_input = JSON.stringify(beizhu_input);
		if(beizhu_input.length > 500){
			alert("备注最大字数超出限制500字");
			return;
		}
	}
	
	var reqmsg="{'action':'ADD_ASSESSMENT_TASK_INFO_REQUEST','content':{";
	
	if (oldinputId != null && oldinputId != "") {
		reqmsg += "\"olderId\":" + oldinputId + ",";
	}
	if (oldinput_search != null && oldinput_search != "") {
		reqmsg += "\"olderName\":\"" + oldinput_search + "\",";
	}
	if (pgrinputId != null && pgrinputId != "") {
		reqmsg += "\"assessmentEmployeeId\":" + pgrinputId + ",";
	}
	if (pgrinput_search != null && pgrinput_search != "") {
		reqmsg += "\"assessmentName\":\"" + pgrinput_search + "\",";
	}
	if (fprinputId != null && fprinputId != "") {
		reqmsg += "\"distributeEmployeeId\":" + fprinputId + ",";
	}
	if (fpr_input != null && fpr_input != "") {
		reqmsg += "\"distributeName\":\"" + fpr_input + "\",";
	}
	if (qwwcsj_input != null && qwwcsj_input != "") {
		var nowtime = getNowFormatDate();
		qwwcsj_input = qwwcsj_input.substring(0, 4) + qwwcsj_input.substring(5, 7) + qwwcsj_input.substring(8, 10);
		if(nowtime.substr(0,nowtime.length-6) > qwwcsj_input){
			alert("期望完成时间小于当前时间");
		}
		qwwcsj_input = qwwcsj_input + "000000";
		reqmsg += "\"expectedCompletionTime\":\"" + qwwcsj_input + "\",";
	}
	
	if (beizhu_input != null && beizhu_input != "") {
		reqmsg += "\"des\":" + beizhu_input + ",";
	}else{
		reqmsg += "\"des\":\"\",";
	}
	reqmsg += "\"distributeTime\":\"" + getNowFormatDate() + "\",";
	if (pglx_input != null && pglx_input != "") {
		reqmsg += "\"healthAssessmentType\":" + pglx_input+ ",";
	}
	reqmsg += "\"healthAssessmentStatus\":1,";
	reqmsg += "\"taskStatus\":1,";
	
	reqmsg += "\"healthAssessment\":{";
	if (oldinputId != null && oldinputId != "") {
		reqmsg += "\"olderId\":" + oldinputId + ",";
	}
    if (pgrinputId != null && pgrinputId != "") {
        reqmsg += "\"employeeId\":" + pgrinputId + ",";
	}
    if (pglx_input != null && pglx_input != "") {
       	reqmsg += "\"type\":" + pglx_input + ",";
	}
    reqmsg += "\"status\":1,";
	reqmsg += "\"taskStatus\":1";
	reqmsg += "},";
	
	reqmsg += "\"assessmentLogList\":[{";
	reqmsg += "\"type\":1,";
	reqmsg += "\"createTime\":\"" + getNowFormatDate() + "\",";
	if (beizhu_input != null && beizhu_input != "") {
		reqmsg += "\"des\":" + beizhu_input + ",";
	}else{
		reqmsg += "\"des\":\"\",";
	}
	if (fpr_input != null && fpr_input != "") {
		reqmsg += "\"personName\":\"" + fpr_input + "\",";
	}
	reqmsg += "}],";
	
	reqmsg += "}}";

    jQuery.ajax({
          type : "post",
          async:true,
          url : "assessmentTask.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
              	 alert("新增成功");
              	 var id=data.content.id;
              	 var path="<%=request.getContextPath()%>";
              	 var url=path+"/assessmentTask.do?mainDetails&id="+id;
              	 window.location.replace(url);
              }else if(data.des=="failure"){
                 alert("新增失败");
              }
          },
          error:function(){
	           alert("error");
          }
     });
}

//获取老人姓名初始化
function getOlderJBXX(olderId){
	var name = "";
	var reqmsg="{'action':'QUERY_OLDER_INFO_REQUEST','content':{\"id\":"+olderId+"}}";
		  jQuery.ajax({
          type : "post",
          async:false,
          url : "daeOlder.do?handler",
          dataType : "json",
          data: {
               "reqmsg":reqmsg
          },
          success : function(data){
              if(data.des=="success"){
            	  if(data.content != null){
            	  	  name = data.content.name;
            	  }
              }else if(data.des=="failure"){
                 alert("查询失败");
              }
          },
          error:function(){
	           alert("error");
          }
    });
    return name;
}
    </script>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
  <script src="js/behaviour/voice-commands.js"></script>
  <script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
<script type="text/javascript" src="js/jquery.form.js"></script>
</body>
</html>
