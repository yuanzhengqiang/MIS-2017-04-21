<%@ page contentType="text/html;charset=UTF-8" language="java"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ page import="fsk.init.SystemInit" %>
<%
	String nickname = (String) session.getAttribute("nickname");
	if (nickname == null) {
		nickname = "";
	}
	String roleId=request.getParameter("roleIds");
	if(roleId == null){
		roleId="";
	}
	String header = SystemInit.header;
	String headerImage = SystemInit.headerImage;
%>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="images/logo.png">
	<title>微信会员详情</title>
	<!-- Bootstrap core CSS -->
	<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />
	<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	<![endif]-->
	<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
	<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
    <link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
    <link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">
    <link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
	<link href="css/style.css" rel="stylesheet" />	
	<link rel="stylesheet" type="text/css" href="js/jquery.datatables/bootstrap-adapter/css/datatables.css" />
	<script type="text/javascript" src="js/sortListTool.js"></script>	
	<style>
		.hideul{position:absolute;top:33px;z-index:200;right:15px;left:15px;display:none}
		.hideul ul{ border:1px solid #ccc;width:100%;background:#f4f4f4;padding-left:0}
		.hideul ul li{ list-style-type:none;text-indent:20px}
		.hideul ul li:hover{ background:#ddd}
	</style>
</head>
<body>
	<!-- 上侧栏开始 -->
	<div id="head-nav" class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="fa fa-gear"></span>
				</button>
				<a class="navbar-brand" href="#" style="width:auto;background: url(images/<%=headerImage %>) no-repeat 0 10px;">
					<span><%=header %>/微信会员详情</span></a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav navbar-right user-nav">
					<li class="dropdown profile_menu">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">
							<img src="images/avatar2.jpg" />
							<span id="accountNickname"><%=nickname %></span>
						</a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!-- 上侧栏结束 -->
	<div id="cl-wrapper" style="padding-top:40px;">
		<div class="container-fluid" id="pcont">
			<div class="cl-mcont">
				<div class="row">
					<div class="col-sm-12">
						<div class="block-flat profile-info">
							<div class="row">
								<div class="col-sm-3">
									<div class="avatar"><img src="photos/av.jpg" id="photoUrl" class="profile-avatar" /></div>
								</div>
								<div class="col-sm-9">
									<div class="personal">
										<p style="font-size:20px;margin-top:30px" id="openid">openid<p>
										<p style="font-size:20px;" id="nickname">昵称<p>
										<p style="font-size:16px" id="gender">性别/国家-省-市<p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row" style="margin-top:0">
					<div class="col-sm-12">
						<div class="tab-container">
							<ul class="nav nav-tabs">
								<li class="active">
									<a data-toggle="tab" href="#tab111">历史服务</a></li>
								<li>
									<a data-toggle="tab" href="#tab222">关联老人</a></li>
							</ul>
							<div class="tab-content">
								<div id="tab111" class="tab-pane  cont active">
									<!-- 历史服务 -->
									<input type="hidden" value="" id="sortType">
									<input type="hidden" value="" id="sortColumn">
									<div class="row">
										<div class="col-sm-2 " style=" vertical-align: middle; height: 34px; line-height: 34px;">
											<label>工单编号</label></div>
										<div class="col-sm-4 " style="margin-bottom:10px;">
											<input class="form-control" type="text" style="width: 100%" id="fuwugdbh_input"></div>
										<div class="col-sm-2 " style=" vertical-align: middle; height: 34px; line-height: 34px;">
											<label>服务项目</label></div>
										<div class="col-sm-4 " style="position:relative">
											<div class="input-group ">
												<input type="hidden" value="" id="fwxminput_Id">
												<input class="form-control" type="text" id="fwxminput_search" onclick="getFWXM()" 
													oninput="getFWXM()" onmouseout="javascript:$('#hideul-2').hide();" 
													onmouseover="javascript:$('#hideul-2').show();" >
												<span class="input-group-btn">
													<button class="btn btn-primary " type="button">
														<span class="fa fa-search"></span>
													</button>
												</span>
											</div>
											<div class="hideul" id="hideul-2" onmouseover="javascript:$('#hideul-2').show();" onmouseout="javascript:$('#hideul-2').hide();">
												<ul id="hideul_nei2"></ul>
											</div>
										</div>
										<div class="col-sm-2  col-md-2 " style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>服务状态</label></div>
										<div class="col-sm-4 col-md-4 " style="margin-bottom:10px;">
											<select id="fuwustate_input" class="select2" multiple>
												<option value="8">已下单</option>
												<option value="1">已取消</option>
												<option value="4">审核通过</option>
												<option value="5">服务开始</option>
												<option value="6">服务结束</option>
												<option value="7">回访结束</option></select>
										</div>
										<!-- 查询框结束 -->
										<!-- 操作按钮开始 -->
										<div class="col-sm-12" style="margin:10px 0">
											<button class="btn btn-primary" style="height: 34px;margin-left:0;" onclick="go2page1(1)">查询</button></div>
										<!-- 操作按钮结束 -->
										<!-- 数据表格开始 -->
										<div class="col-sm-12">
											<table class="table table-bordered dataTable hover" id="datatable" aria-describedby="datatable_info">
												<thead>
													<tr role="row">
														<th name="needSort" class="sorting" onclick="queryBySort(this,'serviceCode')">
															<strong>服务工单编号</strong></th>
														<th>
															<strong>服务项目</strong></th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'olderName')">
															<strong>老人</strong></th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'price')">
															<strong>价格</strong></th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'status')">
															<strong>状态</strong></th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'serviceExpectTime')">
															<strong>预计服务时间</strong></th>
														<th name="needSort" class="sorting" onclick="queryBySort(this,'serviceEndTime')">
															<strong>结束服务时间</strong></th>
														<th>
															<strong>操作</strong></th>
													</tr>
												</thead>
												<tbody id="datacontainer1" ></tbody>
											</table>
										</div>
									</div>
									<!-- 数据表格结束 -- <!-- 数据条数提示开始 -->
									<div class="row">
										<div class="col-sm-12">
											<div class="pull-left">
												<div id="datatable_info1" class="dataTables_info">当前显示0 条总记录中的第0-0条</div></div>
											<div class="clearfix"></div>
										</div>
									</div>
									<!-- 数据条数提示结束 -->
									<!-- 分页条开始 -->
									<div class="row">
										<div class="col-sm-4">
											<div class="dataTables_length" id="">
												<label style="margin-top:18px;">每页
													<select id="pageSizeSelector1" size="1" onchange="go2page1(1)">
														<option selected="selected" value="10">10</option>
														<option value="25">25</option>
														<option value="50">50</option>
														<option value="100">100</option></select>条</label>
											</div>
										</div>
										<div class="col-sm-8">
											<div class="pull-right">
												<div class="dataTables_paginate paging_bs_normal">
													<ul id="paginationArea1" class="pagination"></ul>
												</div>
											</div>
										</div>
									</div>
									<!-- 分页条结束 -->
								</div>
								<div id="tab222" class="tab-pane">
									<!-- 关联老人 -->
									<div class="row">
										<div class="col-sm-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>老人姓名</label></div>
										<div class="col-sm-4" style="margin-bottom:10px;">
											<input class="form-control" type="text" id="older_name"></div>
										<div class="col-sm-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
											<label>会员号</label>
											<input type="hidden" id="condition5" value=""></div>
										<div class="col-sm-4 " style="position:relative">
											<div class="input-group ">
												<input class="form-control" type="text" id="condition4" onclick="getolderName()" oninput="getolderName()">
												<span class="input-group-btn">
													<button class="btn btn-primary " type="button" style="height:34px">
														<span class="fa fa-search"></span>
													</button>
												</span>
											</div>
											<div class="hideul" id="hideul-1" onmouseover="javascript:$('#hideul-1').show();" onmouseout="javascript:$('#hideul-1').hide();">
												<ul id="hideul_nei1"></ul>
											</div>
										</div>
									</div>
									<!-- 查询框结束 -->
									<!-- 操作按钮开始 -->
									<div class="row">
										<div class="col-sm-12">
											<button class="btn btn-primary" style="height: 34px;margin-left:0;" onclick="go2page2(1);">查询</button></div>
									</div>
									<!-- 操作按钮结束 -->
									<!-- 数据表格开始 -->
									<div class="row">
										<div class="col-sm-12">
											<table class="table table-bordered dataTable hover" id="datatable" aria-describedby="datatable_info">
												<thead>
													<tr role="row">
														<th>
															<strong>会员号</strong></th>
														<th>
															<strong>会员卡号</strong></th>
														<th>
															<strong>姓名</strong></th>
														<th>
															<strong>性别</strong></th>
														<th>
															<strong>年龄</strong></th>
														<th>
															<strong>客户来源</strong></th>
														<th>
															<strong>服务站点</strong></th>
														<th>
															<strong>联系方式(固话/手机)</strong></th>
														<th>
															<strong>操作</strong></th>
													</tr>
												</thead>
												<tbody id="datacontainer2" role="alert" aria-live="polite" aria-relevant="all"></tbody>
											</table>
										</div>
									</div>
									<!-- 数据表格结束 -->
									<!-- 数据条数提示开始 -->
									<div class="row">
										<div class="col-sm-12">
											<div class="pull-left">
												<div id="datatable_info2" class="dataTables_info">当前显示0 条总记录中的第0-0条</div></div>
											<div class="clearfix"></div>
										</div>
									</div>
									<!-- 数据条数提示结束 -->
									<!-- 分页条开始 -->
									<div class="row">
										<div class="col-sm-4">
											<div class="dataTables_length" id="">
												<label style="margin-top:18px;">每页
													<select id="pageSizeSelector2" size="1" onchange="go2page2(1)">
														<option selected="selected" value="10">10</option>
														<option value="25">25</option>
														<option value="50">50</option>
														<option value="100">100</option></select>条</label>
											</div>
										</div>
										<div class="col-sm-8">
											<div class="pull-right">
												<div class="dataTables_paginate paging_bs_normal">
													<ul id="paginationArea2" class="pagination"></ul>
												</div>
											</div>
										</div>
									</div>
									<!-- 分页条结束 -->
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 主页面结束 -->                
	<div class="md-overlay"></div>
	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
    <script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
    <script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>   
    <script type="text/javascript" src="js/masonry.js"></script>
    <script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>
<script type="text/javascript">
//根据排序规则重新查询
function queryBySort(par,column){
	var classFlag = listSortClickEvent(par);
	var type = judgmentChinese(column);
	if(type != null && type != ""){
		classFlag = type + classFlag;
		column = column.substr(8,column.length);
	}
	$("#sortType").val(classFlag);
	$("#sortColumn").val(column);
	go2page1(currentshownpage1);
}


    var currentshownpage1 = 1; //历史服务页签当前页面
    var currentshownpage2 = 1; //关联老人页签当前页面
    var path="wechatDetail.do";          
    $(document).ready(function(){
        App.init();
        $(".md-trigger").modalEffects(); //初始化js及模态框
        queryInfo(); //查询微信相关基本信息
        go2page1(1); //查询历史服务
      	go2page2(1); //查询关联老人
      	var homeUrl = "<%=request.getContextPath()%>" + "/welcome.do?main";
    	$(".navbar-brand").attr("href",homeUrl);
    });

    function queryInfo(){ //查询微信相关基本信息
    	var roleId =<%=(String)roleId%>;
    	var id = parseInt(roleId);
    	var reqmsg="{'action':'QUERY_WECHAT_INFO_REQUEST','content':{";    	
    	if (id != null && id != "") {
    		reqmsg += "\"id\":" + id + ",";
    	}	
    	reqmsg += "}}";
        jQuery.ajax({
              type : "post",
              async:true,
              url : path+"?handler",
              dataType : "json",
              data: {
                   "reqmsg":reqmsg
              },
              success : function(data){
                  if(data.des=="success"){
                	  if(data.content.photoUrl !="" && data.content.photoUrl !=null){
                	 	 $("#photoUrl").attr("src",data.content.photoUrl + "?random=" + Math.random());
                	  }
                	  $("#openid").text(data.content.openid);
                	  $("#nickname").text(data.content.nickname);
                	  if(data.content.gender ==null || data.content.gender ==""){
                		 data.content.gender = "性别未知"
                	  }
                	  if(data.content.country ==null || data.content.country ==""){
                		 data.content.country = "国家"
                	  }
                	  if(data.content.province ==null || data.content.province ==""){
                		 data.content.province = "省"
                	  }
                	 if(data.content.city ==null || data.content.city ==""){
                		  data.content.city = "市"
                	 }
                	  $("#gender").text(data.content.gender+"/"+data.content.country+"-"+data.content.province+"-"+data.content.city);
                  }else if(data.des=="failure"){
                     alert("查询失败");
                  }
              },
              error:function(){
    	           alert("error");
              }
         });
    }
    
	function go2page1(pagenumber){ //查询历史服务
		var pagesize = $("#pageSizeSelector1 option:selected").val();
		var fwxminput_Id = $("#fwxminput_Id").val();//项目
		var fwxminput_search = $("#fwxminput_search").val();
		var fuwustate_input = $("#fuwustate_input").val();	//状态
		var fuwugdbh_input = $("#fuwugdbh_input").val();//工单编号
		var roleId =<%=(String)roleId%>;
    	var addPersonWechatId = parseInt(roleId);//添加人下单人的微信id	
		var reqmsg="{'action':'QUERY_SERVICE_TASK_LIST_REQUEST',";
		
		var sortType = $("#sortType").val();
		var sortColumn = $("#sortColumn").val();
		if(sortType != null && sortType != ""){
			reqmsg += "'order':[{'column':'" + sortColumn + "','type':'" + sortType + "'}],";
		}
	
		reqmsg += "'page':{'pageno':'" + pagenumber + "','pagesize':'" + pagesize + "'},'content':{\"serviceListShow\":\"true\",";
		reqmsg += "\"source\":\"微信\",";
		if (fwxminput_Id != null && fwxminput_Id != "") {
			reqmsg += "\"serviceId\":" + fwxminput_Id + ",";
		}		
		if (fuwustate_input != null && fuwustate_input != "") {
			reqmsg += "\"status_in\":\"" + fuwustate_input + "\",";
		}
		if (fuwugdbh_input != null && fuwugdbh_input != "") {
			reqmsg += "\"serviceCode\":\"" + fuwugdbh_input + "\",";
		}
		reqmsg += "\"addPersonWechatId\":" + addPersonWechatId + ",";			
		reqmsg += "}}";
	    jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "serviceTask.do?handler",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	             	 changeData1(data);
	              }else if(data.des=="failure"){-
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           alert("error");
	          }
	     });
	}
	
	function changeData1(data){
		var htmlcode = "";
		if (data.content != null) {
			var fwxm = "";
			var fzrName = "";
			jQuery.each(data.content.serviceTaskList, function(i, item) {
				htmlcode += "<tr>";		
			    htmlcode += "<td>" + item.serviceCode + "</td>";			    
			    fwxm = "";
			    jQuery.each(item.serviceList, function(j, item2) {
			    	fwxm += item2.name + ",";
			    });
			    if(fwxm != ""){
			    	fwxm = fwxm.substr(0,fwxm.length-1);
			    }
			    htmlcode += "<td>" + fwxm + "</td>";
			    htmlcode += "<td>" + item.olderName + "</td>";
			    htmlcode += "<td>" + item.price + "</td>";
			    htmlcode += "<td>" + fwstateChange(item.status) + "</td>";				
			    htmlcode += "<td>" + formateTime(item.serviceExpectTime) + "</td>";
			    htmlcode += "<td>" + formateTime(item.serviceEndTime) + "</td>";			   
				htmlcode += "<td><div class=\"btn-group\">";
				htmlcode += "<button class=\"btn btn-default btn-xs\" type=\"button\">操作</button>";
				htmlcode += "<button data-toggle=\"dropdown\" class=\"btn btn-xs btn-primary dropdown-toggle\" type=\"button\">";
				htmlcode += "<span class=\"caret\" style=\"padding:0;\"></span>";
				htmlcode += "<span class=\"sr-only\">Toggle Dropdown</span>";
				htmlcode += "</button>";
				htmlcode += "<ul role=\"menu\" class=\"dropdown-menu pull-right\">";
				var headUrl = "<%=request.getContextPath()%>";
				<c:if test="${serviceTask_queryXQ_opt_control != 'yes' or serviceTask_queryXQ_opt_show == 'yes'}">
					htmlcode += "<li><a href=\""+headUrl+"/serviceTask.do?mainXQ&id="+item.id+"\" target=\"_blank\">查看详情</a></li>";
				</c:if>		
				htmlcode += "</ul>";
				htmlcode += "</div></td>";		
				htmlcode += "</tr>";
			});
		}		
		$("#datacontainer1").html(htmlcode);
		if (data.page != null) {
			genaratePaginateHtml1(data.page.pageno,data.page.pageCount);
			genarateRecordNumberHtml1(data.page.pageno, data.page.pagesize, data.page.recordCount);
		} else {
			genaratePaginateHtml1(1, 1);
			genarateRecordNumberHtml1(1, 10, 0);
		}
	}

	//服务状态
	function fwstateChange(id){
		var name="未知";
     	switch (id)
		{
			case 1:
  			name="已取消";
  			break;
  			
  			case 4:
  			name="审核通过";
  			break;
  			
  			case 5:
  			name="服务开始";
  			break;
  			
  			case 6:
  			name="服务结束";
  			break;
  			
  			case 7:
  			name="回访结束";
  			break;
  			
  			case 8:
  			name="已下单";
  			break;
  			
  			default:
  			break;
		}
		return name;
	}
		
	/**
	 * 生成记录数信息
	 * @method genarateRecordNumberHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} pagesize 每页记录条目数
	 * @param {Number} totalRecord 总记录数
	 */
	function genarateRecordNumberHtml1(currentpage, pagesize, totalRecord) {
		var recordInfos = "";
		if (totalRecord > 0) {
		    recordInfos = "当前显示" + totalRecord + "条总记录";
			recordInfos += "中第" + ((currentpage - 1) * pagesize + 1) + "-";
			if (currentpage * pagesize > totalRecord) {
				recordInfos += totalRecord;
			} else {
				recordInfos += currentpage * pagesize;
			}
			recordInfos += "条 ";
		} else {
			recordInfos = "当前显示0 条总记录中的第0-0条";
		}
		
		$("#datatable_info1").html(recordInfos);
	}

	/**
	 * 生成分页信息
	 * @method genaratePaginateHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} totalpage 总页数
	 */
	function genaratePaginateHtml1(currentpage, totalpage, pagesize) {
		currentshownpage1 = currentpage;
		var htmlcode = "";		
		//上一页
		if (currentpage > 1) {
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page1('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page1('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		} else {
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		}		
		//具体页码
		if (totalpage <= 5) {
			for (var i = 1; i <= totalpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page1('" + i + "')\">" + i + "</a></li>";
				}
			}
		} else {
			var startpage = currentpage;
			var endpage = currentpage;
			while (true) {
				if (endpage - startpage >= 4) {
					break;
				} else {
					if (startpage > 1) {
						startpage = startpage - 1;
					}
					if (endpage < totalpage) {
						endpage = endpage - (-1);
					}
				}
			}			
			for (var i = startpage; i <= endpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page1('" + i + "')\">" + i + "</a></li>";
				}
			}
		}		
		//下一页
		if (totalpage > currentpage) {
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page1('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page1('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		} else {
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		}
		$("#paginationArea1").html(htmlcode);
	}
	 
	/**
	 * 生成记录数信息
	 * @method genarateRecordNumberHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} pagesize 每页记录条目数
	 * @param {Number} totalRecord 总记录数
	 */
	function genarateRecordNumberHtml2(currentpage, pagesize, totalRecord) {
		var recordInfos = "";
		if (totalRecord > 0) {
		    recordInfos = "当前显示" + totalRecord + "条总记录";
			recordInfos += "中第" + ((currentpage - 1) * pagesize + 1) + "-";
			if (currentpage * pagesize > totalRecord) {
				recordInfos += totalRecord;
			} else {
				recordInfos += currentpage * pagesize;
			}
			recordInfos += "条 ";
		} else {
			recordInfos = "当前显示0 条总记录中的第0-0条";
		}
		
		$("#datatable_info2").html(recordInfos);
	}

	/**
	 * 生成分页信息
	 * @method genaratePaginateHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} totalpage 总页数
	 */
	function genaratePaginateHtml2(currentpage, totalpage, pagesize) {
		currentshownpage2 = currentpage;
		var htmlcode = "";		
		//上一页
		if (currentpage > 1) {
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page2('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page2('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		} else {
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		}		
		//具体页码
		if (totalpage <= 5) {
			for (var i = 1; i <= totalpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page2('" + i + "')\">" + i + "</a></li>";
				}
			}
		} else {
			var startpage = currentpage;
			var endpage = currentpage;
			while (true) {
				if (endpage - startpage >= 4) {
					break;
				} else {
					if (startpage > 1) {
						startpage = startpage - 1;
					}
					if (endpage < totalpage) {
						endpage = endpage - (-1);
					}
				}
			}
			
			for (var i = startpage; i <= endpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page2('" + i + "')\">" + i + "</a></li>";
				}
			}
		}		
		//下一页
		if (totalpage > currentpage) {
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page2('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page2('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		} else {
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		}
		$("#paginationArea2").html(htmlcode);
	}
	 
    function go2page2(pagenumber){    	
    	var pagesize = $("#pageSizeSelector2 option:selected").val();
    	var roleId =<%=(String)roleId%>;
    	var wechatId = parseInt(roleId);//微信id	
    	var older_num = $("#condition4").val();
    	var older_name = $("#older_name").val();
    	var reqmsg="{'action':'QUERY_OLDER_WECHAT_LIST_REQUEST','page':{'pageno':'" + pagenumber + "','pagesize':'" + pagesize + "'},'content':{\"olderShow\":\"true\",";
    	
    	if (wechatId != null && wechatId != "") {
    		reqmsg += "\"wechatId\":" + wechatId + ",";
    	}
    	if (older_num != null && older_num != "") {
    		reqmsg += "\"older_num\":\"" + older_num + "\",";
    	}
    	if (older_name != null && older_name != "") {
    		reqmsg += "\"older_name\":\"" + older_name + "\",";
    	}
    	reqmsg += "}}";
        jQuery.ajax({
              type : "post",
              async:true,
              url : "olderWechat.do?handler",
              dataType : "json",
              data: {
                   "reqmsg":reqmsg
              },
              success : function(data){
                  if(data.des=="success"){
                	changeData2(data);
                  }else if(data.des=="failure"){
                     alert("查询失败");
                  }
              },
              error:function(){
    	           alert("error");
              }
         });
    }
    
	function changeData2(data){
		var htmlcode = "";
		if (data.content != null) {			
			jQuery.each(data.content.olderWechatList, function(i, item) {
				htmlcode += "<tr>";		   
		    	htmlcode += "<td>" + item.older.memberNum + "</td>";
		    	htmlcode += "<td>" + item.older.memberCard + "</td>";
		    	htmlcode += "<td>" + item.older.name + "</td>";
		    	htmlcode += "<td>" + item.older.gender + "</td>";
		    	htmlcode += "<td>" + getAge(item.older.birthdate) + "</td>";
		    	htmlcode += "<td>" + item.older.memberSource + "</td>";
		    	htmlcode += "<td>" + item.siteName + "</td>";
		    	htmlcode += "<td>" + item.older.homeTel +" / "+ item.older.mobileTel + "</td>";			   
				htmlcode += "<td><div class=\"btn-group\">";
				htmlcode += "<button class=\"btn btn-default btn-xs\" type=\"button\">操作</button>";
				htmlcode += "<button data-toggle=\"dropdown\" class=\"btn btn-xs btn-primary dropdown-toggle\" type=\"button\">";
				htmlcode += "<span class=\"caret\" style=\"padding:0;\"></span>";
				htmlcode += "<span class=\"sr-only\">Toggle Dropdown</span>";
				htmlcode += "</button>";
				htmlcode += "<ul role=\"menu\" class=\"dropdown-menu pull-right\">";
				var headUrl = "<%=request.getContextPath()%>";
				<c:if test="${serviceTask_queryXQ_opt_control != 'yes' or serviceTask_queryXQ_opt_show == 'yes'}">
					htmlcode += "<li><a href=\""+headUrl+"/daeOlder.do?main&id="+item.older.id+"\" target=\"_blank\">查看详情</a></li>";
				</c:if>		
				htmlcode += "</ul>";
				htmlcode += "</div></td>";		
				htmlcode += "</tr>";
			});
		}
		$("#datacontainer2").html(htmlcode);
		if (data.page != null) {
			genaratePaginateHtml2(data.page.pageno,data.page.pageCount);
			genarateRecordNumberHtml2(data.page.pageno, data.page.pagesize, data.page.recordCount);
		} else {
			genaratePaginateHtml2(1, 1);
			genarateRecordNumberHtml2(1, 10, 0);
		}
	}

    
  //实时获取会员号
    function getolderName(){
    	var reqmsg="{'action':'QUERY_OLDER_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
    	var memberNum_like = $.trim($("#condition4").val());
    	if (memberNum_like != null && memberNum_like != "") {
    		reqmsg += "\"memberNum_like\":\"" + memberNum_like + "\"";
    	}else{
    		$("#hideul_nei1").html("");
    		$("#hideul-1").hide();
    		return;
    	}
    	reqmsg += "}}";
        jQuery.ajax({
              type : "post",
              async:false,
              url : "older.do?handler",
              dataType : "json",
              data: {
                   "reqmsg":reqmsg
              },
              success : function(data){
                  if(data.des=="success"){
                  	  var htmlcode = "";
                  	  if(data.content != null){
                  	  	 if(data.content.olderList != null){
                	  		jQuery.each(data.content.olderList, function(i, item) {
              	  				if(item != null){
  		    						htmlcode += "<li onclick=\"olderNamefuzhi('" + item.memberNum + "')\">" + item.memberNum+ "</li>";		
              	  				}	
    		    	  		});
    		    	 	 }
    		    	  }
    		    	  $("#hideul_nei1").html(htmlcode);
    		    	  $("#hideul-1").show();
                  }else if(data.des=="failure"){
                     alert("查询失败");
                  }
              },
              error:function(){
    	           alert("error");
              }
         });
    }
  
    //会员号赋值
    function olderNamefuzhi(Num){
    	$("#condition4").val(Num);
    	//$("#condition5").val(id);
    	$("#hideul_nei1").html("");
    	$("#hideul-1").hide();
    }
    
    //实时获取服务项目
    function getFWXM(){
    	var reqmsg="{'action':'QUERY_SERVICE_LIST_REQUEST','page':{'pageno':'1','pagesize':'5'},'content':{";
    	//reqmsg += "\"status\":1,";
    	var name = $("#fwxminput_search").val();
    	if (name != null && name != "") {
    		reqmsg += "\"name_like\":\"" + name + "\"";
    	}else{
    		$("#hideul_nei2").html("");
    		$("#hideul-2").hide();
    		return;
    	}
    	reqmsg += "}}";
        jQuery.ajax({
              type : "post",
              async:false,
              url : "service.do?handler",
              dataType : "json",
              data: {
                   "reqmsg":reqmsg
              },
              success : function(data){
                  if(data.des=="success"){
                  	  var htmlcode = "";
                  	  if(data.content != null){
                  	  	 if(data.content.serviceList != null){
                	  		jQuery.each(data.content.serviceList, function(i, item) {
              	  				if(item != null){
  		    						htmlcode += "<li onclick=\"fwxmNamefuzhi('" + item.name + "','" + item.id + "')\">" + item.name + "</li>";		
              	  				}	
    		    	  		});
    		    	 	 }
    		    	  }
    		    	  $("#hideul_nei2").html(htmlcode);
    		    	  $("#hideul-2").show();
                  }else if(data.des=="failure"){
                     alert("查询失败");
                  }
              },
              error:function(){
    	           alert("error");
              }
         });
    }
    
    //服务项目名称赋值
    function fwxmNamefuzhi(name,id){
    	$("#fwxminput_Id").val(id);
    	$("#fwxminput_search").val(name);
    	$("#hideul_nei2").html("");
    	$("#hideul-2").hide();
    }
    
    function changeDataInfo(data){
    	var htmlcode = "";
    	if (data.content != null) {
    		jQuery.each(data.content.wechatList, function(i, item) {
    			htmlcode += "<tr>";
    		    htmlcode += "<td>" + item.openid + "</td>";			
    		    htmlcode += "<td>" + item.nickname + "</td>";	
    		    htmlcode += "<td>" + item.gender + "</td>";	
    		    htmlcode += "<td>" + item.country + "</td>";	
    		    htmlcode += "<td>" + item.province + "</td>";	
    		    htmlcode += "<td>" + item.city + "</td>";	
    		    htmlcode += "<td>" + formateTime(item.createTime) + "</td>";    			
    		    htmlcode += "<td><div class=\"btn-group\">";
    			htmlcode += "<button class=\"btn btn-default btn-xs\" type=\"button\">操作</button>";
    			htmlcode += "<button data-toggle=\"dropdown\" class=\"btn btn-xs btn-primary dropdown-toggle\" type=\"button\">";
    			htmlcode += "<span class=\"caret\" style=\"padding:0;\"></span>";
    			htmlcode += "<span class=\"sr-only\">Toggle Dropdown</span>";
    			htmlcode += "</button>";
    			htmlcode += "<ul role=\"menu\" class=\"dropdown-menu pull-right\">";
    			var headUrl = "<%=request.getContextPath()%>";			
    			htmlcode += "<li><a href=\""+headUrl+"/wechatDetail.do?main&roleIds="+item.id+"\" target=\"_blank\">查看详情</a></li>";			
    			htmlcode += "</ul>";
    			htmlcode += "</div></td>";					
    			htmlcode += "</tr>";
    		});
    	}
    	$("#datacontainer").html(htmlcode);
    	if (data.page != null) {
    		genaratePaginateHtml(data.page.pageno, data.page.pageCount);
    		genarateRecordNumberHtml(data.page.pageno, data.page.pagesize, data.page.recordCount);
    	} else {
    		genaratePaginateHtml(1, 1);
    		genarateRecordNumberHtml(1, 10, 0);
    	}
    }
    
    /**
     * 格式化时间
     * @method formateTime
     * @param {String} time 时间信息(YYYYMMDDHHmmSS)
     * @return 格式化的时间(YYYY-MM-DD HH:mm:SS)
     */
    function formateTime(time) {
    	if (time != null && time.length == 14) {
    		return time.substring(0, 4) + "-" + time.substring(4, 6) + "-" + time.substring(6, 8) + " " + time.substring(8, 10) + ":" + time.substring(10, 12) + ":" + time.substring(12, 14);
    	} else {
    		return time;
    	}
    }     
   
     function getAge(strBirthday){ //根据出生年月日计算年龄yyyymmdd
     	if(strBirthday == null || strBirthday == ""){
     		return "";
     	}
     	var birthYear = strBirthday.substr(0,4);
     	var d = new Date();
     	var nowYear = d.getFullYear();
     	if(parseFloat(birthYear) >= nowYear){
     		return "";
     	}
     	var age = nowYear-birthYear;
     	return age;
     }

</script>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/behaviour/voice-commands.js"></script>
<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.form.js"></script>
</body>
</html>
