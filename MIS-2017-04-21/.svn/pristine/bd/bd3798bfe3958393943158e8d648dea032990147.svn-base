<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="images/logo.png">
<title>设备信息</title>
<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="js/jquery.gritter/css/jquery.gritter.css" />
<link rel="stylesheet" href="fonts/font-awesome-4/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="js/jquery.nanoscroller/nanoscroller.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.switch/bootstrap-switch.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.select2/select2.css" />
<link rel="stylesheet" type="text/css" href="js/bootstrap.slider/css/slider.css" />
<link rel="stylesheet" type="text/css" href="js/jquery.niftymodals/css/component.css" />
<link href="js/jquery.icheck/skins/square/blue.css" rel="stylesheet">
<link rel="stylesheet" href="js/jquery.crop/css/jquery.Jcrop.css" type="text/css" />
<link href="css/style.css" rel="stylesheet" />
<style>
.hideul {
	position: absolute;
	top: 33px;
	z-index: 200;
	right: 15px;
	left: 15px;
	display: none
}

.hideul ul {
	border: 1px solid #ccc;
	width: 100%;
	background: #f4f4f4;
	padding-left: 0
}

.hideul ul li {
	list-style-type: none;
	text-indent: 20px
}

.hideul ul li:hover {
	background: #ddd
}

.dropdown-toggle {
	height: 24px
}

#deltip1,#deltip2 {
	color: #2083d6
}
</style>
<script type="text/javascript" src="js/addressJS.js"></script>
</head>
<body>
	<div id="cl-wrapper" style="padding-top:0;background:#fff;">
		<input type="hidden" value="0" id="olderId_hide">
		<div class="cl-mcont" style="background:#fff;">
			<div class="row">
				<div class="col-sm-2" style=" vertical-align: middle; height: 34px; line-height: 34px;">
					<label>设备编号</label>
				</div>
				<div class="col-sm-4 " style="margin-bottom:10px;">
					<input class="form-control" type="text" style="width: 100%" id="condition1">
				</div>
				<div class="col-sm-2" style=" vertical-align: middle; height: 34px; line-height: 34px;">
					<label>设备名称</label>
				</div>
				<div class="col-sm-4 " style="margin-bottom:10px;">
					<input class="form-control" type="text" style="width: 100%" id="condition2">
				</div>
				<div class="col-sm-2  col-md-2" style="vertical-align: middle; height: 34px; line-height: 34px;">
					<label>设备类型</label>
				</div>
				<div class="col-sm-4 col-md-4">
					<select id="condition3" class="form-control">
						<option value=""></option>
						<option value="2">安护宝</option>
						<option value="1">老人定位器</option>
					</select>
				</div>
				<!-- 查询框结束 -->
				<!-- 操作按钮开始 -->
				<div class="col-sm-12" style="margin-top:20px">
					<button class="btn btn-primary" style="margin-bottom: 0px !important; height: 34px;margin-left:0;" onclick="go2page(1)">查询</button>
					<div class="btn-group" style="margin-top:5px;float:right;margin-right:0">
						<button type="button" class="btn btn-primary ">
							<span>
								<a href="<%=request.getContextPath()%>/dev.do?mainAdd" id="xinzengshebei" target="_blank" style="color:#fff">
									<i class="fa fa-plus" style="margin-right:5px;"></i>新增设备
								</a>
							</span>
						</button>
						<button type="button" class="btn btn-danger " style="margin-left:5px;margin-right:0" onclick="del()">
							<span>
								<i class="fa fa-minus" style="margin-right:5px;"></i>批量删除
							</span>
						</button>
						<input type="hidden" class="btn btn-danger md-trigger" data-modal="sure2del" id="issure2del">
						<input type="hidden" class="btn btn-danger md-trigger" data-modal="sure2bang" id="issure2bang">
					</div>
				</div>
				<!-- 操作按钮结束 -->
				<!-- 数据表格开始 -->
				<div class="col-sm-12">
					<table>
						<thead>
							<tr role="row">
								<th style="width:2%;">
									<input id="allselectchecker" type="checkbox" class="col_selector" onclick="selectAll();">
								</th>
								<th>
									<strong>设备编号</strong>
								</th>
								<th>
									<strong>设备名称</strong>
								</th>
								<th>
									<strong>设备类型</strong>
								</th>
								<th>
									<strong>绑定老人</strong>
								</th>
								<th>
									<strong>操作</strong>
								</th>
							</tr>
						</thead>
						<tbody id="datacontainer">
						</tbody>
					</table>
				</div>
			</div>
			<!-- 数据表格结束 --
			<!-- 数据条数提示开始 -->
			<div class="row">
				<div class="col-sm-12">
					<div class="pull-left">
						<div id="datatable_info" class="dataTables_info">当前显示0 条总记录中的第0-0条</div>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
			<!-- 数据条数提示结束 -->
			<!-- 分页条开始 -->
			<div class="row">
				<div class="col-sm-4">
					<div class="dataTables_length" id="">
						<label style="margin-top:18px;">
							每页
							<select id="pageSizeSelector" size="1" onchange="go2page(1)">
								<option selected="selected" value="10">10</option>
								<option value="25">25</option>
								<option value="50">50</option>
								<option value="100">100</option>
							</select>
							条
						</label>
					</div>
				</div>
				<div class="col-sm-8">
					<div class="pull-right">
						<div class="dataTables_paginate paging_bs_normal">
							<ul id="paginationArea" class="pagination">
								<li class="prev disabled">
									<a href="#">
										<span class="fa fa-angle-left"></span>
										&nbsp;上一页
									</a>
								</li>
								<li class="active">
									<a href="#">1</a>
								</li>
								<li class="next">
									<a href="#">
										下一页&nbsp;
										<span class="fa fa-angle-right"></span>
									</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<!-- 分页条结束 -->
		</div>
		<div id="getHeight"></div>
	</div>
	<!-- 主页面结束 -->

	<!-- 模态框开始-->
	<!-- 删除确认-->
	<div class="md-modal colored-header custom-width md-effect-9" id="sure2del">
		<div class="md-content">
			<div class="modal-header">
				<h3>删除确认</h3>
				<button type="button" class="close md-close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body form ">
				<label class="control-label">
					是否确认删除设备号为：
					<span id="deltip1"></span>
					的
					<span id="deltip2"></span>
					个设备？
				</label>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary btn-flat" id="Sure2Delete">确定</button>
				<button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal" id="cancel2Delete">取消</button>
			</div>
		</div>
	</div>
	<!-- 解绑确认-->
	<div class="md-modal colored-header custom-width md-effect-9" id="sure2bang">
		<div class="md-content">
			<div class="modal-header">
				<h3>解绑确认</h3>
				<button type="button" class="close md-close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body form ">
				<label class="control-label">是否确认解除该设备与老人的绑定关系？</label>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary btn-flat" id="Sure2bang">确定</button>
				<button type="button" class="btn btn-default btn-flat md-close" data-dismiss="modal" id="cancel2bang">取消</button>
			</div>
		</div>
	</div>

	<div class="md-overlay"></div>

	<script type="text/javascript" src="js/mordo.tools/mordo.timeProcessing.js"></script>
	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript" src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/jquery.gritter/js/jquery.gritter.js"></script>
	<script type="text/javascript" src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>
	<script type="text/javascript" src="js/masonry.js"></script>
	<script type="text/javascript" src="js/jquery.crop/js/jquery.Jcrop.js"></script>
	<script src="js/jquery.upload/js/jquery.iframe-transport.js"></script>
	<script src="js/jquery.upload/js/jquery.fileupload.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script type="text/javascript" src="js/jquery.icheck/icheck.min.js"></script>

	<script type="text/javascript">
		//iframe内嵌页面设置高度
    	function reset() {
  			window.parent.reset();
		}
	
		$(document).ready(function(){	
			var olderId="<%=request.getAttribute("olderId")%>";
			if(olderId != null && olderId != ""){
				$("#olderId_hide").val(olderId);
				$("#xinzengshebei").attr("href","<%=request.getContextPath()%>" + "/dev.do?mainAdd&olderId=" + olderId);
			}
			
			//getLoginName();
	        //getcyrName();
	    	App.init();
	    	$(".md-trigger").modalEffects();
	    	go2page(1);
		});

	    var currentshownpage = 1;
		function go2page(pagenumber){
			var pagesize = $("#pageSizeSelector option:selected").val();
			var condition1 = $("#condition1").val(); //设备号
			var condition2 = $("#condition2").val(); //设备名
			var condition3 = $("#condition3").val();//设备类型
			var olderId_hide = $("#olderId_hide").val(); //绑定老人id
	
			var reqmsg="{'action':'QUERY_DEV_LIST_REQUEST','page':{'pageno':'" + pagenumber + "','pagesize':'" + pagesize + "'},'content':{";
			if (condition1 != null && condition1 != "") { //设备号精确搜索
				reqmsg += "\"code\":\"" + condition1 + "\",";
			}
			if (condition2 != null && condition2 != "") { //设备名称模糊查询
				reqmsg += "\"name_like\":\"" + condition2 + "\",";
			}
			if (condition3 != null && condition3 != "") {
				reqmsg += "\"type\":" + condition3 + ",";
			}
			
			reqmsg += "\"olderId\":" + olderId_hide + ",";
			
			reqmsg += "}}";
	
		    jQuery.ajax({
		          type : "post",
		          async:true,
		          url : "dev.do?handler",
		          dataType : "json",
		          data: {
		               "reqmsg":reqmsg
		          },
		          success : function(data){
		              if(data.des=="success"){
		            	  changeData(data);
		              }else if(data.des=="failure"){
		                 alert("查询失败");
		              }
		          },
		          error:function(){
			           alert("error");
		          }
		     });
		}

		function changeData(data){
			var htmlcode = "";
			if (data.content != null) {
				jQuery.each(data.content.devList, function(i, item) {
					htmlcode += "<tr><td><input type=\"checkbox\" class=\"col_selector\" value=\"" + item.id + "\"></td>";	
					htmlcode += "<td>" + item.code + "</td>";		
				    htmlcode += "<td>" + item.name + "</td>";	
				    if(item.type == "1"){
				    	htmlcode += "<td>" + "老人定位器" + "</td>";	
				    }else if(item.type == "2"){
				    	htmlcode += "<td>" + "安护宝" + "</td>";	
				    }else{
				    	htmlcode += "<td>" + "未知设备类型" + "</td>";	
				    }
				    if(item.olderId != null && item.olderId != ""){
				   		 htmlcode += "<td>" + getOlder(item.olderId) + "</td>";	
				    }else{
				    	 htmlcode += "<td>" + "未绑定" + "</td>";	
				    }
				    htmlcode += "<td><div class=\"btn-group\">";
				    htmlcode += "<button class=\"btn btn-default btn-xs\" type=\"button\">操作</button>";
				    htmlcode += "<button data-toggle=\"dropdown\" class=\"btn btn-xs btn-primary dropdown-toggle\" type=\"button\">";
				    htmlcode += "<span class=\"caret\"></span><span class=\"sr-only\">Toggle Dropdown</span>";
				    htmlcode += "</button>";
				    htmlcode += "<ul role=\"menu\" class=\"dropdown-menu pull-right\">";				
					htmlcode += "<li><a href=\"<%=request.getContextPath()%>/dev.do?mainDetails&devId=" + item.id + "\"  target=\"_blank\">查看详情</a></li>";
					if(item.olderId != null && item.olderId != ""){
						htmlcode += "<li   onclick=\"removeBinding('" + item.id + "','" + item.olderId + "')\"><a>解除绑定</a></li>";
				    }				
					htmlcode += "<li   onclick=\"del('" + item.id + "','" + item.code + "')\"><a>删除设备</a></li>";
					htmlcode += "</ul></div></td></tr>";
				});
			}
			$("#datacontainer").html(htmlcode);
			if (data.page != null) {
				genaratePaginateHtml(data.page.pageno, data.page.pageCount);
				genarateRecordNumberHtml(data.page.pageno, data.page.pagesize, data.page.recordCount);
			} else {
				genaratePaginateHtml(1, 1);
				genarateRecordNumberHtml(1, 10, 0);
			}
			reset();
		}
	    function selectAll() {
			if ($("#allselectchecker").is(':checked')) {
				$(".col_selector").prop("checked", true);
			} else {
				$(".col_selector").prop("checked", false);
			}
		}

	   //根据老人id获取老人姓名+老人编号
	   function getOlder(id){
		    var t = "未绑定";
			var reqmsg="{'action':'QUERY_OLDER_INFO_REQUEST','content':{\"olderContactListShow\":\"true\",\"olderAddressListShow\":\"true\",\"id\":"+id+"}}";
			jQuery.ajax({
	          type : "post",
	          async:false,
	          url : "daeOlder.do?handler",
	          dataType : "json",
	          data: {
	              "reqmsg":reqmsg
	          },         
	          success : function(data){
	             if(data.des=="success"){
	             	if(data.content != null){
	           	  		t = data.content.name + "(" + data.content.memberNum + ")";    
	             	}       	  	
	             }else if(data.des=="failure"){
	            	 t = "获取绑定老人失败";
	             }
	          },
	          error:function(){
		           t ="获取绑定老人失败";
	          }
	   	 	});
			return t;
		}
	   //解除绑定，删除       olderId，更新状态+时间
	   function removeBinding(id,oldId){
		   var time = getCurrentTime(); //16位字符串
		   $("#issure2bang").click();
		   //console.log(time);
			var reqmsg="{'action':'ADD_DEV_INFO_REQUEST','content':{\"id\":"+id+",\"olderId\":0,\"status\":\"设备解绑\",\"addTime\":\""+time+"\"}}";
			document.getElementById("Sure2bang").onclick = function() {
				jQuery.ajax({
			        type : "post",
			        async:false,
			        url : "dev.do?handler",
			        dataType : "json",
			        data: {
			            "reqmsg":reqmsg
			       },         
			       success : function(data){
			           if(data.des=="success"){
			        	   alert("解绑成功");  
			        	   go2page(currentshownpage);
						  $("#cancel2bang").click();
			           }else if(data.des=="failure"){
			        	   alert("解绑失败");
			           }
			       },
			       error:function(){
			    	   alert("error");
			       }
		 	 });
			}
	   }
   
		//删除设备
		function del(id,code) {		
			var ids2del = "";
			var len2del = 0;
			var dev2del = "";
			if (id) {
				ids2del = id;
				len2del = 1;
				dev2del = code;
			} else {
				var selectedItemNumber = $("#datacontainer tr td .col_selector:checked").length;
				len2del = selectedItemNumber;
				if (selectedItemNumber >= 1) {
					$("#datacontainer tr td .col_selector:checked").each(function() {
						ids2del += $(this).val() + ",";
						dev2del += $(this).parent().next().text() + ", ";
						
					});
					if (ids2del != "") {
						ids2del = ids2del.substring(0, ids2del.length - 1);
						dev2del = dev2del.substring(0, dev2del.length - 2);
					}
				} else {
					alert("请选择要删除的数据");
					return;
				}
			}		
			$("#issure2del").click();
			$("#deltip1").text(dev2del);
			$("#deltip2").text(len2del);
		
			//var reqmsg ="{'action':'DEL_DEV_INFO_REQUEST','content':{\"id\":"+ids2del+"}}";	
			document.getElementById("Sure2Delete").onclick = function() {   
				jQuery.ajax({
					type : "post",
					async : true,
					url : "dev.do?del",
					dataType : "json",
					data:{"ids":ids2del},
					success:function(data) {
						if (data.result == "success") {
							go2page(currentshownpage);
							$("#cancel2Delete").click();
							alert(data.des);
						} else {
							alert(data.des);
						}
					},
					error:function() {
						alert("error");
					}
				});
			}
		}

	/**
	 * 生成记录数信息
	 * @method genarateRecordNumberHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} pagesize 每页记录条目数
	 * @param {Number} totalRecord 总记录数
	 */
	function genarateRecordNumberHtml(currentpage, pagesize, totalRecord) {
		var recordInfos = "";
		if (totalRecord > 0) {
		    recordInfos = "当前显示" + totalRecord + "条总记录";
			recordInfos += "中第" + ((currentpage - 1) * pagesize + 1) + "-";
			if (currentpage * pagesize > totalRecord) {
				recordInfos += totalRecord;
			} else {
				recordInfos += currentpage * pagesize;
			}
			recordInfos += "条 ";
		} else {
			recordInfos = "当前显示0 条总记录中的第0-0条";
		}
		
		$("#datatable_info").html(recordInfos);
	}
	
	/**
	 * 生成分页信息
	 * @method genaratePaginateHtml
	 * @param {Number} currentpage 当前页
	 * @param {Number} totalpage 总页数
	 */
	function genaratePaginateHtml(currentpage, totalpage, pagesize) {
		currentshownpage = currentpage;
		var htmlcode = "";	
		//上一页
		if (currentpage > 1) {
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('1')\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre\"><a href=\"#\" onclick=\"go2page('" + (currentpage - 1) + "')\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		} else {
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;首页</a></li>";
			htmlcode += "<li class=\"pre disabled\"><a href=\"#\"><span class=\"fa fa-angle-left\"></span>&nbsp;上一页</a></li>";
		}
		
		//具体页码
		if (totalpage <= 5) {
			for (var i = 1; i <= totalpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		} else {
			var startpage = currentpage;
			var endpage = currentpage;
			while (true) {
				if (endpage - startpage >= 4) {
					break;
				} else {
					if (startpage > 1) {
						startpage = startpage - 1;
					}
					if (endpage < totalpage) {
						endpage = endpage - (-1);
					}
				}
			}
			
			for (var i = startpage; i <= endpage; i++) {
				if (currentpage == i) {
					htmlcode += "<li class=\"active\"><a href=\"#\">" + i + "</a></li>";
				} else {
					htmlcode += "<li><a href=\"#\" onclick=\"go2page('" + i + "')\">" + i + "</a></li>";
				}
			}
		}
		
		//下一页
		if (totalpage > currentpage) {
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + (parseInt(currentpage) + 1) + "')\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next\"><a href=\"#\" onclick=\"go2page('" + parseInt(totalpage) + "')\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		} else {
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">下一页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
			htmlcode += "<li class=\"next disabled\"><a href=\"#\">末页&nbsp;<span class=\"fa fa-angle-right\"></span></a></li>";
		}
		$("#paginationArea").html(htmlcode);
	}
	</script>

	<script src="js/behaviour/voice-commands.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.labels.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
</body>
</html>
