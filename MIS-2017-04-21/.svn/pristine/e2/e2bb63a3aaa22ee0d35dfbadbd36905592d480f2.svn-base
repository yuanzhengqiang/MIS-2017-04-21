<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ page import="fsk.init.SystemInit"%>
<%
	String nickname = (String) session.getAttribute("nickname");
	if (nickname == null) {
		nickname = "";
	}
	String header = SystemInit.header;
	String headerImage = SystemInit.headerImage;

	//呼叫中心参数
	String IsLocal = SystemInit.IsLocal;
	String vServerIp = SystemInit.ServerIp;
	String vlPort = SystemInit.lPort;
	Integer employeeId = (Integer) session.getAttribute("employeeId");
	if (employeeId == null) {
		employeeId = 0;
	}
	String ExtCode = (String) session.getAttribute("ExtCode");
	if (ExtCode == null) {
		ExtCode = "";
	}
	Integer login_Level = (Integer) session.getAttribute("login_Level");
	if (login_Level == null) {
		login_Level = 10;
	}
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="images/logo.png">

<title><%=header%></title>

<!-- Bootstrap core CSS -->
<link href="js/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
<link rel="stylesheet"
	href="fonts/font-awesome-4/css/font-awesome.min.css">

<link rel="stylesheet" type="text/css"
	href="js/jquery.gritter/css/jquery.gritter.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.nanoscroller/nanoscroller.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.easypiechart/jquery.easy-pie-chart.css" />
<link rel="stylesheet" type="text/css"
	href="js/bootstrap.switch/bootstrap-switch.css" />
<link rel="stylesheet" type="text/css"
	href="js/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.select2/select2.css" />
<link rel="stylesheet" type="text/css"
	href="js/bootstrap.slider/css/slider.css" />
<link rel="stylesheet" type="text/css" href="js/intro.js/introjs.css" />
<link rel="stylesheet" type="text/css"
	href="js/jquery.niftymodals/css/component.css" />

<!-- Custom styles for this template -->
<link href="css/style.css" rel="stylesheet" />
<style>
.gongzuotai:hover {
	background: #36a3ff
}
</style>
</head>

<body onload="Connect()" onunload="Logout()"
	onbeforeunload="if(ClosesWindow == true){Logout();}"
	onmouseover="ClosesWindow=false;" onmouseout="ClosesWindow=true;">
	<!-- 上侧栏开始 -->
	<div id="head-nav" class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="fa fa-gear"></span>
				</button>
				<a class="navbar-brand" href="###"
					style="width:auto;background: url(images/<%=headerImage%>) no-repeat 0 10px"><span><%=header%></span>
				</a>

			</div>

			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li class="gongzuotai" style="font-size:14px;margin-left:50px;"
						onclick="tzworktai()"><a href="###"><i class=""></i>工作台</a></li>
				</ul>
				<ul class="nav navbar-nav">
					<li class="btn-tel"><a onclick="ShowFree()"><i
							id="btnShowFree" class="tel-icon tel-icon-sx"></i> <input
							id="lbAgentState" name="lbAgentState"
							readonly="false" value="空闲"
							style="border-style: none;
                        border-color: inherit; border-width: 1px;background-color: transparent;
                       font-size: 11px; width: 30px; color: #FFFFFF; margin-top: 0px;" />
					</a>
					</li>
					<!-- <li class="btn-tel" title="来电显示"> 
						<div class="search-panel radios">来电显示<input type="text" id="lbTelPhone" class="radios"/><i class="searcher"   onclick="FindTelephone()"></i></div>
					</li> -->
				</ul>
				<ul class="nav navbar-nav navbar-right user-nav">
					<li class="dropdown profile_menu"><a href="#"
						class="dropdown-toggle" data-toggle="dropdown"> <img
							src="images/avatar2.jpg" /> <span id="accountNickname"><%=nickname%></span>
							<b class="caret"></b> </a>
						<ul class="dropdown-menu">
							<li><a href="#" class="md-trigger" data-modal="md-scale3">密码修改</a>
							</li>
							<li class="divider"></li>
							<li><a href="systemLogin.do?logout">退出登录</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<!-- /.nav-collapse animate-collapse -->
		</div>
	</div>
	<!-- 上侧栏结束 -->

	<div id="cl-wrapper" class="fixed-menu">
		<div class="cl-sidebar">
			<!-- 左侧栏开始  -->
			<div class="cl-toggle">
				<i class="fa fa-bars"></i>
			</div>
			<div class="cl-navblock">
				<div class="menu-space">
					<div class="content">
						<div class="side-user">
							<div class="avatar">
								<img src="images/avatar1_50.jpg" alt="Avatar" />
							</div>
							<div class="info">
								<a href="#"><%=nickname%></a> <img src="images/state_online.png"
									alt="Status" /> <span>正常</span>
							</div>
						</div>
						<ul class="cl-vnavigation">
							<!-- 动态加载菜单栏  -->
							<c:forEach var="module" items="${modules}">
								<c:if test="${module.type == 1}">
									<li><a href="${module.url}"> <i
											class="fa ${module.icon}"></i><span>${module.name}</span> </a>
										<ul class="sub-menu">
											<c:forEach var="two_module" items="${module.childModuleList}">
												<c:if test="${two_module.name == '大屏展示'}">
													<li><a
														href='${two_module.url}&moduleId=${two_module.id}'
														target="_blank"> <i class="fa ${two_module.icon}"></i>${two_module.name}</a>
													</li>
												</c:if>
												<c:if test="${two_module.name != '大屏展示'}">
													<li><a href="#"
														onclick="changeCenter('${two_module.url}&moduleId=${two_module.id}')">
															<i class="fa ${two_module.icon}"></i>${two_module.name}</a></li>
												</c:if>
											</c:forEach>
										</ul>
								</c:if>
							</c:forEach>
						</ul>
					</div>
				</div>
				<div class="text-right collapse-button" style="padding:7px 9px;">
					<input type="text" class="form-control search"
						placeholder="Search..." />
					<button id="sidebar-collapse" class="btn btn-default">
						<i style="color:#fff;" class="fa fa-angle-left"></i>
					</button>
				</div>
			</div>
		</div>
		<!-- 左侧栏结束  -->

		<!-- 中间栏开始 -->
		<iframe id="welcomeCenter" scrolling="auto" frameborder="0"
			src="<%=request.getContextPath()%>/workbench.do?main"
			style="width: 100%; height: 99.5%;"> </iframe>
		<!-- 中间栏结束 -->
	</div>

	<!-- 密码重置模态框 -->
	<div class="md-modal md-effect-1" id="md-scale3">
		<div class="row">
			<div class="col-md-12">
				<div class="block-flat">
					<div class="header">
						<h3>用户密码重置</h3>
					</div>

					<div class="content form-horizontal group-border-dashed">
						<div class="form-group">
							<label class="col-sm-4 control-label" style="text-align:left">原密码<span
								style="color:red">*</span> </label>
							<div class="col-sm-8">
								<input type="password" class="form-control" value=""
									id="loginPWD">
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4 control-label"
								style="text-align:left;margin-bottom:5px;">新密码<span
								style="color:red">*</span> </label>
							<div class="col-sm-8">
								<input type="password" class="form-control" value=""
									style="margin-bottom:5px;" id="newPWD_1">
							</div>
							<label class="col-sm-4 control-label" style="text-align:left;">新密码再次输入<span
								style="color:red">*</span> </label>
							<div class="col-sm-8">
								<input type="password" class="form-control" value=""
									id="newPWD_2">
							</div>
						</div>
						<p style="text-align:center;color:red;display:block;"
							id="changePwdTips">&nbsp;</p>
						<div class="form-group" style="text-align: center;">
							<button type="button" class="btn btn-success btn-rad"
								id="changeUserPwd">
								<span><i class="fa fa-check" style="margin-right:5px;"></i>确定重置</span>
							</button>
							<button id="cancel_button" type="button"
								class="btn btn-primary btn-rad md-close"
								style="margin-left: 50px;" onclick="cancelmima();">
								<span><i class="fa fa-times" style="margin-right:5px;"></i>取消</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 密码重置模态框结束 -->

	<div class="md-overlay"></div>
	<!-- Nifty Modal模态框的遮罩层-->
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript"
		src="js/jquery.gritter/js/jquery.gritter.js"></script>
	<script type="text/javascript"
		src="js/jquery.nanoscroller/jquery.nanoscroller.js"></script>
	<script type="text/javascript" src="js/behaviour/general.js"></script>
	<script src="js/jquery.ui/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript"
		src="js/jquery.sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript"
		src="js/jquery.easypiechart/jquery.easy-pie-chart.js"></script>
	<script type="text/javascript"
		src="js/jquery.nestable/jquery.nestable.js"></script>
	<script type="text/javascript"
		src="js/bootstrap.switch/bootstrap-switch.min.js"></script>
	<script type="text/javascript"
		src="js/bootstrap.datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="js/jquery.select2/select2.min.js" type="text/javascript"></script>
	<script src="js/skycons/skycons.js" type="text/javascript"></script>
	<script src="js/bootstrap.slider/js/bootstrap-slider.js"
		type="text/javascript"></script>
	<script src="js/intro.js/intro.js" type="text/javascript"></script>
	<script type="text/javascript"
		src="js/jquery.niftymodals/js/jquery.modalEffects.js"></script>
	<script type="text/javascript" src="js/jquery.md5.js"></script>

	<script type="text/javascript">
	function tzworktai(){
    	var url = "<%=request.getContextPath()%>" + "/workbench.do?main";
    	$("#welcomeCenter").attr("src",url);
    }
    
	$(document).ready(function() {
		setInterval("getAlarm()",10000);
		var homeUrl = "<%=request.getContextPath()%>" + "/welcome.do?main";
		$(".navbar-brand").attr("href",homeUrl);
		//initialize the javascript
		App.init();
		App.dashBoard(); 
		$(".md-trigger").modalEffects();  //初始化模态框          
		resizeframe();  //调整iframe的大小为容器大小
		$("body").bind("resize", resizeframe);  //尺寸变化时，调整iframe大小
		$("#changeUserPwd").bind("click", function() {
			var loginPWD = $("#loginPWD")[0].value; //原密码
			var newPWD_1 = $("#newPWD_1")[0].value; //新密码
			var newPWD_2 = $("#newPWD_2")[0].value; //第二次输入的新密码
			
			if (loginPWD.length == 0 || newPWD_1.length == 0  || newPWD_2.length == 0 ) {
				document.getElementById('changePwdTips').innerHTML = '三个框都是必填！';
			} else if (newPWD_1 != newPWD_2) {
				document.getElementById('changePwdTips').innerHTML = '两次新密码输入不一致！';
			} else {
				document.getElementById('changePwdTips').innerHTML = '&nbsp;';
				loginPWD = $.md5(loginPWD);
				newPWD_1 = $.md5(newPWD_1);
				changePwd(loginPWD,newPWD_1);
			}
		});
		$("li.myliactivestyle").bind("click",function(){  //点击菜单栏,对当前li添加class="active"
			$("li.myliactivestyle").removeClass("active");
			$(this).addClass("active");
		});
	});
	
	function changeCenter(url) {
		document.getElementById("welcomeCenter").src="<%=request.getContextPath()%>/" + url;
	}
	
	/** 调整iframe的大小为容器大小 */
	function resizeframe() {
		$("#welcomeCenter").css("height", ($("body").height() - 55) + "px");
	}
	
	function changePwd(loginPWD, newPWD_1) {
		$.ajax({
			type : "post",
			async : true,
			url : "modifyUserInfo.do?modifyUserPwd",
			dataType : "json",
			data: {
				"loginUserPwd":loginPWD,
				"newUserPwd":newPWD_1
			},
			success : function(data) {
				if (data.result == "success") {
					alert(data.des);
					$("#loginPWD")[0].value = "";
					$("#newPWD_1")[0].value = "";
					$("#newPWD_2")[0].value = "";
					$("#md-scale3").removeClass("md-show");
				} else if(data.result == "failure") {
					alert(data.des);  //原密码错误，继续修改
				}
			},
			error : function() {
				alert("修改密码失败！");
			}
		});
	}
	
	function cancelmima(){
	 $("#loginPWD").val("");
	 $("#newPWD_1").val("");
	 $("#newPWD_2").val("");
	}
	
	function getAlarm(){
		var reqmsg="{'action':'QUERY_DEV_MAP_INFO_REQUEST'}";
		
		var alarmNums = 0;
	    jQuery.ajax({
	          type : "post",
	          async:true,
	          url : "show.do?devMap",
	          dataType : "json",
	          data: {
	               "reqmsg":reqmsg
	          },
	          success : function(data){
	              if(data.des=="success"){
	            	 if (data.content.devlist != null) {
						jQuery.each(data.content.devlist, function(i, item) {
							if(item.type == "1"){ //定位
								if(item.alarm == "Y"){
									if(item.alarmStatus == "0"){
										alarmNums ++;
									}
								}
							}else if(item.type == "2"){ //安护宝
								if(item.alarm == "Y"){
									if(item.alarmStatus == "0"){
										alarmNums ++;
									}
								}
							}
						});
						if(alarmNums != 0){
							if(confirm("有" + alarmNums + "条报警信息，点击确认后查看")){
								var path="<%=request.getContextPath()%>";
              					var url=path+"/devAlarm.do?main";
              					$("#welcomeCenter").attr("src",url);
							}
						}
					}
	              }else if(data.des=="failure"){
	                 alert("查询失败");
	              }
	          },
	          error:function(){
		           console.log("报警弹窗定时请求数据error");
	          }
	     });
	}	
	</script>
	
	<input id="AgentState" type="hidden" name="AgentState" value="示忙" />
	<!-- <script type="text/javascript" src="js/KXTCall_ocx.js"></script> -->
	<OBJECT name=KXTCall  ID="ut_atocx" CLASSID="clsid:5E27E804-3C01-46a0-B8EA-1C3FEFEC327E"> <PARAM NAME="FillColor" VALUE="0">
    </OBJECT>
    <SCRIPT type="text/javascript" FOR="ut_atocx" EVENT="OnRinging(ctiId, RingType, callerNo, calleeNo, CallID, InComeTime, ProjectID, CallTypeID, SubCallTypeID, QueueID)" >
	    FChangeAngent(0);
	    document.getElementById('AgentState').value = "示闲";
	    document.getElementById('lbAgentState').value = "忙碌";
	    //window.open('Web/Order/RingOlder_Info_List.aspx?zjTel='+calleeNo+'&Tel='+callerNo+'&CallID='+CallID+'', 'showframe');
	    //显示
	    document.getElementById("lbTelPhone").value=callerNo;
	</SCRIPT> 
	<script type="text/javascript">
       	var IsLocal = "<%=IsLocal%>";//是否为本地坐席 1是  2否
		//服务器连接
		function Connect(){
       		if (IsLocal == "1"){
            	var SvrIP, lPort;
                var vda;
                lPort = "<%=vlPort%>";
                SvrIP = "<%=vServerIp%>";
                if (SvrIP != "" ){
	            	vda = ut_atocx.Connect(SvrIP, lPort,5000);
		            if (vda == 1){
                        alert("服务器连接失败，请输入有效的服务器IP与端口号！！！！");
		            }else{
		                //alert("服务器连接成功！！！！");
                        Login();
		            }
	            }else{
	                alert("请配置服务器IP及端口的有效信息");
	            }
          	}
        }
        //登陆系统
		function Login(){
			if (IsLocal == "1"){
		    	var szName,szWorkNum,szPassword,vda,szvExtCode,login_Level;
	            szName = "<%=nickname%>";
	            szWorkNum = "<%=employeeId%>";
	            szvExtCode = "<%=ExtCode%>";
	            login_Level = "<%=login_Level%>";
	            alert(szName + "||" +szWorkNum  + "||" +  szvExtCode+ "||" + login_Level);
	            if (szName != "" && szWorkNum != 0 && szvExtCode != ""){
			    	vda = ut_atocx.LoginRight(szName,szvExtCode,szWorkNum,login_Level);
				    if (vda == 1){
	                	alert("软电话功能开启失败，请输入有效的工号分机号，重新登陆！！！！");
				    }else{
					    //alert("登陆成功！！！！");
				    }
		        }else{
	            	alert("请输入登陆用户，坐席工号的有效信息");
		        }
	        }
        }
		//登出系统
        function Logout(){
          	if (IsLocal == "1"){
            	vda = ut_atocx.Logout();
			    if (vda == 1){
			    	alert("退出失败，请输入有效的信息！！！");
			    }else{
				    //alert("退出成功！！！！");
                    Disconnect();
			    }
        	}
        }
        //断开服务器连接
        function Disconnect(){
        	if (IsLocal == "1"){
	            var vda;
	            ut_atocx.Disconnect();
	 		    vda = ut_atocx.Disconnect();
				if (vda == 1){
	                alert("断开服务器连接失败！！");
				}else{
	                //alert("断开服务器连接成功！！！！");
				}
			}
        }
        //调用内呼
        function FChangeAngent(pStste){
        	if (IsLocal == "1"){
	        	if (pStste == "0"){
	            	ReValue = ut_atocx.ChangeAgentState(0);
	                document.getElementById('btnShowFree').className = "tel-icon tel-icon-sm";
	                document.getElementById('AgentState').value = "示闲";
	                document.getElementById('lbAgentState').value = "忙碌";
	            }else if (pStste == "1"){
	                ReValue = ut_atocx.ChangeAgentState(1);
	                document.getElementById('btnShowFree').className = "tel-icon tel-icon-sx";
	                document.getElementById('AgentState').value = "示忙";
	                document.getElementById('lbAgentState').value = "空闲";
	            }
            }
        }
        //坐席的状态改变
        function ShowFree(){  
        	if (IsLocal == "1"){
	        	var ReValue = 0;
	            var AgentState = document.getElementById('AgentState').value;
	            if (AgentState == "示忙"){
					ReValue = ut_atocx.ChangeAgentState(0);
	                document.getElementById('btnShowFree').className = "tel-icon tel-icon-sm";
	                document.getElementById('AgentState').value = "示闲";
	                document.getElementById('lbAgentState').value = "忙碌";
	            }else if (AgentState == "示闲"){
	                ReValue = ut_atocx.ChangeAgentState(1);
	                document.getElementById('btnShowFree').className = "tel-icon tel-icon-sx";
	                document.getElementById('AgentState').value = "示忙";
	                document.getElementById('lbAgentState').value = "空闲";
	            }
            }
        }
        
	</script> 

	<script src="js/behaviour/voice-commands.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.js"></script>
	<script type="text/javascript" src="js/jquery.flot/jquery.flot.pie.js"></script>
	<script type="text/javascript"
		src="js/jquery.flot/jquery.flot.resize.js"></script>
	<script type="text/javascript"
		src="js/jquery.flot/jquery.flot.labels.js"></script>
</body>
</html>
